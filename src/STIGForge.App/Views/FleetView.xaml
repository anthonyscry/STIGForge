<UserControl x:Class="STIGForge.App.Views.FleetView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <ScrollViewer VerticalScrollBarVisibility="Auto">
  <Grid Margin="10">
    <Grid.RowDefinitions>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <TabControl Grid.Row="0">

      <!-- Operations Tab -->
      <TabItem Header="Operations">
        <StackPanel Margin="12">
          <TextBlock Text="Fleet Operations (WinRM)" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8"/>
          <WrapPanel Margin="0,0,0,8">
            <TextBlock Text="Targets:" Width="80" VerticalAlignment="Center"/>
            <TextBox Width="620" Text="{Binding FleetTargets}"
                     AutomationProperties.Name="Fleet targets"
                     ToolTipService.ToolTip="Comma-separated: host1,host2:ip,host3. Or use inventory below."/>
          </WrapPanel>
          <WrapPanel Margin="0,0,0,8">
            <TextBlock Text="Operation:" Width="80" VerticalAlignment="Center"/>
            <ComboBox Width="140" ItemsSource="{Binding FleetOperations}" SelectedItem="{Binding FleetOperation}"
                      AutomationProperties.Name="Fleet operation"
                      ToolTipService.ToolTip="Select apply, verify, or orchestrate to run across all targets."/>
            <TextBlock Text="Concurrency:" Width="90" Margin="12,0,0,0" VerticalAlignment="Center"/>
            <TextBox Width="60" Text="{Binding FleetConcurrency}"
                     AutomationProperties.Name="Fleet concurrency"
                     ToolTipService.ToolTip="Maximum number of machines to run in parallel."/>
            <TextBlock Text="Timeout:" Width="70" Margin="12,0,0,0" VerticalAlignment="Center"/>
            <TextBox Width="60" Text="{Binding FleetTimeout}"
                     AutomationProperties.Name="Fleet timeout seconds"
                     ToolTipService.ToolTip="Timeout in seconds per machine."/>
          </WrapPanel>

          <!-- Remote Settings -->
          <Separator Margin="0,4,0,8"/>
          <TextBlock Text="Remote Compliance Settings" FontWeight="SemiBold" Margin="0,0,0,6"/>
          <WrapPanel Margin="0,0,0,6">
            <TextBlock Text="Profile:" Width="80" VerticalAlignment="Center"/>
            <ComboBox Width="280" ItemsSource="{Binding Profiles}" SelectedItem="{Binding SelectedProfile}" DisplayMemberPath="Name"
                      AutomationProperties.Name="Fleet profile"
                      ToolTipService.ToolTip="Profile to use for remote compliance operations."/>
            <TextBlock Text="Pack:" Width="60" Margin="12,0,0,0" VerticalAlignment="Center"/>
            <ComboBox Width="280" ItemsSource="{Binding ContentPacks}" SelectedItem="{Binding SelectedPack}" DisplayMemberPath="Name"
                      AutomationProperties.Name="Fleet content pack"
                      ToolTipService.ToolTip="Content pack to use for remote compliance operations."/>
          </WrapPanel>
          <WrapPanel Margin="0,0,0,6">
            <TextBlock Text="Bundle:" Width="80" VerticalAlignment="Center"/>
            <TextBox Width="520" Text="{Binding BundleRoot}" AutomationProperties.Name="Fleet bundle root"/>
            <Button Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                    Command="{Binding BrowseBundleCommand}" AutomationProperties.Name="Browse for bundle"/>
          </WrapPanel>
          <WrapPanel Margin="0,0,0,6">
            <TextBlock Text="Eval-STIG:" Width="80" VerticalAlignment="Center"/>
            <TextBox Width="520" Text="{Binding EvaluateStigRoot}" AutomationProperties.Name="Fleet Evaluate-STIG root"/>
            <Button Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                    Command="{Binding BrowseEvaluateStigCommand}" AutomationProperties.Name="Browse for Evaluate-STIG"/>
          </WrapPanel>

          <Separator Margin="0,8,0,8"/>
          <WrapPanel>
            <Button Content="Execute" MinWidth="120" Height="34" Padding="14,0" FontWeight="SemiBold" Margin="0,0,10,0"
                    Command="{Binding FleetExecuteCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Execute fleet operation"
                    ToolTipService.ToolTip="Run the selected operation across all target machines via WinRM."/>
            <Button Content="Check Status" MinWidth="130" Height="34" Padding="14,0" Margin="0,0,10,0"
                    Command="{Binding FleetCheckStatusCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Check fleet status"
                    ToolTipService.ToolTip="Test WinRM connectivity to all target machines."/>
            <Button Content="Collect Artifacts" MinWidth="140" Height="34" Padding="14,0" Margin="0,0,10,0"
                    Command="{Binding FleetCollectCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Collect fleet artifacts"
                    ToolTipService.ToolTip="Pull artifacts from remote hosts, generate per-host CKL, and create fleet summary."/>
            <Button Content="Fleet Summary" MinWidth="130" Height="34" Padding="14,0" Margin="0,0,10,0"
                    Command="{Binding FleetSummaryGenerateCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Generate fleet summary"
                    ToolTipService.ToolTip="Generate unified fleet summary from previously collected results."/>
            <TextBlock Text="{Binding FleetStatus}" Margin="0,10,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
          </WrapPanel>

          <!-- Fleet Compliance Table -->
          <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Margin="0,12,0,0"
                  Background="{DynamicResource SurfaceMutedBrush}"
                  Visibility="{Binding FleetSummaryVisible, Converter={StaticResource BoolToVisibility}}">
            <StackPanel>
              <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                <TextBlock Text="Fleet Compliance:" FontSize="14" FontWeight="SemiBold" Margin="0,0,8,0"/>
                <TextBlock Text="{Binding FleetWideCompliance, StringFormat='{}{0:F1}%'}" FontSize="14" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
              </StackPanel>
              <DataGrid ItemsSource="{Binding FleetComplianceStats}" AutoGenerateColumns="False"
                        IsReadOnly="True" MaxHeight="260" CanUserSortColumns="True"
                        HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                        Background="{DynamicResource SurfaceBrush}">
                <DataGrid.Columns>
                  <DataGridTextColumn Header="Host" Binding="{Binding HostName}" Width="200"/>
                  <DataGridTextColumn Header="Total" Binding="{Binding TotalControls}" Width="70"/>
                  <DataGridTextColumn Header="Pass" Binding="{Binding PassCount}" Width="70"/>
                  <DataGridTextColumn Header="Fail" Binding="{Binding FailCount}" Width="70"/>
                  <DataGridTextColumn Header="NA" Binding="{Binding NaCount}" Width="70"/>
                  <DataGridTextColumn Header="NR" Binding="{Binding NrCount}" Width="70"/>
                  <DataGridTextColumn Header="Compliance" Binding="{Binding CompliancePercentage, StringFormat='{}{0:F1}%'}" Width="100"/>
                </DataGrid.Columns>
              </DataGrid>
            </StackPanel>
          </Border>
        </StackPanel>
      </TabItem>

      <!-- Inventory Tab -->
      <TabItem Header="Inventory">
        <StackPanel Margin="12">
          <TextBlock Text="Fleet Inventory" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,4"/>
          <TextBlock Text="Saved targets persist across sessions. Use comma-separated hostnames above or manage the inventory below."
                     Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,8" TextWrapping="Wrap"/>
           <ListView ItemsSource="{Binding FleetInventoryItems}" SelectedItem="{Binding SelectedFleetInventoryItem}" MaxHeight="200" MinHeight="80"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     ScrollViewer.CanContentScroll="True">
             <ListView.View>
               <GridView>
                 <GridViewColumn Header="Hostname" DisplayMemberBinding="{Binding HostName}" Width="200"/>
                 <GridViewColumn Header="IP" DisplayMemberBinding="{Binding IpAddress}" Width="140"/>
                 <GridViewColumn Header="WinRM" DisplayMemberBinding="{Binding WinRmStatus}" Width="80"/>
                 <GridViewColumn Header="Last Check" DisplayMemberBinding="{Binding LastCheckLabel}" Width="120"/>
               </GridView>
             </ListView.View>
           </ListView>
          <WrapPanel Margin="0,8,0,0">
            <Button Content="Add Host" MinWidth="100" Height="30" Padding="14,0" Margin="0,0,10,4"
                    Command="{Binding AddFleetHostCommand}"
                    AutomationProperties.Name="Add fleet host"
                    ToolTipService.ToolTip="Parse the Targets field above and add hosts to the inventory."/>
            <Button Content="Remove Selected" MinWidth="130" Height="30" Padding="14,0" Margin="0,0,10,4"
                    Command="{Binding RemoveFleetHostCommand}"
                    AutomationProperties.Name="Remove selected fleet host"/>
            <Button Content="Ping All" MinWidth="90" Height="30" Padding="14,0" Margin="0,0,10,4"
                    Command="{Binding PingAllFleetCommand}"
                    AutomationProperties.Name="Ping all fleet hosts"
                    ToolTipService.ToolTip="Send ICMP ping to all hosts in the fleet inventory."/>
            <Button Content="Test WinRM All" MinWidth="130" Height="30" Padding="14,0" Margin="0,0,10,4"
                    Command="{Binding TestWinRmAllFleetCommand}"
                    AutomationProperties.Name="Test WinRM for all fleet hosts"
                    ToolTipService.ToolTip="Test WinRM connectivity to all hosts in the fleet inventory."/>
            <Button Content="Import CSV" MinWidth="110" Height="30" Padding="14,0" Margin="0,0,10,4"
                    Command="{Binding ImportFleetCsvCommand}"
                    AutomationProperties.Name="Import fleet hosts from CSV"
                    ToolTipService.ToolTip="Import fleet hosts from a CSV file with hostname and ip columns."/>
            <Button Content="Discover from AD" MinWidth="140" Height="30" Padding="14,0" Margin="0,0,0,4"
                    Command="{Binding DiscoverAdHostsCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Discover hosts from Active Directory"
                    ToolTipService.ToolTip="Query Active Directory for computer objects and add them to the fleet inventory."/>
          </WrapPanel>
        </StackPanel>
      </TabItem>

      <!-- Schedule Tab -->
      <TabItem Header="Schedule">
        <StackPanel Margin="12">
          <TextBlock Text="Scheduled Re-Verification" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8"/>
          <WrapPanel Margin="0,0,0,8">
            <TextBlock Text="Task Name:" Width="90" VerticalAlignment="Center"/>
            <TextBox Width="240" Text="{Binding SchedTaskName}" AutomationProperties.Name="Scheduled task name"/>
            <TextBlock Text="Frequency:" Width="80" Margin="12,0,0,0" VerticalAlignment="Center"/>
            <ComboBox Width="120" ItemsSource="{Binding ScheduleFrequencies}" SelectedItem="{Binding SchedFrequency}"
                      AutomationProperties.Name="Schedule frequency"/>
            <TextBlock Text="Time:" Width="50" Margin="12,0,0,0" VerticalAlignment="Center"/>
            <TextBox Width="80" Text="{Binding SchedTime}" AutomationProperties.Name="Schedule time"/>
          </WrapPanel>
          <WrapPanel Margin="0,0,0,8">
            <Button Content="Register Task" MinWidth="130" Height="30" Padding="14,0" Margin="0,0,10,4"
                    Command="{Binding ScheduleRegisterCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Register scheduled task"
                    ToolTipService.ToolTip="Create a Windows scheduled task for recurring re-verification."/>
            <Button Content="Remove Task" MinWidth="130" Height="30" Padding="14,0" Margin="0,0,10,4"
                    Command="{Binding ScheduleRemoveCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Remove scheduled task"/>
            <Button Content="Refresh" MinWidth="90" Height="30" Padding="14,0" Margin="0,0,0,4"
                    Command="{Binding ScheduleRefreshCommand}"
                    AutomationProperties.Name="Refresh schedule list"/>
          </WrapPanel>
          <TextBlock Text="{Binding SchedStatus}" Foreground="{DynamicResource TextMutedBrush}"/>
          <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Margin="0,6,0,0" Background="{DynamicResource SurfaceMutedBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="120">
              <TextBlock Text="{Binding SchedListOutput}" FontFamily="Consolas" FontSize="11" Padding="6" TextWrapping="Wrap"/>
            </ScrollViewer>
          </Border>
        </StackPanel>
      </TabItem>

    </TabControl>

    <!-- Fleet Log -->
    <TextBlock Grid.Row="1" Text="Fleet Log" FontSize="14" FontWeight="SemiBold" Margin="0,8,0,4"/>
    <Border Grid.Row="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Background="{DynamicResource SurfaceBrush}">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <TextBlock Text="{Binding FleetLog}" FontFamily="Consolas" FontSize="11" Padding="8" TextWrapping="Wrap"
                   AutomationProperties.Name="Fleet operation log"/>
      </ScrollViewer>
    </Border>
  </Grid>
  </ScrollViewer>
</UserControl>
