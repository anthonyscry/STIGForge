<Window x:Class="STIGForge.App.Views.RebaseWizard"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Overlay Rebase Wizard" Height="700" Width="1100" WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize"
        Background="{DynamicResource WindowBackgroundBrush}" Foreground="{DynamicResource TextPrimaryBrush}">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BoolToVis"/>
  </Window.Resources>
  
  <Grid Margin="16">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Header -->
    <DockPanel Grid.Row="0" Margin="0,0,0,16">
      <TextBlock Text="Overlay Rebase Wizard" FontSize="20" FontWeight="SemiBold" DockPanel.Dock="Left"/>
      <TextBlock Text="{Binding StepText}" FontSize="14" Foreground="{DynamicResource TextMutedBrush}" HorizontalAlignment="Right" DockPanel.Dock="Right"/>
    </DockPanel>

    <!-- Main Content -->
    <Grid Grid.Row="1">
      <!-- Welcome Screen -->
      <StackPanel Visibility="{Binding ShowWelcome, Converter={StaticResource BoolToVis}}">
        <TextBlock Text="Welcome to the Overlay Rebase Wizard" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,16"/>
        
        <TextBlock Text="This wizard helps you rebase overlays when STIG baselines change between DISA releases." 
                   TextWrapping="Wrap" Margin="0,0,0,16" Foreground="{DynamicResource TextMutedBrush}"/>
        
        <TextBlock Text="Select Overlay:" FontWeight="SemiBold" Margin="0,0,0,8"/>
        <ComboBox ItemsSource="{Binding AvailableOverlays}" DisplayMemberPath="Name" 
                  SelectedItem="{Binding SelectedOverlay}" Margin="0,0,0,16"
                  ToolTipService.ToolTip="Pick the overlay (set of exceptions or custom rules) you want to update to a newer STIG version."/>
        
        <TextBlock Text="Select Baseline Pack (current):" FontWeight="SemiBold" Margin="0,0,0,8"/>
        <ComboBox ItemsSource="{Binding AvailablePacks}" DisplayMemberPath="Name" 
                  SelectedItem="{Binding SelectedBaselinePack}" Margin="0,0,0,16"
                  ToolTipService.ToolTip="The STIG version your overlay was originally built for (the old version)."/>
        
        <TextBlock Text="Select Target Pack (new DISA release):" FontWeight="SemiBold" Margin="0,0,0,8"/>
        <ComboBox ItemsSource="{Binding AvailablePacks}" DisplayMemberPath="Name" 
                  SelectedItem="{Binding SelectedTargetPack}" Margin="0,0,0,16"
                  ToolTipService.ToolTip="The newer STIG version you want to update your overlay to match (the new version)."/>

        <Button Content="Analyze Rebase" Width="140" Height="32" Command="{Binding AnalyzeRebaseCommand}" Margin="0,16,0,0"
                ToolTipService.ToolTip="Compare old and new STIG versions and show what overlay rules need updating."/>
      </StackPanel>

      <!-- Analysis Screen -->
      <Grid Visibility="{Binding ShowAnalysis, Converter={StaticResource BoolToVis}}">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Summary -->
        <Border Grid.Row="0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Background="{DynamicResource SurfaceMutedBrush}" Margin="0,0,0,16">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
              </Grid.ColumnDefinitions>

              <StackPanel Grid.Column="0">
                <TextBlock Text="Total Overrides:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                <TextBlock Text="{Binding TotalOverrides}" FontSize="20" Foreground="{DynamicResource TextMutedBrush}"/>
              </StackPanel>

              <StackPanel Grid.Column="1">
                <TextBlock Text="Auto-Rebased:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                <TextBlock Text="{Binding AutoRebasedCount}" FontSize="20" Foreground="{DynamicResource SuccessBrush}"/>
              </StackPanel>

              <StackPanel Grid.Column="2">
                <TextBlock Text="Needs Review:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                <TextBlock Text="{Binding NeedsReviewCount}" FontSize="20" Foreground="{DynamicResource WarningBrush}"/>
              </StackPanel>

              <StackPanel Grid.Column="3">
                <TextBlock Text="Blocking Conflicts:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                <TextBlock Text="{Binding BlockingConflictCount}" FontSize="20" Foreground="{DynamicResource DangerBrush}"/>
              </StackPanel>
            </Grid>

            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,12,0,0">
              <TextBlock Text="Overall Confidence: " FontWeight="SemiBold"/>
              <TextBlock Text="{Binding OverallConfidenceDisplay}" Margin="0,0,16,0"/>
              <TextBlock Text="Safe Actions: " FontWeight="SemiBold"/>
              <TextBlock Text="{Binding SafeActionCount}" Margin="0,0,16,0"/>
              <TextBlock Text="High Risk: " FontWeight="SemiBold"/>
              <TextBlock Text="{Binding HighRiskCount}"/>
            </StackPanel>
          </Grid>
        </Border>

        <TextBlock Grid.Row="1" Text="{Binding AnalysisStatus}" Margin="0,0,0,12" Foreground="{DynamicResource TextMutedBrush}"/>

        <Border Grid.Row="2" BorderBrush="{DynamicResource DangerBrush}" BorderThickness="1" Background="{DynamicResource SurfaceMutedBrush}" Padding="10" Margin="0,0,0,12"
                Visibility="{Binding HasBlockingConflicts, Converter={StaticResource BoolToVis}}">
          <StackPanel>
            <TextBlock Text="Rebase apply is blocked until these conflicts are reviewed:" FontWeight="SemiBold" Foreground="{DynamicResource DangerBrush}" Margin="0,0,0,6"/>
            <TextBlock Text="{Binding BlockingConflictSummary}" TextWrapping="Wrap"/>
          </StackPanel>
        </Border>

        <Border Grid.Row="3" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Background="{DynamicResource SurfaceMutedBrush}" Padding="10" Margin="0,0,0,12">
          <StackPanel>
            <TextBlock Text="Recovery Guidance" FontWeight="SemiBold" Margin="0,0,0,6"/>
            <TextBlock Text="{Binding RecoveryGuidance}" TextWrapping="Wrap" Foreground="{DynamicResource TextMutedBrush}"/>
          </StackPanel>
        </Border>

        <!-- Action Tabs -->
        <TabControl Grid.Row="4">
          <TabItem>
            <TabItem.Header>
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="Auto-Rebased (" Foreground="{DynamicResource SuccessBrush}"/>
                <TextBlock Text="{Binding AutoRebasedCount}" Foreground="{DynamicResource SuccessBrush}"/>
                <TextBlock Text=")" Foreground="{DynamicResource SuccessBrush}"/>
              </StackPanel>
            </TabItem.Header>
            
            <DataGrid ItemsSource="{Binding AutoRebasedActions}" AutoGenerateColumns="False" IsReadOnly="True" Margin="8"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      ScrollViewer.CanContentScroll="True">
              <DataGrid.Columns>
                <DataGridTextColumn Header="Control ID" Binding="{Binding ControlId}" Width="120"/>
                <DataGridTextColumn Header="Action" Binding="{Binding Action}" Width="120"/>
                <DataGridTextColumn Header="Confidence" Binding="{Binding ConfidenceDisplay}" Width="100"/>
                <DataGridTextColumn Header="Reason" Binding="{Binding Reason}" Width="*"/>
              </DataGrid.Columns>
            </DataGrid>
          </TabItem>

          <TabItem>
            <TabItem.Header>
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="Needs Review (" Foreground="{DynamicResource WarningBrush}"/>
                <TextBlock Text="{Binding NeedsReviewCount}" Foreground="{DynamicResource WarningBrush}"/>
                <TextBlock Text=")" Foreground="{DynamicResource WarningBrush}"/>
              </StackPanel>
            </TabItem.Header>
            
            <Grid Margin="8">
              <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="200"/>
              </Grid.RowDefinitions>
              
              <DataGrid Grid.Row="0" ItemsSource="{Binding NeedsReviewActions}" SelectedItem="{Binding SelectedReviewAction}" 
                        AutoGenerateColumns="False" IsReadOnly="True"
                        VirtualizingPanel.IsVirtualizing="True"
                        VirtualizingPanel.VirtualizationMode="Recycling"
                        ScrollViewer.CanContentScroll="True">
                <DataGrid.Columns>
                  <DataGridTextColumn Header="Control ID" Binding="{Binding ControlId}" Width="120"/>
                  <DataGridTextColumn Header="Suggested Action" Binding="{Binding Action}" Width="140"/>
                  <DataGridTextColumn Header="Blocking" Binding="{Binding IsBlockingConflict}" Width="90"/>
                  <DataGridTextColumn Header="Confidence" Binding="{Binding ConfidenceDisplay}" Width="100"/>
                  <DataGridTextColumn Header="Reason" Binding="{Binding Reason}" Width="*"/>
                </DataGrid.Columns>
              </DataGrid>
              
              <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch" Background="{DynamicResource BorderBrush}"/>
              
              <Border Grid.Row="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="8" Margin="0,4,0,0" Background="{DynamicResource SurfaceBrush}"
                      Visibility="{Binding HasSelectedReviewAction, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                  <TextBlock Text="Review Details:" FontWeight="SemiBold" Margin="0,0,0,8"/>
                  
                  <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                    <TextBlock Text="Control ID: " FontWeight="SemiBold" Width="120"/>
                    <TextBlock Text="{Binding SelectedReviewAction.ControlId}"/>
                  </StackPanel>
                  
                  <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                    <TextBlock Text="Suggested Action: " FontWeight="SemiBold" Width="120"/>
                    <TextBlock Text="{Binding SelectedReviewAction.Action}"/>
                  </StackPanel>
                  
                  <TextBlock Text="Reason:" FontWeight="SemiBold" Margin="0,8,0,4"/>
                  <TextBlock Text="{Binding SelectedReviewAction.Reason}" TextWrapping="Wrap" Margin="0,0,0,8"/>

                  <TextBlock Text="Recommended action:" FontWeight="SemiBold" Margin="0,8,0,4"/>
                  <TextBlock Text="{Binding SelectedReviewAction.RecommendedAction}" TextWrapping="Wrap" Margin="0,0,0,8"/>
                   
                  <TextBlock Text="What control changed:" FontWeight="SemiBold" Margin="0,8,0,4"/>
                  <TextBlock Text="{Binding SelectedReviewAction.ChangesSummary}" TextWrapping="Wrap" Foreground="{DynamicResource TextMutedBrush}"/>
                </StackPanel>
              </Border>
            </Grid>
          </TabItem>
        </TabControl>
      </Grid>

      <!-- Completion Screen -->
      <StackPanel Visibility="{Binding ShowCompletion, Converter={StaticResource BoolToVis}}" VerticalAlignment="Center">
        <TextBlock Text="âœ“ Rebase Complete" FontSize="24" FontWeight="SemiBold" Foreground="{DynamicResource SuccessBrush}" 
                   HorizontalAlignment="Center" Margin="0,0,0,24"/>
        
        <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="16" Background="{DynamicResource SurfaceMutedBrush}">
          <StackPanel>
            <TextBlock Text="New Overlay Created:" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <TextBlock Text="{Binding NewOverlayId}" FontFamily="Consolas" Margin="0,0,0,16"/>
            
            <TextBlock Text="Summary:" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
              <TextBlock Text="Total overrides processed: " Foreground="{DynamicResource TextMutedBrush}"/>
              <TextBlock Text="{Binding TotalOverrides}"/>
            </StackPanel>
            
            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
              <TextBlock Text="Successfully rebased: " Foreground="{DynamicResource TextMutedBrush}"/>
              <TextBlock Text="{Binding AutoRebasedCount}" Foreground="{DynamicResource SuccessBrush}"/>
            </StackPanel>
            
            <StackPanel Orientation="Horizontal">
              <TextBlock Text="Required review: " Foreground="{DynamicResource TextMutedBrush}"/>
              <TextBlock Text="{Binding NeedsReviewCount}" Foreground="{DynamicResource WarningBrush}"/>
            </StackPanel>
          </StackPanel>
        </Border>

        <Button Content="Close" Width="120" Height="32" Command="{Binding CloseCommand}" Margin="0,24,0,0"/>
      </StackPanel>
    </Grid>

    <!-- Action Buttons -->
    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0"
                Visibility="{Binding ShowAnalysis, Converter={StaticResource BoolToVis}}">
      <Button Content="Cancel" Width="100" Height="32" Command="{Binding CancelCommand}" Margin="0,0,8,0"
              ToolTipService.ToolTip="Discard changes and close the wizard."/>
      <Button Content="Export Markdown" Width="130" Height="32" Command="{Binding ExportMarkdownReportCommand}" IsEnabled="{Binding CanExportReport}" Margin="0,0,8,0"
              ToolTipService.ToolTip="Save the rebase analysis as a readable Markdown report file."/>
      <Button Content="Export JSON" Width="110" Height="32" Command="{Binding ExportJsonReportCommand}" IsEnabled="{Binding CanExportReport}" Margin="0,0,8,0"
              ToolTipService.ToolTip="Save the rebase analysis as a machine-readable JSON file."/>
      <Button Content="Apply Rebase" Width="120" Height="32" Command="{Binding ApplyRebaseCommand}" IsEnabled="{Binding CanApplyRebase}"
              ToolTipService.ToolTip="Create a new overlay updated for the target STIG version. The original overlay is not modified."/>
    </StackPanel>
  </Grid>
</Window>
