<Window x:Class="STIGForge.App.Views.ManualCheckWizard"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Manual Check Wizard" Height="700" Width="1000" WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize"
        Background="{DynamicResource WindowBackgroundBrush}" Foreground="{DynamicResource TextPrimaryBrush}">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BoolToVis"/>
  </Window.Resources>

  <Window.InputBindings>
    <KeyBinding Key="Return" Modifiers="Ctrl" Command="{Binding SaveAndNextCommand}"/>
    <KeyBinding Key="Left" Modifiers="Ctrl" Command="{Binding PreviousControlCommand}"/>
    <KeyBinding Key="Right" Modifiers="Ctrl" Command="{Binding SkipControlCommand}"/>
  </Window.InputBindings>
  
  <Grid Margin="16">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Header -->
    <DockPanel Grid.Row="0" Margin="0,0,0,16">
      <TextBlock Text="Manual Control Review Wizard" FontSize="20" FontWeight="SemiBold" DockPanel.Dock="Left"/>
      <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" DockPanel.Dock="Right">
        <TextBlock Text="{Binding ProgressText}" FontSize="14" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,16,0"/>
        <TextBlock Text="{Binding CompletionText}" FontSize="14" Foreground="{DynamicResource SuccessBrush}" FontWeight="SemiBold"/>
      </StackPanel>
    </DockPanel>

    <!-- Progress Bar -->
    <ProgressBar Grid.Row="1" Height="4" Minimum="0" Maximum="100" Value="{Binding ProgressPercentage}"
                 Margin="0,0,0,8"
                 Foreground="{DynamicResource AccentBrush}" Background="{DynamicResource SurfaceMutedBrush}"/>

    <!-- Main Content -->
    <Grid Grid.Row="2">
      <!-- Welcome Screen -->
      <StackPanel Visibility="{Binding ShowWelcome, Converter={StaticResource BoolToVis}}">
        <TextBlock Text="Welcome to the Manual Check Wizard" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,16"/>
        
        <TextBlock Text="Bundle Information:" FontWeight="SemiBold" Margin="0,0,0,8"/>
        <TextBlock Text="{Binding BundleInfo}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,16" TextWrapping="Wrap"/>
        
        <TextBlock Text="Progress Summary:" FontWeight="SemiBold" Margin="0,0,0,8"/>
        <Grid Margin="0,0,0,16">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
          </Grid.ColumnDefinitions>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          
          <TextBlock Grid.Row="0" Grid.Column="0" Text="Total Controls:" Margin="0,2"/>
          <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TotalControls}" Foreground="{DynamicResource TextMutedBrush}" Margin="8,2"/>
          
          <TextBlock Grid.Row="1" Grid.Column="0" Text="Answered:" Margin="0,2"/>
          <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding AnsweredControls}" Foreground="{DynamicResource TextMutedBrush}" Margin="8,2"/>
          
          <TextBlock Grid.Row="2" Grid.Column="0" Text="Pass:" Margin="0,2"/>
          <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding PassCount}" Foreground="{DynamicResource SuccessBrush}" Margin="8,2"/>
          
          <TextBlock Grid.Row="3" Grid.Column="0" Text="Fail:" Margin="0,2"/>
          <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding FailCount}" Foreground="{DynamicResource DangerBrush}" Margin="8,2"/>
          
          <TextBlock Grid.Row="4" Grid.Column="0" Text="Not Applicable:" Margin="0,2"/>
          <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding NotApplicableCount}" Foreground="{DynamicResource TextMutedBrush}" Margin="8,2"/>
        </Grid>

        <StackPanel Orientation="Horizontal" Margin="0,16,0,0">
          <Button Content="Start Review" Width="140" Height="32" Command="{Binding StartWizardCommand}" 
                  Visibility="{Binding HasUnansweredControls, Converter={StaticResource BoolToVis}}" Margin="0,0,8,0"
                  ToolTipService.ToolTip="Begin walking through each unanswered control one at a time."/>
          <Button Content="Import Answers" Width="140" Height="32" Command="{Binding ImportAnswersCommand}" Margin="0,0,8,0"
                  ToolTipService.ToolTip="Import previously exported answers from a JSON file."/>
          <Button Content="Export Answers" Width="140" Height="32" Command="{Binding ExportAnswersCommand}"
                  ToolTipService.ToolTip="Export current answers to a JSON file for reuse in other bundles."/>
        </StackPanel>
        <TextBlock Text="All controls have been answered!" FontWeight="SemiBold" Foreground="{DynamicResource SuccessBrush}"
                   Visibility="{Binding AllControlsAnswered, Converter={StaticResource BoolToVis}}" Margin="0,16,0,0"/>
      </StackPanel>

      <!-- Review Screen -->
      <Grid Visibility="{Binding ShowReview, Converter={StaticResource BoolToVis}}">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Control Info -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
          <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
            <TextBlock Text="Control ID:" FontWeight="SemiBold" Width="100"/>
            <TextBlock Text="{Binding CurrentControlId}" FontSize="14"/>
            <Border Background="{Binding SeverityColor}" Padding="6,2" Margin="12,0,0,0" CornerRadius="2">
              <TextBlock Text="{Binding CurrentSeverity}" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="SemiBold"/>
            </Border>
          </StackPanel>
          
          <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
            <TextBlock Text="Title:" FontWeight="SemiBold" Width="100"/>
            <TextBlock Text="{Binding CurrentTitle}" TextWrapping="Wrap" FontSize="14"/>
          </StackPanel>

          <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
            <TextBlock Text="STIG Group:" FontWeight="SemiBold" Width="100"/>
            <TextBlock Text="{Binding CurrentStigGroup}" FontSize="14" Foreground="{DynamicResource AccentBrush}"/>
          </StackPanel>
        </StackPanel>

        <!-- Check Text -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,0,0,16">
          <StackPanel>
            <TextBlock Text="Check Instructions:" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Background="{DynamicResource SurfaceMutedBrush}">
              <TextBlock Text="{Binding CurrentCheckText}" TextWrapping="Wrap" FontFamily="Consolas" FontSize="12"/>
            </Border>

            <TextBlock Text="Fix Text:" FontWeight="SemiBold" Margin="0,16,0,8"/>
            <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Background="{DynamicResource SurfaceMutedBrush}">
              <TextBlock Text="{Binding CurrentFixText}" TextWrapping="Wrap" FontFamily="Consolas" FontSize="12"/>
            </Border>
          </StackPanel>
        </ScrollViewer>

        <!-- Answer Section -->
        <StackPanel Grid.Row="2">
          <TextBlock Text="Your Assessment:" FontWeight="SemiBold" Margin="0,0,0,8"/>
          
          <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
            <RadioButton Content="Pass (Not a Finding)" GroupName="Status" IsChecked="{Binding IsPass}" Margin="0,0,16,0"/>
            <RadioButton Content="Fail (Open Finding)" GroupName="Status" IsChecked="{Binding IsFail}" Margin="0,0,16,0"/>
            <RadioButton Content="Not Applicable" GroupName="Status" IsChecked="{Binding IsNotApplicable}" Margin="0,0,16,0"/>
            <RadioButton Content="Open (Needs Review)" GroupName="Status" IsChecked="{Binding IsNotReviewed}"/>
          </StackPanel>

          <TextBlock Text="Reason/Justification:" FontWeight="SemiBold" Margin="0,0,0,4"/>
          <TextBox Text="{Binding AnswerReason, UpdateSourceTrigger=PropertyChanged}" 
                   Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,8"/>

          <TextBlock Text="Additional Comments:" FontWeight="SemiBold" Margin="0,0,0,4"/>
          <TextBox Text="{Binding AnswerComment, UpdateSourceTrigger=PropertyChanged}" 
                   Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>

          <TextBlock Text="Notes:" FontWeight="SemiBold" Margin="0,8,0,4"/>
          <TextBox Text="{Binding ControlNotes, UpdateSourceTrigger=PropertyChanged}"
                   Height="40" TextWrapping="Wrap" AcceptsReturn="True"
                   AutomationProperties.Name="Control notes"/>

          <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
            <Button Content="Collect Evidence" Width="140" Command="{Binding CollectEvidenceCommand}"
                    ToolTipService.ToolTip="Auto-gather supporting evidence (logs, screenshots, config snapshots) for this control."/>
            <TextBlock Text="{Binding EvidenceStatus}" Margin="12,8,0,0" Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap" />
          </StackPanel>
        </StackPanel>
      </Grid>

      <!-- Completion Screen -->
      <StackPanel Visibility="{Binding ShowCompletion, Converter={StaticResource BoolToVis}}">
        <TextBlock Text="Review Complete!" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,16"/>
        
        <TextBlock Text="Final Summary:" FontWeight="SemiBold" Margin="0,0,0,8"/>
        <Grid Margin="0,0,0,16">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
          </Grid.ColumnDefinitions>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          
          <TextBlock Grid.Row="0" Grid.Column="0" Text="Total Controls:" Margin="0,2"/>
          <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TotalControls}" Foreground="{DynamicResource TextMutedBrush}" Margin="8,2"/>
          
          <TextBlock Grid.Row="1" Grid.Column="0" Text="Pass:" Margin="0,2"/>
          <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding PassCount}" Foreground="{DynamicResource SuccessBrush}" Margin="8,2"/>
          
          <TextBlock Grid.Row="2" Grid.Column="0" Text="Fail:" Margin="0,2"/>
          <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding FailCount}" Foreground="{DynamicResource DangerBrush}" Margin="8,2"/>
          
          <TextBlock Grid.Row="3" Grid.Column="0" Text="Not Applicable:" Margin="0,2"/>
          <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding NotApplicableCount}" Foreground="{DynamicResource TextMutedBrush}" Margin="8,2"/>
        </Grid>

        <TextBlock Text="Your answers have been saved to the bundle." Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,16"/>
        
        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
          <Button Content="Export Answers" Width="140" Height="32" Command="{Binding ExportAnswersCommand}" Margin="0,0,8,0"
                  ToolTipService.ToolTip="Export answers to a JSON file for reuse in other bundles."/>
          <Button Content="Return to Main App" Width="160" Height="32" Command="{Binding CloseWizardCommand}"
                  ToolTipService.ToolTip="Close the wizard and go back to the Manual tab. Your answers are already saved."/>
        </StackPanel>
        <TextBlock Text="{Binding EvidenceStatus}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,4,0,0" TextWrapping="Wrap"/>
      </StackPanel>
    </Grid>

    <!-- Navigation Buttons -->
    <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0"
                Visibility="{Binding ShowReview, Converter={StaticResource BoolToVis}}">
      <Button Content="Previous" Width="100" Command="{Binding PreviousControlCommand}" Margin="0,0,8,0"
              ToolTipService.ToolTip="Go back to the previous control you just reviewed. (Ctrl+Left)"/>
      <Button Content="Skip" Width="100" Command="{Binding SkipControlCommand}" Margin="0,0,8,0"
              ToolTipService.ToolTip="Skip this control for now and come back to it later. (Ctrl+Right)"/>
      <Button Content="Save &amp; Next" Width="120" Command="{Binding SaveAndNextCommand}" IsDefault="True"
              ToolTipService.ToolTip="Save your answer for this control and move to the next one. (Ctrl+Enter)"/>
    </StackPanel>
  </Grid>
</Window>
