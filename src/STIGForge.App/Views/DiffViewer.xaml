<Window x:Class="STIGForge.App.Views.DiffViewer"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="STIG Pack Comparison" Height="800" Width="1400" WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize"
        Background="{DynamicResource WindowBackgroundBrush}">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BoolToVis"/>
  </Window.Resources>
  
  <Grid Margin="16">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- Header -->
    <DockPanel Grid.Row="0" Margin="0,0,0,16">
      <TextBlock Text="STIG Pack Comparison" FontSize="20" FontWeight="SemiBold" DockPanel.Dock="Left"/>
      <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" DockPanel.Dock="Right"
                  Visibility="{Binding HasDiff, Converter={StaticResource BoolToVis}}">
        <Button Content="Export Markdown" Width="130" Margin="0,0,8,0" Command="{Binding ExportReportCommand}"/>
        <Button Content="Export JSON" Width="110" Command="{Binding ExportJsonReportCommand}"/>
      </StackPanel>
    </DockPanel>

    <!-- Pack Selection & Summary -->
    <Grid Grid.Row="1" Margin="0,0,0,16">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>
      
      <!-- Pack Selection -->
      <Grid Grid.Row="0" Margin="0,0,0,12">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="16"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <StackPanel Grid.Column="0">
          <TextBlock Text="Baseline Pack:" FontWeight="SemiBold" Margin="0,0,0,4"/>
          <TextBlock Text="{Binding BaselinePackName}" Foreground="{DynamicResource TextMutedBrush}" FontSize="12"/>
        </StackPanel>
        
        <TextBlock Grid.Column="1" Text="â†’" FontSize="24" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource TextMutedBrush}"/>
        
        <StackPanel Grid.Column="2">
          <TextBlock Text="Target Pack:" FontWeight="SemiBold" Margin="0,0,0,4"/>
          <TextBlock Text="{Binding TargetPackName}" Foreground="{DynamicResource TextMutedBrush}" FontSize="12"/>
        </StackPanel>
      </Grid>
      
      <!-- Summary Stats -->
      <Border Grid.Row="1" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Background="{DynamicResource SurfaceMutedBrush}"
              Visibility="{Binding HasDiff, Converter={StaticResource BoolToVis}}">
        <StackPanel Orientation="Horizontal">
          <StackPanel Orientation="Horizontal" Margin="0,0,24,0">
            <TextBlock Text="Added:" FontWeight="SemiBold" Margin="0,0,8,0"/>
            <TextBlock Text="{Binding AddedCount}" Foreground="{DynamicResource SuccessBrush}"/>
          </StackPanel>
          
          <StackPanel Orientation="Horizontal" Margin="0,0,24,0">
            <TextBlock Text="Removed:" FontWeight="SemiBold" Margin="0,0,8,0"/>
            <TextBlock Text="{Binding RemovedCount}" Foreground="{DynamicResource DangerBrush}"/>
          </StackPanel>
          
          <StackPanel Orientation="Horizontal" Margin="0,0,24,0">
            <TextBlock Text="Changed:" FontWeight="SemiBold" Margin="0,0,8,0"/>
            <TextBlock Text="{Binding ModifiedCount}" Foreground="{DynamicResource WarningBrush}"/>
          </StackPanel>

          <StackPanel Orientation="Horizontal" Margin="0,0,24,0">
            <TextBlock Text="Review Required:" FontWeight="SemiBold" Margin="0,0,8,0"/>
            <TextBlock Text="{Binding ReviewRequiredCount}" Foreground="{DynamicResource DangerBrush}"/>
          </StackPanel>
          
          <StackPanel Orientation="Horizontal">
            <TextBlock Text="Unchanged:" FontWeight="SemiBold" Margin="0,0,8,0"/>
            <TextBlock Text="{Binding UnchangedCount}" Foreground="{DynamicResource TextMutedBrush}"/>
          </StackPanel>
        </StackPanel>
      </Border>
    </Grid>

    <!-- Diff Tabs -->
    <TabControl Grid.Row="2" Visibility="{Binding HasDiff, Converter={StaticResource BoolToVis}}">
      <!-- Added Controls -->
      <TabItem>
        <TabItem.Header>
          <StackPanel Orientation="Horizontal">
            <TextBlock Text="Added (" Foreground="{DynamicResource SuccessBrush}"/>
            <TextBlock Text="{Binding AddedCount}" Foreground="{DynamicResource SuccessBrush}"/>
            <TextBlock Text=")" Foreground="{DynamicResource SuccessBrush}"/>
          </StackPanel>
        </TabItem.Header>
        
        <Grid Margin="8">
          <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
          </Grid.RowDefinitions>
          
           <!-- Added Controls List -->
           <ListView Grid.Row="0" ItemsSource="{Binding AddedControls}" SelectedItem="{Binding SelectedAddedControl}"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     ScrollViewer.CanContentScroll="True">
             <ListView.View>
               <GridView>
                 <GridViewColumn Header="Control ID" DisplayMemberBinding="{Binding ControlId}" Width="140"/>
                 <GridViewColumn Header="Title" DisplayMemberBinding="{Binding Title}" Width="350"/>
                 <GridViewColumn Header="Severity" DisplayMemberBinding="{Binding Severity}" Width="100"/>
               </GridView>
             </ListView.View>
           </ListView>
          
          <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch" VerticalAlignment="Center" Background="{DynamicResource BorderBrush}"/>
          
          <!-- Selected Control Details -->
          <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,8,0,0">
            <StackPanel Visibility="{Binding HasSelectedAddedControl, Converter={StaticResource BoolToVis}}">
              <TextBlock Text="Control Details:" FontWeight="SemiBold" Margin="0,0,0,8"/>
              
              <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                <TextBlock Text="Control ID: " FontWeight="SemiBold" Width="100"/>
                <TextBlock Text="{Binding SelectedAddedControl.ControlId}"/>
              </StackPanel>
              
              <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                <TextBlock Text="Severity: " FontWeight="SemiBold" Width="100"/>
                <TextBlock Text="{Binding SelectedAddedControl.Severity}"/>
              </StackPanel>
              
              <TextBlock Text="Title:" FontWeight="SemiBold" Margin="0,8,0,4"/>
              <TextBlock Text="{Binding SelectedAddedControl.Title}" TextWrapping="Wrap" Margin="0,0,0,8"/>
              
              <TextBlock Text="Check Text:" FontWeight="SemiBold" Margin="0,8,0,4"/>
              <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="8" Background="{DynamicResource SurfaceBrush}">
                <TextBlock Text="{Binding SelectedAddedControl.CheckText}" TextWrapping="Wrap" FontFamily="Consolas" FontSize="11"/>
              </Border>
            </StackPanel>
          </ScrollViewer>
        </Grid>
      </TabItem>

      <!-- Removed Controls -->
      <TabItem>
        <TabItem.Header>
          <StackPanel Orientation="Horizontal">
            <TextBlock Text="Removed (" Foreground="{DynamicResource DangerBrush}"/>
            <TextBlock Text="{Binding RemovedCount}" Foreground="{DynamicResource DangerBrush}"/>
            <TextBlock Text=")" Foreground="{DynamicResource DangerBrush}"/>
          </StackPanel>
        </TabItem.Header>
        
        <Grid Margin="8">
          <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
          </Grid.RowDefinitions>
          
           <!-- Removed Controls List -->
           <ListView Grid.Row="0" ItemsSource="{Binding RemovedControls}" SelectedItem="{Binding SelectedRemovedControl}"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     ScrollViewer.CanContentScroll="True">
             <ListView.View>
               <GridView>
                 <GridViewColumn Header="Control ID" DisplayMemberBinding="{Binding ControlId}" Width="140"/>
                 <GridViewColumn Header="Title" DisplayMemberBinding="{Binding Title}" Width="350"/>
                 <GridViewColumn Header="Severity" DisplayMemberBinding="{Binding Severity}" Width="100"/>
               </GridView>
             </ListView.View>
           </ListView>
          
          <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch" VerticalAlignment="Center" Background="{DynamicResource BorderBrush}"/>
          
          <!-- Selected Control Details -->
          <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,8,0,0">
            <StackPanel Visibility="{Binding HasSelectedRemovedControl, Converter={StaticResource BoolToVis}}">
              <TextBlock Text="Control Details:" FontWeight="SemiBold" Margin="0,0,0,8"/>
              
              <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                <TextBlock Text="Control ID: " FontWeight="SemiBold" Width="100"/>
                <TextBlock Text="{Binding SelectedRemovedControl.ControlId}"/>
              </StackPanel>
              
              <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                <TextBlock Text="Severity: " FontWeight="SemiBold" Width="100"/>
                <TextBlock Text="{Binding SelectedRemovedControl.Severity}"/>
              </StackPanel>
              
              <TextBlock Text="Title:" FontWeight="SemiBold" Margin="0,8,0,4"/>
              <TextBlock Text="{Binding SelectedRemovedControl.Title}" TextWrapping="Wrap" Margin="0,0,0,8"/>
              
              <TextBlock Text="Check Text:" FontWeight="SemiBold" Margin="0,8,0,4"/>
              <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="8" Background="{DynamicResource SurfaceBrush}">
                <TextBlock Text="{Binding SelectedRemovedControl.CheckText}" TextWrapping="Wrap" FontFamily="Consolas" FontSize="11"/>
              </Border>
            </StackPanel>
          </ScrollViewer>
        </Grid>
      </TabItem>

      <!-- Changed Controls -->
      <TabItem>
        <TabItem.Header>
          <StackPanel Orientation="Horizontal">
            <TextBlock Text="Changed (" Foreground="{DynamicResource WarningBrush}"/>
            <TextBlock Text="{Binding ModifiedCount}" Foreground="{DynamicResource WarningBrush}"/>
            <TextBlock Text=")" Foreground="{DynamicResource WarningBrush}"/>
          </StackPanel>
        </TabItem.Header>
        
        <Grid Margin="8">
          <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
          </Grid.RowDefinitions>
          
           <!-- Modified Controls List -->
           <ListView Grid.Row="0" ItemsSource="{Binding ModifiedControls}" SelectedItem="{Binding SelectedModifiedItem}"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     ScrollViewer.CanContentScroll="True">
             <ListView.View>
               <GridView>
                 <GridViewColumn Header="Control ID" DisplayMemberBinding="{Binding ControlId}" Width="140"/>
                 <GridViewColumn Header="Title" DisplayMemberBinding="{Binding Title}" Width="280"/>
                 <GridViewColumn Header="Classification" DisplayMemberBinding="{Binding Classification}" Width="120"/>
                 <GridViewColumn Header="Impact" Width="100">
                   <GridViewColumn.CellTemplate>
                     <DataTemplate>
                       <Border Background="{Binding ImpactColor}" Padding="4,2" CornerRadius="2">
                         <TextBlock Text="{Binding Impact}" Foreground="White" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                       </Border>
                     </DataTemplate>
                   </GridViewColumn.CellTemplate>
                 </GridViewColumn>
                 <GridViewColumn Header="Changes" DisplayMemberBinding="{Binding ChangesSummary}" Width="250"/>
               </GridView>
             </ListView.View>
           </ListView>
          
          <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch" VerticalAlignment="Center" Background="{DynamicResource BorderBrush}"/>
          
          <!-- Field-Level Diff -->
          <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,8,0,0">
            <StackPanel Visibility="{Binding HasSelectedModifiedItem, Converter={StaticResource BoolToVis}}">
              <TextBlock Text="Field-Level Changes:" FontWeight="SemiBold" Margin="0,0,0,8"/>
              
              <ItemsControl ItemsSource="{Binding SelectedModifiedChanges}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="8" Margin="0,0,0,8" Background="{DynamicResource SurfaceBrush}">
                      <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                          <TextBlock Text="{Binding FieldName}" FontWeight="SemiBold" Margin="0,0,8,0"/>
                          <Border Background="{Binding ImpactColor}" Padding="4,2" CornerRadius="2">
                            <TextBlock Text="{Binding Impact}" Foreground="White" FontSize="10" FontWeight="SemiBold"/>
                          </Border>
                        </StackPanel>
                        
                        <!-- Old Value -->
                        <TextBlock Text="Before:" FontWeight="SemiBold" FontSize="11" Foreground="{DynamicResource DangerBrush}" Margin="0,0,0,2"/>
                        <Border Background="{DynamicResource SurfaceMutedBrush}" Padding="6" Margin="0,0,0,4">
                          <TextBlock Text="{Binding OldValue}" TextWrapping="Wrap" FontFamily="Consolas" FontSize="11"/>
                        </Border>
                        
                        <!-- New Value -->
                        <TextBlock Text="After:" FontWeight="SemiBold" FontSize="11" Foreground="{DynamicResource SuccessBrush}" Margin="0,4,0,2"/>
                        <Border Background="{DynamicResource AccentSoftBrush}" Padding="6">
                          <TextBlock Text="{Binding NewValue}" TextWrapping="Wrap" FontFamily="Consolas" FontSize="11"/>
                        </Border>
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </ScrollViewer>
        </Grid>
      </TabItem>

      <!-- Review Required Controls -->
      <TabItem>
        <TabItem.Header>
          <StackPanel Orientation="Horizontal">
            <TextBlock Text="Review Required (" Foreground="{DynamicResource DangerBrush}"/>
            <TextBlock Text="{Binding ReviewRequiredCount}" Foreground="{DynamicResource DangerBrush}"/>
            <TextBlock Text=")" Foreground="{DynamicResource DangerBrush}"/>
          </StackPanel>
        </TabItem.Header>

        <Grid Margin="8">
          <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
          </Grid.RowDefinitions>

           <ListView Grid.Row="0" ItemsSource="{Binding ReviewRequiredControls}" SelectedItem="{Binding SelectedReviewRequiredControl}"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     ScrollViewer.CanContentScroll="True">
             <ListView.View>
               <GridView>
                 <GridViewColumn Header="Control Key" DisplayMemberBinding="{Binding ControlKey}" Width="210"/>
                 <GridViewColumn Header="Title" DisplayMemberBinding="{Binding Title}" Width="260"/>
                 <GridViewColumn Header="Change Type" DisplayMemberBinding="{Binding ChangeType}" Width="120"/>
                 <GridViewColumn Header="Reason" DisplayMemberBinding="{Binding Reason}" Width="320"/>
               </GridView>
             </ListView.View>
           </ListView>

          <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch" VerticalAlignment="Center" Background="{DynamicResource BorderBrush}"/>

          <Border Grid.Row="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="8" Margin="0,8,0,0" Background="{DynamicResource SurfaceBrush}"
                  Visibility="{Binding HasSelectedReviewRequiredControl, Converter={StaticResource BoolToVis}}">
            <StackPanel>
              <TextBlock Text="Review Details:" FontWeight="SemiBold" Margin="0,0,0,8"/>

              <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                <TextBlock Text="Control Key: " FontWeight="SemiBold" Width="100"/>
                <TextBlock Text="{Binding SelectedReviewRequiredControl.ControlKey}"/>
              </StackPanel>

              <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                <TextBlock Text="Change Type: " FontWeight="SemiBold" Width="100"/>
                <TextBlock Text="{Binding SelectedReviewRequiredControl.ChangeType}"/>
              </StackPanel>

              <TextBlock Text="Title:" FontWeight="SemiBold" Margin="0,8,0,4"/>
              <TextBlock Text="{Binding SelectedReviewRequiredControl.Title}" TextWrapping="Wrap" Margin="0,0,0,8"/>

              <TextBlock Text="Reason:" FontWeight="SemiBold" Margin="0,8,0,4"/>
              <TextBlock Text="{Binding SelectedReviewRequiredControl.Reason}" TextWrapping="Wrap"/>
            </StackPanel>
          </Border>
        </Grid>
      </TabItem>
    </TabControl>

    <!-- Loading/No Diff Message -->
    <StackPanel Grid.Row="2" VerticalAlignment="Center" HorizontalAlignment="Center"
                Visibility="{Binding HasDiff, Converter={StaticResource BoolToVis}, ConverterParameter=Inverted}">
      <TextBlock Text="{Binding StatusMessage}" FontSize="16" Foreground="{DynamicResource TextMutedBrush}" TextAlignment="Center"/>
    </StackPanel>
  </Grid>
</Window>
