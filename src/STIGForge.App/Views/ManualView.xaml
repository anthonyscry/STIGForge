<UserControl x:Class="STIGForge.App.Views.ManualView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

  <Grid Margin="10">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <WrapPanel Grid.Row="0" Margin="0,0,0,8">
      <Button Content="Launch Review Wizard" MinWidth="170" Height="32" Padding="14,0" Margin="0,0,12,0"
              Command="{Binding LaunchManualWizardCommand}" IsEnabled="{Binding ActionsEnabled}"
              AutomationProperties.Name="Launch manual review wizard"
              ToolTipService.ToolTip="Open the guided wizard for step-by-step manual control review and disposition."/>
      <Button Content="Bulk Set Status" MinWidth="140" Height="32" Padding="14,0" Margin="0,0,12,0"
              Command="{Binding LaunchBulkDispositionCommand}" IsEnabled="{Binding ActionsEnabled}"
              AutomationProperties.Name="Bulk set status for STIG group"
              ToolTipService.ToolTip="Apply the same Pass/Fail/N/A disposition to all controls in a STIG group at once."/>
      <Button Content="Import CSV" Command="{Binding ImportManualCsvCommand}"
              ToolTipService.ToolTip="Import manual answers from a CSV file (columns: RuleId/VulnId, Status, Reason, Comment)"
              Margin="8,0,0,0" Padding="12,4"/>
      <Button Content="Export CSV" Command="{Binding ExportManualCsvCommand}"
              ToolTipService.ToolTip="Export manual controls to CSV file"
              Margin="8,0,0,0" Padding="12,4"/>
      <Button Content="Export HTML" Command="{Binding ExportManualHtmlCommand}"
              ToolTipService.ToolTip="Export manual controls to HTML report"
              Margin="8,0,0,0" Padding="12,4"/>
      <TextBlock Text="Step-by-step wizard for reviewing manual controls with guided workflow"
                 Margin="0,8,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
    </WrapPanel>

    <TabControl Grid.Row="1">

      <!-- Tab 1: Manual Review — controls needing operator disposition -->
      <TabItem Header="Manual Review">
        <Grid Margin="8">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
          </Grid.RowDefinitions>

          <WrapPanel Grid.Row="0" Margin="0,0,0,8">
            <TextBlock Text="Search:" VerticalAlignment="Center" Margin="0,0,6,0"/>
            <TextBox Width="240" Text="{Binding ManualFilterText, UpdateSourceTrigger=PropertyChanged}"
                     AutomationProperties.Name="Search manual controls"
                     ToolTipService.ToolTip="Search by VulnId, RuleId, Title, Check Text, Fix Text, or STIG Group"/>
            <TextBlock Text="Status:" VerticalAlignment="Center" Margin="16,0,6,0"/>
            <ComboBox Width="140" ItemsSource="{Binding ManualStatusFilters}" SelectedItem="{Binding ManualReviewStatusFilter}"
                      AutomationProperties.Name="Review status filter"/>
            <TextBlock Text="CAT:" VerticalAlignment="Center" Margin="16,0,6,0"/>
            <ComboBox Width="100" ItemsSource="{Binding ManualCatFilters}" SelectedItem="{Binding ManualCatFilter}"
                      AutomationProperties.Name="CAT level filter"/>
            <TextBlock Text="STIG:" VerticalAlignment="Center" Margin="16,0,6,0"/>
            <ComboBox Width="200" ItemsSource="{Binding ManualStigGroupFilters}" SelectedItem="{Binding ManualStigGroupFilter}"
                      AutomationProperties.Name="STIG group filter"/>
          </WrapPanel>

          <TextBlock Grid.Row="1" Text="{Binding ManualSummary}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,6"/>

          <TextBlock Grid.Row="2" Text="No manual controls loaded. Build a bundle with STIG content packs to populate this view."
                     VerticalAlignment="Center" HorizontalAlignment="Center" TextAlignment="Center"
                     Foreground="{DynamicResource TextMutedBrush}" FontSize="14" TextWrapping="Wrap" MaxWidth="500">
            <TextBlock.Style>
              <Style TargetType="TextBlock">
                <Setter Property="Visibility" Value="Collapsed"/>
                <Style.Triggers>
                  <DataTrigger Binding="{Binding HasManualControls}" Value="False">
                    <Setter Property="Visibility" Value="Visible"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </TextBlock.Style>
          </TextBlock>

          <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" MinWidth="350"/>
              <ColumnDefinition Width="8"/>
              <ColumnDefinition Width="1.2*"/>
            </Grid.ColumnDefinitions>

             <DataGrid Grid.Column="0" x:Name="ManualReviewGrid"
                        ItemsSource="{Binding ManualReviewView}"
                        SelectedItem="{Binding SelectedManualControl}"
                        VirtualizingPanel.IsVirtualizing="True"
                        VirtualizingPanel.VirtualizationMode="Recycling"
                        ScrollViewer.CanContentScroll="True"
                        AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Single"
                        CanUserSortColumns="True" CanUserResizeColumns="True"
                        HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                        ScrollViewer.HorizontalScrollBarVisibility="Auto"
                        ScrollViewer.VerticalScrollBarVisibility="Auto"
                        Background="{DynamicResource SurfaceBrush}"
                        Foreground="{DynamicResource TextPrimaryBrush}"
                         BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                         RowHeaderWidth="0">
              <DataGrid.GroupStyle>
                <GroupStyle>
                  <GroupStyle.ContainerStyle>
                    <Style TargetType="{x:Type GroupItem}">
                      <Setter Property="Template">
                        <Setter.Value>
                          <ControlTemplate TargetType="{x:Type GroupItem}">
                            <Expander IsExpanded="True">
                              <Expander.Header>
                                <StackPanel Orientation="Horizontal">
                                  <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"
                                             Foreground="{DynamicResource AccentBrush}" Margin="0,0,8,0"/>
                                  <TextBlock Text="{Binding ItemCount, StringFormat='({0})'}"
                                             Foreground="{DynamicResource TextMutedBrush}"/>
                                </StackPanel>
                              </Expander.Header>
                              <ItemsPresenter/>
                            </Expander>
                          </ControlTemplate>
                        </Setter.Value>
                      </Setter>
                    </Style>
                  </GroupStyle.ContainerStyle>
                </GroupStyle>
              </DataGrid.GroupStyle>
              <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                  <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
                  <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding Status}" Value="Pass">
                      <Setter Property="Foreground" Value="#4CAF50"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="Fail">
                      <Setter Property="Foreground" Value="#F44336"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="Open">
                      <Setter Property="Foreground" Value="#F44336"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="NotApplicable">
                      <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="Not_Reviewed">
                      <Setter Property="Foreground" Value="#FF9800"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding CatLevel}" Value="CAT I">
                      <Setter Property="FontWeight" Value="Bold"/>
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </DataGrid.RowStyle>
              <DataGrid.Columns>
                <DataGridTextColumn Header="VulnId" Binding="{Binding VulnId}" Width="90"/>
                <DataGridTextColumn Header="RuleId" Binding="{Binding RuleId}" Width="120"/>
                <DataGridTextColumn Header="STIG Group" Binding="{Binding StigGroup}" Width="*"/>
                <DataGridTextColumn Header="CAT" Binding="{Binding CatLevel}" Width="70"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="90"/>
                <DataGridTemplateColumn Header="Changes" Width="180">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding ChangeDescription}"
                                 Foreground="Orange" FontStyle="Italic"
                                 Visibility="{Binding HasChanged, Converter={StaticResource BoolToVisibility}}"
                                 ToolTipService.ToolTip="Status was changed from previous value"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
              </DataGrid.Columns>
            </DataGrid>

            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                          Background="{DynamicResource BorderBrush}"/>

            <TabControl Grid.Column="2" Margin="4,0,0,0">
              <TabItem Header="Details">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <TextBlock Text="Selected Control" FontSize="15" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <WrapPanel Margin="0,0,0,8">
                      <TextBlock Text="{Binding SelectedManualControl.StigGroup}" FontSize="12"
                                 Foreground="{DynamicResource AccentBrush}" Margin="0,0,12,0"/>
                      <TextBlock Text="{Binding SelectedManualControl.CatLevel}" FontSize="12" FontWeight="Bold"
                                 Foreground="{DynamicResource WarningBrush}"/>
                    </WrapPanel>
                    <TextBlock Text="{Binding SelectedManualControl.Control.Title}" TextWrapping="Wrap" FontSize="13" Margin="0,0,0,10"/>
                    <TextBlock Text="Check Text" FontWeight="SemiBold" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,4"/>
                    <TextBlock Text="{Binding SelectedManualControl.Control.CheckText}" TextWrapping="Wrap" Foreground="{DynamicResource TextMutedBrush}"/>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>

              <TabItem Header="Disposition">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <WrapPanel Margin="0,0,0,10">
                      <TextBlock Text="Status:" Width="80" VerticalAlignment="Center"/>
                      <ComboBox Width="160" ItemsSource="{Binding ManualStatuses}" SelectedItem="{Binding ManualStatus}"
                                AutomationProperties.Name="Manual control status"/>
                    </WrapPanel>
                    <TextBlock Text="Reason:" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding ManualReason}" Height="40" TextWrapping="Wrap"
                             AutomationProperties.Name="Manual control reason"/>
                    <TextBlock Text="Comment:" Margin="0,12,0,4"/>
                    <TextBox Text="{Binding ManualComment}" Height="80" TextWrapping="Wrap"
                             AutomationProperties.Name="Manual control comment"/>
                     <WrapPanel Margin="0,12,0,0">
                        <Button Content="Save Answer" MinWidth="130" Height="30" Padding="14,0" Margin="0,0,10,4"
                                Command="{Binding SaveManualAnswerCommand}"
                                ToolTipService.ToolTip="Save your answer for this control. (Ctrl+S)"
                                AutomationProperties.Name="Save manual answer"/>
                        <Button Content="Undo" MinWidth="80" Height="30" Padding="14,0" Margin="0,0,10,4"
                                Command="{Binding UndoAnswerCommand}" IsEnabled="{Binding CanUndoAnswer}"
                                AutomationProperties.Name="Undo last answer change"
                                ToolTipService.ToolTip="Undo the last answer change (Ctrl+Z)"/>
                        <TextBlock Text="{Binding AutoSaveStatus}" Margin="8,8,0,0" Foreground="{DynamicResource SuccessBrush}" FontSize="11"/>
                     </WrapPanel>
                    <TextBlock Text="Fail and NotApplicable require a reason." Foreground="{DynamicResource TextMutedBrush}" FontSize="11" Margin="0,4,0,0"/>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>

              <TabItem Header="Evidence">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <TextBlock Text="Control Evidence Actions" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <WrapPanel Margin="0,0,0,12">
                      <Button Content="Use for Evidence" MinWidth="140" Height="30" Padding="14,0" Margin="0,0,10,4"
                              Command="{Binding UseSelectedControlForEvidenceCommand}" AutomationProperties.Name="Use control for evidence"/>
                      <Button Content="Collect Evidence" MinWidth="140" Height="30" Padding="14,0" Margin="0,0,10,4"
                              Command="{Binding CollectSelectedControlEvidenceCommand}" AutomationProperties.Name="Collect evidence for control"/>
                      <Button Content="Open Evidence Folder" MinWidth="160" Height="30" Padding="14,0" Margin="0,0,0,4"
                              Command="{Binding OpenSelectedControlEvidenceFolderCommand}" AutomationProperties.Name="Open evidence folder"/>
                    </WrapPanel>
                    <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Background="{DynamicResource SurfaceMutedBrush}">
                      <StackPanel>
                        <TextBlock Text="Evidence Capture" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <WrapPanel Margin="0,0,0,6">
                          <TextBlock Text="RuleId:" Width="80" VerticalAlignment="Center"/>
                          <TextBox Width="260" Text="{Binding EvidenceRuleId}" AutomationProperties.Name="Evidence rule ID"/>
                          <TextBlock Text="Type:" Width="60" Margin="12,0,0,0" VerticalAlignment="Center"/>
                          <ComboBox Width="160" ItemsSource="{Binding EvidenceTypes}" SelectedItem="{Binding EvidenceType}" AutomationProperties.Name="Evidence type"/>
                        </WrapPanel>
                        <TextBlock Text="Evidence text:" Margin="0,0,0,2"/>
                        <TextBox Height="60" TextWrapping="Wrap" Text="{Binding EvidenceText}" AutomationProperties.Name="Evidence text"/>
                        <Grid Margin="0,6,0,0">
                          <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                          </Grid.ColumnDefinitions>
                          <TextBlock Grid.Column="0" Text="File:" VerticalAlignment="Center"/>
                          <TextBox Grid.Column="1" Text="{Binding EvidenceFilePath}" AutomationProperties.Name="Evidence file path"/>
                          <Button Grid.Column="2" Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                                  Command="{Binding BrowseEvidenceFileCommand}" AutomationProperties.Name="Browse for evidence file"/>
                        </Grid>
                        <WrapPanel Margin="0,8,0,0">
                          <Button Content="Save Evidence" MinWidth="140" Height="30" Padding="14,0"
                                  Command="{Binding SaveEvidenceCommand}" AutomationProperties.Name="Save evidence record"/>
                          <TextBlock Text="{Binding EvidenceStatus}" Margin="12,8,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
                        </WrapPanel>
                      </StackPanel>
                    </Border>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>

              <TabItem Header="Notes">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <TextBlock Text="Control Notes" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8"/>
                    <TextBlock Text="Add personal notes, observations, or reminders for this control."
                               Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,8"/>
                    <TextBox Text="{Binding ControlNotes, UpdateSourceTrigger=PropertyChanged}"
                             Height="200" TextWrapping="Wrap" AcceptsReturn="True"
                             AutomationProperties.Name="Control notes"/>
                    <Button Content="Save Notes" MinWidth="130" Height="30" Padding="14,0" Margin="0,8,0,0"
                            Command="{Binding SaveControlNotesCommand}"
                            AutomationProperties.Name="Save control notes"/>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>
            </TabControl>
          </Grid>
        </Grid>
      </TabItem>

      <!-- Tab 2: Full Review — ALL controls with full filtering -->
      <TabItem Header="Full Review">
        <Grid Margin="8">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
          </Grid.RowDefinitions>

          <WrapPanel Grid.Row="0" Margin="0,0,0,8">
            <TextBlock Text="Search:" VerticalAlignment="Center" Margin="0,0,6,0"/>
            <TextBox Width="240" Text="{Binding ManualFilterText, UpdateSourceTrigger=PropertyChanged}"
                     AutomationProperties.Name="Search all controls"
                     ToolTipService.ToolTip="Search by VulnId, RuleId, Title, Check Text, Fix Text, or STIG Group"/>
            <TextBlock Text="Status:" VerticalAlignment="Center" Margin="16,0,6,0"/>
            <ComboBox Width="140" ItemsSource="{Binding ManualStatusFilters}" SelectedItem="{Binding ManualStatusFilter}"
                      AutomationProperties.Name="Status filter"/>
            <TextBlock Text="CAT:" VerticalAlignment="Center" Margin="16,0,6,0"/>
            <ComboBox Width="100" ItemsSource="{Binding ManualCatFilters}" SelectedItem="{Binding ManualCatFilter}"
                      AutomationProperties.Name="CAT level filter"/>
            <TextBlock Text="STIG:" VerticalAlignment="Center" Margin="16,0,6,0"/>
            <ComboBox Width="200" ItemsSource="{Binding ManualStigGroupFilters}" SelectedItem="{Binding ManualStigGroupFilter}"
                      AutomationProperties.Name="STIG group filter"/>
          </WrapPanel>

          <TextBlock Grid.Row="1" Text="{Binding ManualSummary}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,6"/>

          <TextBlock Grid.Row="2" Text="No manual controls loaded. Build a bundle with STIG content packs to populate this view."
                     VerticalAlignment="Center" HorizontalAlignment="Center" TextAlignment="Center"
                     Foreground="{DynamicResource TextMutedBrush}" FontSize="14" TextWrapping="Wrap" MaxWidth="500">
            <TextBlock.Style>
              <Style TargetType="TextBlock">
                <Setter Property="Visibility" Value="Collapsed"/>
                <Style.Triggers>
                  <DataTrigger Binding="{Binding HasManualControls}" Value="False">
                    <Setter Property="Visibility" Value="Visible"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </TextBlock.Style>
          </TextBlock>

          <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" MinWidth="350"/>
              <ColumnDefinition Width="8"/>
              <ColumnDefinition Width="1.2*"/>
            </Grid.ColumnDefinitions>

             <DataGrid Grid.Column="0" x:Name="FullReviewGrid"
                        ItemsSource="{Binding ManualControlsView}"
                        SelectedItem="{Binding SelectedManualControl}"
                        VirtualizingPanel.IsVirtualizing="True"
                        VirtualizingPanel.VirtualizationMode="Recycling"
                        ScrollViewer.CanContentScroll="True"
                        AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Single"
                        CanUserSortColumns="True" CanUserResizeColumns="True"
                        HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                        ScrollViewer.HorizontalScrollBarVisibility="Auto"
                        ScrollViewer.VerticalScrollBarVisibility="Auto"
                        Background="{DynamicResource SurfaceBrush}"
                        Foreground="{DynamicResource TextPrimaryBrush}"
                         BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                         RowHeaderWidth="0">
              <DataGrid.GroupStyle>
                <GroupStyle>
                  <GroupStyle.ContainerStyle>
                    <Style TargetType="{x:Type GroupItem}">
                      <Setter Property="Template">
                        <Setter.Value>
                          <ControlTemplate TargetType="{x:Type GroupItem}">
                            <Expander IsExpanded="True">
                              <Expander.Header>
                                <StackPanel Orientation="Horizontal">
                                  <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"
                                             Foreground="{DynamicResource AccentBrush}" Margin="0,0,8,0"/>
                                  <TextBlock Text="{Binding ItemCount, StringFormat='({0})'}"
                                             Foreground="{DynamicResource TextMutedBrush}"/>
                                </StackPanel>
                              </Expander.Header>
                              <ItemsPresenter/>
                            </Expander>
                          </ControlTemplate>
                        </Setter.Value>
                      </Setter>
                    </Style>
                  </GroupStyle.ContainerStyle>
                </GroupStyle>
              </DataGrid.GroupStyle>
              <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                  <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
                  <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding Status}" Value="Pass">
                      <Setter Property="Foreground" Value="#4CAF50"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="Fail">
                      <Setter Property="Foreground" Value="#F44336"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="Open">
                      <Setter Property="Foreground" Value="#F44336"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="NotApplicable">
                      <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Status}" Value="Not_Reviewed">
                      <Setter Property="Foreground" Value="#FF9800"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding CatLevel}" Value="CAT I">
                      <Setter Property="FontWeight" Value="Bold"/>
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </DataGrid.RowStyle>
              <DataGrid.Columns>
                <DataGridTextColumn Header="VulnId" Binding="{Binding VulnId}" Width="90"/>
                <DataGridTextColumn Header="RuleId" Binding="{Binding RuleId}" Width="120"/>
                <DataGridTextColumn Header="STIG Group" Binding="{Binding StigGroup}" Width="*"/>
                <DataGridTextColumn Header="CAT" Binding="{Binding CatLevel}" Width="70"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="90"/>
                <DataGridTemplateColumn Header="Changes" Width="180">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding ChangeDescription}"
                                 Foreground="Orange" FontStyle="Italic"
                                 Visibility="{Binding HasChanged, Converter={StaticResource BoolToVisibility}}"
                                 ToolTipService.ToolTip="Status was changed from previous value"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
              </DataGrid.Columns>
            </DataGrid>

            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                          Background="{DynamicResource BorderBrush}"/>

            <TabControl Grid.Column="2" Margin="4,0,0,0">
              <TabItem Header="Details">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <TextBlock Text="Selected Control" FontSize="15" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <WrapPanel Margin="0,0,0,8">
                      <TextBlock Text="{Binding SelectedManualControl.StigGroup}" FontSize="12"
                                 Foreground="{DynamicResource AccentBrush}" Margin="0,0,12,0"/>
                      <TextBlock Text="{Binding SelectedManualControl.CatLevel}" FontSize="12" FontWeight="Bold"
                                 Foreground="{DynamicResource WarningBrush}"/>
                    </WrapPanel>
                    <TextBlock Text="{Binding SelectedManualControl.Control.Title}" TextWrapping="Wrap" FontSize="13" Margin="0,0,0,10"/>
                    <TextBlock Text="Check Text" FontWeight="SemiBold" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,4"/>
                    <TextBlock Text="{Binding SelectedManualControl.Control.CheckText}" TextWrapping="Wrap" Foreground="{DynamicResource TextMutedBrush}"/>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>

              <TabItem Header="Disposition">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <WrapPanel Margin="0,0,0,10">
                      <TextBlock Text="Status:" Width="80" VerticalAlignment="Center"/>
                      <ComboBox Width="160" ItemsSource="{Binding ManualStatuses}" SelectedItem="{Binding ManualStatus}"
                                AutomationProperties.Name="Manual control status"/>
                    </WrapPanel>
                    <TextBlock Text="Reason:" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding ManualReason}" Height="40" TextWrapping="Wrap"
                             AutomationProperties.Name="Manual control reason"/>
                    <TextBlock Text="Comment:" Margin="0,12,0,4"/>
                    <TextBox Text="{Binding ManualComment}" Height="80" TextWrapping="Wrap"
                             AutomationProperties.Name="Manual control comment"/>
                     <WrapPanel Margin="0,12,0,0">
                        <Button Content="Save Answer" MinWidth="130" Height="30" Padding="14,0" Margin="0,0,10,4"
                                Command="{Binding SaveManualAnswerCommand}"
                                ToolTipService.ToolTip="Save your answer for this control. (Ctrl+S)"
                                AutomationProperties.Name="Save manual answer"/>
                        <Button Content="Undo" MinWidth="80" Height="30" Padding="14,0" Margin="0,0,10,4"
                                Command="{Binding UndoAnswerCommand}" IsEnabled="{Binding CanUndoAnswer}"
                                AutomationProperties.Name="Undo last answer change"
                                ToolTipService.ToolTip="Undo the last answer change (Ctrl+Z)"/>
                        <TextBlock Text="{Binding AutoSaveStatus}" Margin="8,8,0,0" Foreground="{DynamicResource SuccessBrush}" FontSize="11"/>
                     </WrapPanel>
                    <TextBlock Text="Fail and NotApplicable require a reason." Foreground="{DynamicResource TextMutedBrush}" FontSize="11" Margin="0,4,0,0"/>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>

              <TabItem Header="Evidence">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <TextBlock Text="Control Evidence Actions" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <WrapPanel Margin="0,0,0,12">
                      <Button Content="Use for Evidence" MinWidth="140" Height="30" Padding="14,0" Margin="0,0,10,4"
                              Command="{Binding UseSelectedControlForEvidenceCommand}" AutomationProperties.Name="Use control for evidence"/>
                      <Button Content="Collect Evidence" MinWidth="140" Height="30" Padding="14,0" Margin="0,0,10,4"
                              Command="{Binding CollectSelectedControlEvidenceCommand}" AutomationProperties.Name="Collect evidence for control"/>
                      <Button Content="Open Evidence Folder" MinWidth="160" Height="30" Padding="14,0" Margin="0,0,0,4"
                              Command="{Binding OpenSelectedControlEvidenceFolderCommand}" AutomationProperties.Name="Open evidence folder"/>
                    </WrapPanel>
                    <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Background="{DynamicResource SurfaceMutedBrush}">
                      <StackPanel>
                        <TextBlock Text="Evidence Capture" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <WrapPanel Margin="0,0,0,6">
                          <TextBlock Text="RuleId:" Width="80" VerticalAlignment="Center"/>
                          <TextBox Width="260" Text="{Binding EvidenceRuleId}" AutomationProperties.Name="Evidence rule ID"/>
                          <TextBlock Text="Type:" Width="60" Margin="12,0,0,0" VerticalAlignment="Center"/>
                          <ComboBox Width="160" ItemsSource="{Binding EvidenceTypes}" SelectedItem="{Binding EvidenceType}" AutomationProperties.Name="Evidence type"/>
                        </WrapPanel>
                        <TextBlock Text="Evidence text:" Margin="0,0,0,2"/>
                        <TextBox Height="60" TextWrapping="Wrap" Text="{Binding EvidenceText}" AutomationProperties.Name="Evidence text"/>
                        <Grid Margin="0,6,0,0">
                          <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                          </Grid.ColumnDefinitions>
                          <TextBlock Grid.Column="0" Text="File:" VerticalAlignment="Center"/>
                          <TextBox Grid.Column="1" Text="{Binding EvidenceFilePath}" AutomationProperties.Name="Evidence file path"/>
                          <Button Grid.Column="2" Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                                  Command="{Binding BrowseEvidenceFileCommand}" AutomationProperties.Name="Browse for evidence file"/>
                        </Grid>
                        <WrapPanel Margin="0,8,0,0">
                          <Button Content="Save Evidence" MinWidth="140" Height="30" Padding="14,0"
                                  Command="{Binding SaveEvidenceCommand}" AutomationProperties.Name="Save evidence record"/>
                          <TextBlock Text="{Binding EvidenceStatus}" Margin="12,8,0,0" Foreground="{DynamicResource TextMutedBrush}"/>
                        </WrapPanel>
                      </StackPanel>
                    </Border>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>

              <TabItem Header="Notes">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="12">
                    <TextBlock Text="Control Notes" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8"/>
                    <TextBlock Text="Add personal notes, observations, or reminders for this control."
                               Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,8"/>
                    <TextBox Text="{Binding ControlNotes, UpdateSourceTrigger=PropertyChanged}"
                             Height="200" TextWrapping="Wrap" AcceptsReturn="True"
                             AutomationProperties.Name="Control notes"/>
                    <Button Content="Save Notes" MinWidth="130" Height="30" Padding="14,0" Margin="0,8,0,0"
                            Command="{Binding SaveControlNotesCommand}"
                            AutomationProperties.Name="Save control notes"/>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>
            </TabControl>
          </Grid>
        </Grid>
      </TabItem>

    </TabControl>
  </Grid>
</UserControl>
