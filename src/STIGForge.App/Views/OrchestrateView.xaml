<UserControl x:Class="STIGForge.App.Views.OrchestrateView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <Grid Margin="10">
    <Grid.RowDefinitions>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="200"/>
    </Grid.RowDefinitions>

    <!-- Settings Panel -->
    <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
      <StackPanel>

        <TextBlock Text="Orchestrate Pipeline" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,4"/>
        <TextBlock Text="Run the full Apply, Verify, and Export pipeline. Configure mission preset, scanner tools, PowerSTIG, and safety options below."
                   Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap" Margin="0,0,0,12"/>

        <TabControl Margin="0,0,0,8">
          <TabItem Header="Bundle">
            <StackPanel Margin="8">
              <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Margin="0,0,0,8" Background="{DynamicResource SurfaceMutedBrush}">
                <StackPanel>
                  <WrapPanel Margin="0,0,0,8">
                    <TextBlock Text="Mission preset:" Width="130" VerticalAlignment="Center"/>
                    <ComboBox Width="300" ItemsSource="{Binding MissionPresets}" SelectedItem="{Binding SelectedMissionPreset}"
                              AutomationProperties.Name="Mission preset"
                              ToolTipService.ToolTip="Template workflow: endpoint hardening, golden image bake, or SCCM PXE image bake."/>
                  </WrapPanel>
                  <TextBlock Text="{Binding MissionPresetGuidance}" Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap"/>
                </StackPanel>
              </Border>

              <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Margin="0,0,0,8" Background="{DynamicResource SurfaceBrush}">
                <StackPanel>
                  <WrapPanel Margin="0,0,0,8">
                    <TextBlock Text="Bundle:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="520" Text="{Binding BundleRoot}"
                             AutomationProperties.Name="Bundle root path"
                             ToolTipService.ToolTip="Path to the bundle root folder containing manifest.json."/>
                    <Button Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                            Command="{Binding BrowseBundleCommand}"
                            AutomationProperties.Name="Browse for bundle"/>
                    <Button Content="Open" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                            Command="{Binding OpenBundleFolderCommand}"
                            AutomationProperties.Name="Open bundle folder"/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,8">
                    <CheckBox Content="Run Apply" IsChecked="{Binding OrchRunApply}" Margin="0,0,16,0"
                              AutomationProperties.Name="Run apply phase"
                              ToolTipService.ToolTip="Run apply stage (snapshot, PowerSTIG compile if configured, RunApply.ps1, optional DSC)."/>
                    <CheckBox Content="Run Verify" IsChecked="{Binding OrchRunVerify}" Margin="0,0,16,0"
                              AutomationProperties.Name="Run verify phase"
                              ToolTipService.ToolTip="Run Evaluate-STIG and/or SCAP consolidation to produce mission findings."/>
                    <CheckBox Content="Export eMASS" IsChecked="{Binding OrchRunExport}"
                              AutomationProperties.Name="Export eMASS package"
                              ToolTipService.ToolTip="Generate eMASS package after successful apply/verify."/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,8">
                    <CheckBox Content="Skip snapshot (high risk)" IsChecked="{Binding ApplySkipSnapshot}" Margin="0,0,16,0"
                              AutomationProperties.Name="Skip snapshot"
                              ToolTipService.ToolTip="Bypass pre-apply security/audit snapshot capture. Use only in controlled image-bake pipelines."/>
                    <CheckBox Content="Break-glass acknowledged" IsChecked="{Binding BreakGlassAcknowledged}"
                              AutomationProperties.Name="Break-glass acknowledged"
                              ToolTipService.ToolTip="Required when skip snapshot is enabled."/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,8">
                    <TextBlock Text="Break-glass reason:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="620" Text="{Binding BreakGlassReason}" IsEnabled="{Binding BreakGlassAcknowledged}"
                             AutomationProperties.Name="Break-glass reason"
                             ToolTipService.ToolTip="Operator justification recorded in audit trail for high-risk bypasses."/>
                  </WrapPanel>
                </StackPanel>
              </Border>
            </StackPanel>
          </TabItem>

          <TabItem Header="PowerSTIG">
            <StackPanel Margin="8">
              <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Margin="0,0,0,8" Background="{DynamicResource SurfaceBrush}">
                <StackPanel>
                  <TextBlock Text="PowerSTIG (Optional)" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8"/>
                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="Module:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="520" Text="{Binding PowerStigModulePath}"
                             AutomationProperties.Name="PowerSTIG module path"
                             ToolTipService.ToolTip="Path to PowerSTIG module file (.psd1/.psm1). Enables PowerSTIG compile step."/>
                    <Button Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                            Command="{Binding BrowsePowerStigModuleCommand}"
                            AutomationProperties.Name="Browse for PowerSTIG module"/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,2">
                    <TextBlock Text="Data file:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="520" Text="{Binding PowerStigDataFile}"
                             AutomationProperties.Name="PowerSTIG data file"
                             ToolTipService.ToolTip="Optional .psd1 data file. Leave empty to auto-generate from bundle controls/overrides."/>
                    <Button Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                            Command="{Binding BrowsePowerStigDataCommand}"
                            AutomationProperties.Name="Browse for PowerSTIG data"/>
                  </WrapPanel>
                  <TextBlock Text="Leave empty to auto-generate from bundle controls and profile overrides. Only set this if you have a custom .psd1 file."
                             Foreground="{DynamicResource TextMutedBrush}" FontSize="11" Margin="130,0,0,6"/>
                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="Output path:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="420" Text="{Binding PowerStigOutputPath}"
                             AutomationProperties.Name="PowerSTIG output path"
                             ToolTipService.ToolTip="Optional output folder. Default is bundle Apply/Dsc."/>
                    <CheckBox Content="Verbose" IsChecked="{Binding PowerStigVerbose}" Margin="12,0,0,0" VerticalAlignment="Center"
                              AutomationProperties.Name="PowerSTIG verbose logging"
                              ToolTipService.ToolTip="Enable verbose PowerSTIG compile output in apply logs."/>
                  </WrapPanel>
                </StackPanel>
              </Border>
            </StackPanel>
          </TabItem>

          <TabItem Header="Toolkit / Scanners">
            <StackPanel Margin="8">
              <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Margin="0,0,0,8" Background="{DynamicResource SurfaceBrush}">
                <StackPanel>
                  <TextBlock Text="Toolkit &amp; Scanners" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8"/>
                  <TextBlock Text="Tool paths auto-populate from imported tool bundles and managed cache."
                             Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap" Margin="0,0,0,8"/>
                  <WrapPanel Margin="0,0,0,6">
                    <Button Content="Auto-detect Tools" MinWidth="130" Height="28" Padding="14,0"
                            Command="{Binding ActivateToolkitCommand}"
                            AutomationProperties.Name="Auto-detect tools"
                            ToolTipService.ToolTip="Auto-configure Evaluate-STIG, SCC, and PowerSTIG from imported tools or toolkit cache."/>
                    <Button Content="Open Import Folder" MinWidth="130" Height="28" Padding="14,0" Margin="8,0,0,0"
                            Command="{Binding OpenImportFolderCommand}"
                            AutomationProperties.Name="Open import folder"
                            ToolTipService.ToolTip="Open the import folder used for tool and content ingestion."/>
                  </WrapPanel>
                  <TextBlock Text="{Binding ToolkitActivationStatus}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,8"/>

                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="Eval-STIG preset:" Width="130" VerticalAlignment="Center"/>
                    <ComboBox Width="300" ItemsSource="{Binding EvaluateStigPresets}" SelectedItem="{Binding SelectedEvalStigPreset}"
                              AutomationProperties.Name="Evaluate-STIG preset"
                              ToolTipService.ToolTip="Select a pre-configured Evaluate-STIG argument set."/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="Evaluate-STIG:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="520" Text="{Binding EvaluateStigRoot}"
                             AutomationProperties.Name="Evaluate-STIG root"
                             ToolTipService.ToolTip="Folder containing Evaluate-STIG.ps1."/>
                    <Button Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                            Command="{Binding BrowseEvaluateStigCommand}"
                            AutomationProperties.Name="Browse for Evaluate-STIG"/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="Eval-STIG args:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="520" Text="{Binding EvaluateStigArgs}" IsEnabled="{Binding IsEvalStigCustomArgs}"
                             AutomationProperties.Name="Evaluate-STIG arguments"
                             ToolTipService.ToolTip="Custom Evaluate-STIG arguments. Enabled when preset is set to Custom."/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="SCAP command:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="520" Text="{Binding ScapCommandPath}"
                             AutomationProperties.Name="SCAP command path"
                             ToolTipService.ToolTip="Path to SCC/SCAP executable."/>
                    <Button Content="Browse" MinWidth="80" Height="28" Padding="14,0" Margin="6,0,0,0"
                            Command="{Binding BrowseScapCommandCommand}"
                            AutomationProperties.Name="Browse for SCAP command"/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="SCAP options:" Width="130" VerticalAlignment="Center"/>
                    <CheckBox Content="-u" IsChecked="{Binding ScapIncludeU}" Margin="0,0,10,0" ToolTipService.ToolTip="Include -u switch."/>
                    <CheckBox Content="-s" IsChecked="{Binding ScapIncludeS}" Margin="0,0,10,0" ToolTipService.ToolTip="Include -s switch."/>
                    <CheckBox Content="-r" IsChecked="{Binding ScapIncludeR}" Margin="0,0,10,0" ToolTipService.ToolTip="Include -r switch."/>
                    <CheckBox Content="-f" IsChecked="{Binding ScapIncludeF}" ToolTipService.ToolTip="Include -f switch."/>
                  </WrapPanel>
                  <WrapPanel Margin="0,0,0,6">
                    <TextBlock Text="Extra args:" Width="130" VerticalAlignment="Center"/>
                    <TextBox Width="520" Text="{Binding ScapAdditionalArgs}"
                             AutomationProperties.Name="SCAP additional arguments"
                             ToolTipService.ToolTip="Optional advanced SCAP arguments appended after selected common switches."/>
                  </WrapPanel>
                  <TextBlock Text="{Binding ScapArgsPreview}" Foreground="{DynamicResource TextMutedBrush}" Margin="130,0,0,0" TextWrapping="Wrap"/>
                </StackPanel>
              </Border>
            </StackPanel>
          </TabItem>
        </TabControl>

        <!-- Run Button -->
        <WrapPanel Margin="0,0,0,8">
          <Button Content="Run Orchestration" MinWidth="180" Height="38" Padding="14,0" FontWeight="SemiBold"
                  Command="{Binding OrchestrateCommand}" IsEnabled="{Binding ActionsEnabled}"
                  AutomationProperties.Name="Run orchestration"
                  ToolTipService.ToolTip="Execute apply, verify, and export according to selected toggles and inputs."/>
          <TextBlock Text="{Binding OrchStatus}" Margin="12,10,0,0" Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap"/>
        </WrapPanel>
        <TextBlock Text="{Binding GuidedNextAction}" Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap" Margin="0,0,0,4"/>

      </StackPanel>
    </ScrollViewer>

    <!-- Separator -->
    <Separator Grid.Row="1" Margin="0,4,0,4"/>

    <!-- Orchestration Log -->
    <Border Grid.Row="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Background="{DynamicResource SurfaceBrush}">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <TextBlock Text="{Binding OrchLog}" FontFamily="Consolas" FontSize="11" Padding="8" TextWrapping="Wrap"
                   AutomationProperties.Name="Orchestration log output"/>
      </ScrollViewer>
    </Border>
  </Grid>
</UserControl>
