<Window x:Class="STIGForge.App.OverlayEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="Overlay Editor" Height="640" Width="900" WindowStartupLocation="CenterOwner"
        Background="{DynamicResource WindowBackgroundBrush}" Foreground="{DynamicResource TextPrimaryBrush}">
  <Grid Margin="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
      <TextBlock Text="Overlay Name:" VerticalAlignment="Center"/>
      <TextBox Width="300" Margin="6,0,0,0" Text="{Binding OverlayName}"/>
    </StackPanel>

    <TabControl Grid.Row="1">
      <!-- Control Overrides Tab -->
      <TabItem Header="Control Overrides">
        <Grid Margin="8">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>

          <!-- Rule Selection -->
          <GroupBox Header="Select Rule from Content Packs" Grid.Row="0" Margin="0,0,0,8">
            <Grid Margin="8">
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>

              <ComboBox Grid.Row="0" Grid.Column="0"
                        ItemsSource="{Binding AvailableRules}"
                        SelectedItem="{Binding SelectedRule}"
                        DisplayMemberPath="DisplayText"
                        IsEditable="True"
                        StaysOpenOnEdit="True"
                        Height="28"/>

              <Button Grid.Row="0" Grid.Column="1"
                      Content="Add Override"
                      MinWidth="100" Height="28" Margin="8,0,0,0"
                      Command="{Binding AddControlOverrideCommand}"/>

              <!-- Override Details -->
              <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,8,0,0">
                <TextBlock Text="Status:" VerticalAlignment="Center" Width="60"/>
                <ComboBox Width="140" SelectedIndex="{Binding SelectedRuleStatus}" Height="28">
                  <ComboBoxItem Content="NotApplicable"/>
                  <ComboBoxItem Content="Pass"/>
                  <ComboBoxItem Content="Fail"/>
                  <ComboBoxItem Content="Open"/>
                </ComboBox>

                <TextBlock Text="NA Reason:" VerticalAlignment="Center" Width="90" Margin="20,0,0,0"/>
                <TextBox Width="220" Text="{Binding SelectedRuleReason}"/>

                <TextBlock Text="Notes:" VerticalAlignment="Center" Width="60" Margin="20,0,0,0"/>
                <TextBox Width="220" Text="{Binding SelectedRuleNotes}"/>
              </StackPanel>
            </Grid>
          </GroupBox>

          <!-- Control Overrides List -->
          <ListView Grid.Row="2" ItemsSource="{Binding ControlOverrides}">
            <ListView.View>
              <GridView>
                <GridViewColumn Header="RuleId" DisplayMemberBinding="{Binding RuleId}" Width="140"/>
                <GridViewColumn Header="VulnId" DisplayMemberBinding="{Binding VulnId}" Width="140"/>
                <GridViewColumn Header="Status" DisplayMemberBinding="{Binding StatusOverride}" Width="100"/>
                <GridViewColumn Header="NA Reason" DisplayMemberBinding="{Binding NaReason}" Width="180"/>
                <GridViewColumn Header="Notes" DisplayMemberBinding="{Binding Notes}" Width="180"/>
                <GridViewColumn Header="" Width="60">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <Button Content="Remove" Command="{Binding DataContext.RemoveControlOverrideCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                              CommandParameter="{Binding}" MinWidth="50" Height="22"/>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
              </GridView>
            </ListView.View>
          </ListView>
        </Grid>
      </TabItem>

      <!-- PowerSTIG Overrides Tab (Legacy) -->
      <TabItem Header="PowerSTIG Overrides (Legacy)">
        <StackPanel Margin="8">
          <TextBlock Text="Legacy PowerSTIG mapping overrides. For control status overrides, use the Control Overrides tab."
                     Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,8" TextWrapping="Wrap"/>

          <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
            <TextBlock Text="RuleId:" Width="80" VerticalAlignment="Center"/>
            <TextBox Width="180" Text="{Binding PowerStigRuleId}"/>
            <TextBlock Text="Setting:" Width="70" Margin="10,0,0,0" VerticalAlignment="Center"/>
            <TextBox Width="180" Text="{Binding PowerStigSettingName}"/>
            <TextBlock Text="Value:" Width="60" Margin="10,0,0,0" VerticalAlignment="Center"/>
            <TextBox Width="120" Text="{Binding PowerStigValue}"/>
            <Button Content="Add" MinWidth="60" Height="28" Padding="14,0" Margin="8,0,0,0" Command="{Binding AddPowerStigOverrideCommand}"/>
          </StackPanel>

          <ListView ItemsSource="{Binding PowerStigOverrides}" Height="320">
            <ListView.View>
              <GridView>
                <GridViewColumn Header="RuleId" DisplayMemberBinding="{Binding RuleId}" Width="180"/>
                <GridViewColumn Header="Setting" DisplayMemberBinding="{Binding SettingName}" Width="220"/>
                <GridViewColumn Header="Value" DisplayMemberBinding="{Binding Value}" Width="220"/>
              </GridView>
            </ListView.View>
          </ListView>
        </StackPanel>
      </TabItem>
    </TabControl>

    <!-- Bottom Buttons -->
    <StackPanel Grid.Row="1" VerticalAlignment="Bottom" Margin="0,8,0,0">
      <WrapPanel>
        <Button Content="Import PowerSTIG CSV" MinWidth="140" Height="30" Padding="14,0" Margin="0,0,10,0" Command="{Binding ImportPowerStigCsvCommand}"/>
        <Button Content="Save Overlay" MinWidth="120" Height="30" Padding="14,0" Margin="0,0,10,0" Command="{Binding SaveOverlayCommand}"/>
        <TextBlock Text="{Binding OverlayStatus}" Margin="0,8,0,0" Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Center"/>
      </WrapPanel>
    </StackPanel>
  </Grid>
</Window>
