name: vm-smoke-matrix

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: Build configuration
        required: true
        default: Release
        type: choice
        options:
          - Release
          - Debug

jobs:
  smoke:
    name: smoke-${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: win11
            labels: '["self-hosted","windows","x64","win11"]'
          - name: server2019
            labels: '["self-hosted","windows","x64","server2019"]'
          - name: server2022
            labels: '["self-hosted","windows","x64","server2022"]'
    runs-on: ${{ fromJson(matrix.labels) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Run release gate
        shell: pwsh
        run: ./tools/release/Invoke-ReleaseGate.ps1 -Configuration ${{ inputs.configuration }} -OutputRoot ./.artifacts/release-gate/${{ matrix.name }}

      - name: Evaluate VM stability budget
        shell: pwsh
        run: |
          $outputRoot = '.\.artifacts\stability-budget\${{ matrix.name }}'
          New-Item -ItemType Directory -Force -Path $outputRoot | Out-Null

          $maxAttempts = 1
          $requiredPasses = 1
          $allowedFailures = 0
          $attempts = @()

          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            $logPath = Join-Path $outputRoot ("stability-attempt-{0}.log" -f $attempt)
            Write-Host "[stability-budget] VM ${{ matrix.name }} attempt $attempt/$maxAttempts" -ForegroundColor Cyan

            $runOutput = & dotnet test .\tests\STIGForge.IntegrationTests\STIGForge.IntegrationTests.csproj --configuration ${{ inputs.configuration }} --framework net8.0 --nologo --filter 'FullyQualifiedName~E2E' 2>&1
            $exitCode = $LASTEXITCODE
            $runOutput | Out-File -FilePath $logPath -Encoding UTF8

            $attempts += [pscustomobject]@{
              attempt = $attempt
              exitCode = $exitCode
              succeeded = ($exitCode -eq 0)
              logPath = $logPath
            }
          }

          $passCount = @($attempts | Where-Object { $_.succeeded }).Count
          $failureCount = $maxAttempts - $passCount
          $overallPassed = ($passCount -ge $requiredPasses -and $failureCount -le $allowedFailures)
          $releaseGateSummaryPath = '.\.artifacts\release-gate\${{ matrix.name }}\report\release-gate-summary.json'
          $upgradeRebaseSummaryPath = '.\.artifacts\release-gate\${{ matrix.name }}\upgrade-rebase\upgrade-rebase-summary.json'

          $summaryPath = Join-Path $outputRoot 'stability-budget-summary.json'
          $reportPath = Join-Path $outputRoot 'stability-budget-report.md'

          $summary = [ordered]@{
            generatedAtUtc = (Get-Date).ToUniversalTime().ToString('o')
            suite = 'E2E'
            vm = '${{ matrix.name }}'
            releaseGateSummaryPath = $releaseGateSummaryPath
            upgradeRebaseSummaryPath = $upgradeRebaseSummaryPath
            policy = [ordered]@{
              maxAttempts = $maxAttempts
              requiredPasses = $requiredPasses
              allowedFailures = $allowedFailures
            }
            result = [ordered]@{
              passes = $passCount
              failures = $failureCount
              overallPassed = $overallPassed
            }
            attempts = @($attempts)
          }
          $summary | ConvertTo-Json -Depth 6 | Set-Content -Path $summaryPath -Encoding UTF8

          $report = New-Object System.Text.StringBuilder
          [void]$report.AppendLine('# Stability Budget Report (VM Smoke)')
          [void]$report.AppendLine()
          [void]$report.AppendLine("- VM: ${{ matrix.name }}")
          [void]$report.AppendLine("- Suite: E2E")
          [void]$report.AppendLine("- Attempts: $maxAttempts")
          [void]$report.AppendLine("- Required passes: $requiredPasses")
          [void]$report.AppendLine("- Allowed failures: $allowedFailures")
          [void]$report.AppendLine("- Result: $(if ($overallPassed) { 'PASS' } else { 'FAIL' })")
          [void]$report.AppendLine("- Passes: $passCount")
          [void]$report.AppendLine("- Failures: $failureCount")
          [void]$report.AppendLine("- Release gate summary: $releaseGateSummaryPath")
          [void]$report.AppendLine("- Upgrade/rebase summary: $upgradeRebaseSummaryPath")
          [void]$report.AppendLine()
          [void]$report.AppendLine('## Attempts')
          [void]$report.AppendLine()
          [void]$report.AppendLine('| Attempt | Status | Exit Code | Log |')
          [void]$report.AppendLine('|---------|--------|-----------|-----|')
          foreach ($attempt in $attempts) {
            $status = if ($attempt.succeeded) { 'PASS' } else { 'FAIL' }
            [void]$report.AppendLine("| $($attempt.attempt) | $status | $($attempt.exitCode) | $($attempt.logPath) |")
          }
          Set-Content -Path $reportPath -Value $report.ToString() -Encoding UTF8

          if (-not $overallPassed) {
            throw "VM stability budget failed on ${{ matrix.name }}: passes=$passCount required=$requiredPasses"
          }

      - name: Validate VM stability trend artifacts
        shell: pwsh
        run: |
          $summaryPath = '.\.artifacts\stability-budget\${{ matrix.name }}\stability-budget-summary.json'
          $reportPath = '.\.artifacts\stability-budget\${{ matrix.name }}\stability-budget-report.md'

          if (-not (Test-Path -LiteralPath $summaryPath)) {
            throw "VM stability summary missing for ${{ matrix.name }} at $summaryPath"
          }

          if (-not (Test-Path -LiteralPath $reportPath)) {
            throw "VM stability report missing for ${{ matrix.name }} at $reportPath"
          }

          $summary = Get-Content -Path $summaryPath -Raw | ConvertFrom-Json
          if (-not [bool]$summary.result.overallPassed) {
            throw "VM stability summary indicates failure for ${{ matrix.name }}."
          }

          Write-Host "VM stability trend artifacts validated for ${{ matrix.name }}." -ForegroundColor Green

      - name: Enforce mandatory release evidence contract
        shell: pwsh
        run: |
          .\tools\release\Test-ReleaseEvidenceContract.ps1 `
            -EvidenceRoot '.\.artifacts\release-gate\${{ matrix.name }}' `
            -AdditionalRequiredArtifacts @(
              '..\..\stability-budget\${{ matrix.name }}\stability-budget-summary.json',
              '..\..\stability-budget\${{ matrix.name }}\stability-budget-report.md'
            ) `
            -RecoveryCommand 'powershell -NoProfile -ExecutionPolicy Bypass -File .\tools\release\Invoke-ReleaseGate.ps1 -Configuration Release -OutputRoot .\.artifacts\release-gate\${{ matrix.name }}'

      - name: Upload VM smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vm-smoke-${{ matrix.name }}-${{ github.run_id }}
          path: |
            ./.artifacts/release-gate/${{ matrix.name }}
            ./.artifacts/stability-budget/${{ matrix.name }}
          if-no-files-found: error

  go-no-go:
    name: go-no-go
    needs: smoke
    runs-on: ubuntu-latest
    steps:
      - name: Promotion decision
        run: |
          echo "All VM smoke jobs passed. Candidate is eligible for promotion."
