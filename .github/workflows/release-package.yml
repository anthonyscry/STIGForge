name: release-package

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: Build configuration
        required: true
        default: Release
        type: choice
        options:
          - Release
          - Debug
      runtime:
        description: Runtime identifier
        required: true
        default: win-x64
        type: string
      version_tag:
        description: Optional version tag for manifest metadata
        required: false
        default: ""
        type: string
      run_release_gate:
        description: Run release gate before packaging
        required: true
        default: true
        type: boolean
      run_quarterly_pack:
        description: Run quarterly compatibility regression pack during release gate
        required: true
        default: true
        type: boolean
      security_strict_mode:
        description: Block unresolved security findings in strict mode
        required: true
        default: false
        type: boolean
      require_signing:
        description: Require signing with STIGFORGE_SIGN_CERT_* secrets
        required: true
        default: false
        type: boolean

jobs:
  package:
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      STIGFORGE_SIGN_CERT_BASE64: ${{ secrets.STIGFORGE_SIGN_CERT_BASE64 }}
      STIGFORGE_SIGN_CERT_PASSWORD: ${{ secrets.STIGFORGE_SIGN_CERT_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Pre-package release gate
        if: ${{ inputs.run_release_gate }}
        shell: pwsh
        run: |
          $args = @(
            '-NoProfile',
            '-ExecutionPolicy', 'Bypass',
            '-File', '.\tools\release\Invoke-ReleaseGate.ps1',
            '-Configuration', '${{ inputs.configuration }}',
            '-OutputRoot', '.\.artifacts\release-gate\release-package'
          )

          if ([System.Convert]::ToBoolean('${{ inputs.security_strict_mode }}')) {
            $args += '-SecurityStrict'
          }
          if (-not [System.Convert]::ToBoolean('${{ inputs.run_quarterly_pack }}')) {
            $args += '-SkipQuarterlyRegressionPack'
          }

          powershell @args

      - name: Validate upgrade/rebase evidence
        if: ${{ inputs.run_release_gate }}
        shell: pwsh
        run: |
          $summaryPath = '.\.artifacts\release-gate\release-package\upgrade-rebase\upgrade-rebase-summary.json'
          if (-not (Test-Path -LiteralPath $summaryPath)) {
            throw "Upgrade/rebase summary artifact missing at $summaryPath"
          }

          $summary = Get-Content -Path $summaryPath -Raw | ConvertFrom-Json
          if ($summary.status -ne 'passed') {
            throw "Upgrade/rebase validation status is '$($summary.status)': $($summary.message)"
          }

          $requiredStages = @(
            [pscustomobject]@{ name = 'upgrade-rebase-diff-contract'; requirement = 'WP-01' }
            [pscustomobject]@{ name = 'upgrade-rebase-overlay-contract'; requirement = 'WP-01' }
            [pscustomobject]@{ name = 'upgrade-rebase-parity-contract'; requirement = 'WP-02' }
            [pscustomobject]@{ name = 'upgrade-rebase-cli-contract'; requirement = 'WP-01' }
            [pscustomobject]@{ name = 'upgrade-rebase-rollback-safety'; requirement = 'WP-03' }
          )

          foreach ($stage in $requiredStages) {
            $stageStep = @($summary.steps | Where-Object { $_.name -eq $stage.name })
            if ($stageStep.Count -ne 1) {
              throw "Required stage '$($stage.name)' ($($stage.requirement)) evidence step missing from upgrade/rebase summary."
            }

            if (-not [bool]$stageStep[0].succeeded) {
              $logDetail = if ([string]::IsNullOrWhiteSpace($stageStep[0].logPath)) { '' } else { " See log: $($stageStep[0].logPath)" }
              throw "Required stage '$($stage.name)' ($($stage.requirement)) evidence failed.$logDetail"
            }
          }

          Write-Host "All required upgrade/rebase contract stages validated for release package." -ForegroundColor Green

      - name: Report mutation policy
        if: ${{ inputs.run_release_gate }}
        shell: pwsh
        run: |
          $resultPath = '.\.artifacts\mutation\current-result.json'
          if (-not (Test-Path -LiteralPath $resultPath)) {
            Write-Host "[mutation-policy] Skipping mutation policy: result file missing at $resultPath"
          }
          else {
            $mutationArgs = @(
              '-NoProfile',
              '-ExecutionPolicy', 'Bypass',
              '-File', '.\tools\release\Invoke-MutationPolicy.ps1',
              '-CurrentResultPath', $resultPath,
              '-PolicyPath', '.\tools\release\mutation-policy.json'
            )
            powershell @mutationArgs
          }

      - name: Validate quarterly trend evidence
        if: ${{ inputs.run_release_gate && inputs.run_quarterly_pack }}
        shell: pwsh
        run: |
          $summaryPath = '.\.artifacts\release-gate\release-package\quarterly-pack\quarterly-pack-summary.json'
          $reportPath = '.\.artifacts\release-gate\release-package\quarterly-pack\quarterly-pack-report.md'

          if (-not (Test-Path -LiteralPath $summaryPath)) {
            throw "Quarterly trend summary artifact missing at $summaryPath"
          }

          if (-not (Test-Path -LiteralPath $reportPath)) {
            throw "Quarterly trend report artifact missing at $reportPath"
          }

          $summary = Get-Content -Path $summaryPath -Raw | ConvertFrom-Json
          if (-not [bool]$summary.overallPassed) {
            throw "Quarterly trend summary indicates failure: decision=$($summary.decision)"
          }

          if ($summary.decision -ne 'pass') {
            throw "Quarterly trend decision is '$($summary.decision)' (expected 'pass')."
          }

          Write-Host "Quarterly trend evidence validated for release package. Fixtures: pass=$($summary.fixtures.passed) warning=$($summary.fixtures.warnings) fail=$($summary.fixtures.failed)" -ForegroundColor Green

      - name: Build release packages
        shell: pwsh
        run: |
          $args = @(
            '-ExecutionPolicy', 'Bypass',
            '-File', '.\tools\release\Invoke-PackageBuild.ps1',
            '-Configuration', '${{ inputs.configuration }}',
            '-Runtime', '${{ inputs.runtime }}',
            '-OutputRoot', '.\.artifacts\release-package\latest',
            '-ReleaseGateRoot', '.\.artifacts\release-gate\release-package',
            '-VersionTag', '${{ inputs.version_tag }}'
          )

          if ([System.Convert]::ToBoolean('${{ inputs.require_signing }}')) {
            $args += '-RequireSigning'
          }

          powershell @args

      - name: Upload package artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-package-${{ github.run_id }}
          path: ./.artifacts/release-package/latest
          if-no-files-found: error

      - name: Upload release gate artifacts
        if: always() && inputs.run_release_gate
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-release-package-${{ github.run_id }}
          path: ./.artifacts/release-gate/release-package
          if-no-files-found: warn
