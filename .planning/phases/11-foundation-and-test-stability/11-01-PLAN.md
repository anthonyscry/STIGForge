---
phase: 11-foundation-and-test-stability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/STIGForge.UnitTests/Cli/CliHostFactoryTests.cs
  - tests/STIGForge.UnitTests/TestCategories.cs
  - tests/STIGForge.IntegrationTests/TestCategories.cs
autonomous: true
requirements:
  - TEST-01
  - TEST-05

must_haves:
  truths:
    - "The BuildHost_UsesConfiguredPathBuilderForSerilogLogDirectory test passes consistently without flaky failures"
    - "Tests can be filtered by category using dotnet test --filter 'Category=Unit' or 'Category=Integration'"
  artifacts:
    - path: "tests/STIGForge.UnitTests/Cli/CliHostFactoryTests.cs"
      provides: "Fixed flaky test with proper async disposal"
      contains: "IAsyncLifetime"
    - path: "tests/STIGForge.UnitTests/TestCategories.cs"
      provides: "Trait constants for unit test categorization"
      exports: ["TestCategories"]
    - path: "tests/STIGForge.IntegrationTests/TestCategories.cs"
      provides: "Trait constants for integration test categorization"
      exports: ["TestCategories"]
  key_links:
    - from: "CliHostFactoryTests.cs"
      to: "IAsyncLifetime"
      via: "class declaration implementing interface"
      pattern: ": IAsyncLifetime"
    - from: "TestCategories.cs"
      to: "Test methods"
      via: "[Trait(\"Category\", TestCategories.Unit)]"
      pattern: "\\[Trait\\(\"Category\""
---

<objective>
Fix the flaky BuildHost test and establish test categorization infrastructure.

Purpose: The flaky test is a blocker for CI coverage enforcement. Test categorization enables faster feedback by running unit tests separately from slower integration tests.

Output: Stable async test disposal pattern, reusable trait constants for both test projects.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation-and-test-stability/11-RESEARCH.md
@.planning/codebase/TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix flaky BuildHost test with IAsyncLifetime</name>
  <files>tests/STIGForge.UnitTests/Cli/CliHostFactoryTests.cs</files>
  <action>
    Convert CliHostFactoryTests from IDisposable to IAsyncLifetime to fix the async disposal race condition.

    The flaky test `BuildHost_UsesConfiguredPathBuilderForSerilogLogDirectory` fails intermittently because:
    1. IDisposable.Dispose() is synchronous but host shutdown is async
    2. Serilog file sink may still be writing when Directory.Delete runs
    3. This causes "directory not empty" or "file in use" errors

    Changes required:
    1. Change class declaration from `IDisposable` to `IAsyncLifetime`
    2. Remove the `Dispose()` method
    3. Add `InitializeAsync()` method (can be empty or just return Task.CompletedTask)
    4. Add `DisposeAsync()` method that:
       - Stores the host as a field `_host` (nullable IHost)
       - Awaits `_host?.StopAsync()` if host exists
       - Disposes the host
       - Adds a small delay (50ms) for file handle release
       - Then deletes the temp directory

    Reference the IAsyncLifetime pattern from RESEARCH.md Pattern 1.

    Do NOT use synchronous disposal for tests that involve IHost or file I/O - the race condition is the root cause of flakiness.
  </action>
  <verify>
    Run the test 10 times to verify consistency:
    ```bash
    for i in {1..10}; do dotnet test tests/STIGForge.UnitTests --filter "BuildHost_UsesConfiguredPathBuilderForSerilogLogDirectory" --no-build; done
    ```
    All 10 runs must pass.
  </verify>
  <done>
    The test class implements IAsyncLifetime, properly awaits host shutdown before directory cleanup, and passes consistently across 10 consecutive runs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TestCategories constants for unit tests</name>
  <files>tests/STIGForge.UnitTests/TestCategories.cs</files>
  <action>
    Create a static class with trait category constants for consistent test categorization across the unit test project.

    Create file at `tests/STIGForge.UnitTests/TestCategories.cs`:
    ```csharp
    namespace STIGForge.UnitTests;

    /// <summary>
    /// Standard test category constants for xUnit trait filtering.
    /// </summary>
    public static class TestCategories
    {
        /// <summary>
        /// Fast, isolated tests with no external dependencies.
        /// </summary>
        public const string Unit = "Unit";

        /// <summary>
        /// Slower tests with real infrastructure (files, database, processes).
        /// </summary>
        public const string Integration = "Integration";

        /// <summary>
        /// Tests that take more than 5 seconds to execute.
        /// </summary>
        public const string Slow = "Slow";
    }
    ```

    This follows the xUnit trait pattern from RESEARCH.md Pattern 2. Do NOT use custom attributes or naming conventions - standard [Trait("Category", "...")] is supported by IDE and CI tooling.
  </action>
  <verify>
    ```bash
    dotnet build tests/STIGForge.UnitTests
    ```
    Build must succeed with no errors.
  </verify>
  <done>
    TestCategories.cs exists with Unit, Integration, and Slow constants accessible from all unit tests.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TestCategories constants for integration tests</name>
  <files>tests/STIGForge.IntegrationTests/TestCategories.cs</files>
  <action>
    Create the same TestCategories static class in the integration test project for consistency.

    Create file at `tests/STIGForge.IntegrationTests/TestCategories.cs`:
    ```csharp
    namespace STIGForge.IntegrationTests;

    /// <summary>
    /// Standard test category constants for xUnit trait filtering.
    /// </summary>
    public static class TestCategories
    {
        /// <summary>
        /// Fast, isolated tests with no external dependencies.
        /// </summary>
        public const string Unit = "Unit";

        /// <summary>
        /// Slower tests with real infrastructure (files, database, processes).
        /// </summary>
        public const string Integration = "Integration";

        /// <summary>
        /// Tests that take more than 5 seconds to execute.
        /// </summary>
        public const string Slow = "Slow";
    }
    ```

    Duplicate the constants in each test project (rather than a shared project) to avoid adding a shared test utility dependency. The namespace differs per project but the values match for consistent filtering.
  </action>
  <verify>
    ```bash
    dotnet build tests/STIGForge.IntegrationTests
    ```
    Build must succeed with no errors.
  </verify>
  <done>
    TestCategories.cs exists in both test projects with matching constant values for consistent trait filtering.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add trait attributes to existing tests</name>
  <files>tests/STIGForge.UnitTests/SmokeTests.cs</files>
  <action>
    Add [Trait("Category", TestCategories.Unit)] to existing smoke tests as a demonstration of the categorization pattern.

    In `tests/STIGForge.UnitTests/SmokeTests.cs`:
    1. Add `using static STIGForge.UnitTests.TestCategories;` at the top
    2. Add `[Trait("Category", Unit)]` attribute to each [Fact] method

    This establishes the pattern for other developers to follow. Do NOT add traits to every existing test file in this plan - that would be too large. Just establish the pattern in SmokeTests.cs as a template.
  </action>
  <verify>
    ```bash
    dotnet test tests/STIGForge.UnitTests --filter "Category=Unit" --list-tests
    ```
    Should list the smoke tests with the Unit category.
  </verify>
  <done>
    SmokeTests.cs has trait attributes using the TestCategories constants, demonstrating the categorization pattern for future test development.
  </done>
</task>

</tasks>

<verification>
1. Run the flaky test 10 times - all must pass
2. Run `dotnet test --filter "Category=Unit"` - smoke tests should be included
3. Run `dotnet test --filter "Category=Integration"` - smoke tests should NOT be included
4. Both test projects build successfully
</verification>

<success_criteria>
- BuildHost_UsesConfiguredPathBuilderForSerilogLogDirectory passes 10/10 consecutive runs
- TestCategories class exists in both unit and integration test projects
- Category filtering works via `dotnet test --filter "Category=Unit"`
- SmokeTests.cs demonstrates the trait attribute pattern
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-and-test-stability/11-01-SUMMARY.md`
</output>
