---
phase: 11-foundation-and-test-stability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Infrastructure/Logging/CorrelationIdEnricher.cs
  - src/STIGForge.Infrastructure/Logging/LoggingConfiguration.cs
autonomous: true
requirements:
  - OBSV-01
  - OBSV-04

must_haves:
  truths:
    - "Log events contain TraceId or CorrelationId property for trace correlation"
    - "Log level can be changed via STIGFORGE_LOG_LEVEL environment variable"
    - "Log level changes take effect at startup without code modifications"
  artifacts:
    - path: "src/STIGForge.Infrastructure/Logging/CorrelationIdEnricher.cs"
      provides: "Serilog enricher adding TraceId/SpanId from Activity.Current"
      exports: ["CorrelationIdEnricher"]
    - path: "src/STIGForge.Infrastructure/Logging/LoggingConfiguration.cs"
      provides: "LoggingLevelSwitch with environment-based configuration"
      exports: ["LoggingConfiguration", "LevelSwitch"]
  key_links:
    - from: "CorrelationIdEnricher"
      to: "Activity.Current"
      via: "Activity.Current?.TraceId"
      pattern: "Activity\\.Current"
    - from: "LoggingConfiguration"
      to: "Environment.GetEnvironmentVariable"
      via: "STIGFORGE_LOG_LEVEL"
      pattern: "STIGFORGE_LOG_LEVEL"
---

<objective>
Create Serilog enricher for correlation IDs and configurable log level infrastructure.

Purpose: Correlation IDs enable tracing operations across log events. Configurable log levels allow debug verbosity in development without code changes.

Output: Reusable logging infrastructure that can be wired into CLI and WPF hosts.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation-and-test-stability/11-RESEARCH.md
@.planning/codebase/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CorrelationIdEnricher</name>
  <files>src/STIGForge.Infrastructure/Logging/CorrelationIdEnricher.cs</files>
  <action>
    Create a Serilog ILogEventEnricher that adds TraceId/SpanId from Activity.Current, with fallback to a generated CorrelationId when no Activity context exists.

    Create directory `src/STIGForge.Infrastructure/Logging/` if it does not exist.

    Create file `src/STIGForge.Infrastructure/Logging/CorrelationIdEnricher.cs`:
    ```csharp
    using System.Diagnostics;
    using Serilog.Core;
    using Serilog.Events;

    namespace STIGForge.Infrastructure.Logging;

    /// <summary>
    /// Serilog enricher that adds correlation IDs to log events.
    /// Uses Activity.Current for W3C trace context when available,
    /// falling back to a generated CorrelationId otherwise.
    /// </summary>
    public sealed class CorrelationIdEnricher : ILogEventEnricher
    {
        public void Enrich(LogEvent logEvent, ILogEventPropertyFactory propertyFactory)
        {
            ArgumentNullException.ThrowIfNull(logEvent);
            ArgumentNullException.ThrowIfNull(propertyFactory);

            var activity = Activity.Current;

            if (activity != null)
            {
                // Add TraceId for distributed correlation (W3C standard)
                logEvent.AddPropertyIfAbsent(propertyFactory.CreateProperty(
                    "TraceId", activity.TraceId.ToString()));

                // Add SpanId for hierarchical correlation
                logEvent.AddPropertyIfAbsent(propertyFactory.CreateProperty(
                    "SpanId", activity.SpanId.ToString()));
            }
            else
            {
                // Generate correlation ID if no Activity context exists
                // This ensures every log has some form of correlation identifier
                var correlationId = Guid.NewGuid().ToString("N");
                logEvent.AddPropertyIfAbsent(propertyFactory.CreateProperty(
                    "CorrelationId", correlationId));
            }
        }
    }
    ```

    This follows RESEARCH.md Pattern 3. Use Activity.Current (built-in .NET) rather than custom correlation services - it is W3C trace context compatible and OpenTelemetry compatible.
  </action>
  <verify>
    ```bash
    dotnet build src/STIGForge.Infrastructure/STIGForge.Infrastructure.csproj
    ```
    Build must succeed with no errors.
  </verify>
  <done>
    CorrelationIdEnricher class exists, implements ILogEventEnricher, and adds TraceId/SpanId or CorrelationId to all log events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LoggingConfiguration helper</name>
  <files>src/STIGForge.Infrastructure/Logging/LoggingConfiguration.cs</files>
  <action>
    Create a static helper class that provides a shared LoggingLevelSwitch and environment-based log level configuration.

    Create file `src/STIGForge.Infrastructure/Logging/LoggingConfiguration.cs`:
    ```csharp
    using Serilog;
    using Serilog.Events;

    namespace STIGForge.Infrastructure.Logging;

    /// <summary>
    /// Centralized logging configuration for STIGForge.
    /// Provides a shared LoggingLevelSwitch for runtime log level control
    /// and environment-based configuration.
    /// </summary>
    public static class LoggingConfiguration
    {
        /// <summary>
        /// Shared logging level switch that can be modified at runtime.
        /// Initialized to Information level by default.
        /// </summary>
        public static LoggingLevelSwitch LevelSwitch { get; } = new(LogEventLevel.Information);

        /// <summary>
        /// Configures the logging level switch from the STIGFORGE_LOG_LEVEL environment variable.
        /// Valid values: Debug, Verbose, Warning, Error, Information (default).
        /// </summary>
        public static void ConfigureFromEnvironment()
        {
            var levelValue = Environment.GetEnvironmentVariable("STIGFORGE_LOG_LEVEL");

            var level = levelValue?.ToLowerInvariant() switch
            {
                "debug" => LogEventLevel.Debug,
                "verbose" => LogEventLevel.Verbose,
                "warning" => LogEventLevel.Warning,
                "error" => LogEventLevel.Error,
                "information" => LogEventLevel.Information,
                null or "" => LogEventLevel.Information,
                _ => LogEventLevel.Information // Unknown values default to Information
            };

            LevelSwitch.MinimumLevel = level;
        }

        /// <summary>
        /// Gets the current log level name for diagnostic output.
        /// </summary>
        public static string CurrentLevelName => LevelSwitch.MinimumLevel.ToString();
    }
    ```

    This follows RESEARCH.md Pattern 4. Use environment variable STIGFORGE_LOG_LEVEL for configuration - this works for both CLI (set before running) and WPF (set in system environment).
  </action>
  <verify>
    ```bash
    dotnet build src/STIGForge.Infrastructure/STIGForge.Infrastructure.csproj
    ```
    Build must succeed with no errors.
  </verify>
  <done>
    LoggingConfiguration class exists with shared LevelSwitch, ConfigureFromEnvironment() method, and CurrentLevelName property.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for logging infrastructure</name>
  <files>tests/STIGForge.UnitTests/Infrastructure/Logging/CorrelationIdEnricherTests.cs</files>
  <action>
    Create unit tests for the CorrelationIdEnricher to verify correlation ID behavior.

    Create directory `tests/STIGForge.UnitTests/Infrastructure/Logging/` if it does not exist.

    Create file `tests/STIGForge.UnitTests/Infrastructure/Logging/CorrelationIdEnricherTests.cs`:
    ```csharp
    using System.Diagnostics;
    using FluentAssertions;
    using Serilog.Core;
    using Serilog.Events;
    using STIGForge.Infrastructure.Logging;
    using Xunit;

    namespace STIGForge.UnitTests.Infrastructure.Logging;

    public class CorrelationIdEnricherTests
    {
        [Fact]
        public void Enrich_WhenActivityExists_AddsTraceIdAndSpanId()
        {
            // Arrange
            using var activity = new Activity("TestActivity");
            activity.Start();

            var enricher = new CorrelationIdEnricher();
            var logEvent = CreateLogEvent();
            var propertyFactory = new SimplePropertyFactory();

            // Act
            enricher.Enrich(logEvent, propertyFactory);

            // Assert
            logEvent.Properties.Should().ContainKey("TraceId");
            logEvent.Properties.Should().ContainKey("SpanId");
            logEvent.Properties.Should().NotContainKey("CorrelationId");
        }

        [Fact]
        public void Enrich_WhenNoActivity_AddsCorrelationId()
        {
            // Arrange
            // Ensure no activity is current
            Activity.Current = null;

            var enricher = new CorrelationIdEnricher();
            var logEvent = CreateLogEvent();
            var propertyFactory = new SimplePropertyFactory();

            // Act
            enricher.Enrich(logEvent, propertyFactory);

            // Assert
            logEvent.Properties.Should().ContainKey("CorrelationId");
            logEvent.Properties.Should().NotContainKey("TraceId");
            logEvent.Properties.Should().NotContainKey("SpanId");
        }

        private static LogEvent CreateLogEvent()
        {
            return new LogEvent(
                DateTimeOffset.UtcNow,
                LogEventLevel.Information,
                null,
                new MessageTemplate(new[] { new TextToken("Test") }),
                Array.Empty<LogEventProperty>());
        }

        private sealed class SimplePropertyFactory : ILogEventPropertyFactory
        {
            public LogEventProperty CreateProperty(string name, object? value, bool destructureObjects = false)
            {
                return new LogEventProperty(name, new ScalarValue(value));
            }
        }
    }
    ```
  </action>
  <verify>
    ```bash
    dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~CorrelationIdEnricherTests"
    ```
    All tests must pass.
  </verify>
  <done>
    CorrelationIdEnricherTests exist and pass, verifying that TraceId/SpanId are added when Activity exists and CorrelationId is added when no Activity.
  </done>
</task>

</tasks>

<verification>
1. Infrastructure project builds successfully
2. CorrelationIdEnricher unit tests pass
3. LoggingConfiguration.LevelSwitch is accessible
4. Environment variable STIGFORGE_LOG_LEVEL can be read
</verification>

<success_criteria>
- CorrelationIdEnricher adds TraceId/SpanId when Activity.Current exists
- CorrelationIdEnricher adds CorrelationId when no Activity context
- LoggingConfiguration.LevelSwitch provides shared switch instance
- LoggingConfiguration.ConfigureFromEnvironment() reads STIGFORGE_LOG_LEVEL
- Unit tests verify correlation ID behavior
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-and-test-stability/11-02-SUMMARY.md`
</output>
