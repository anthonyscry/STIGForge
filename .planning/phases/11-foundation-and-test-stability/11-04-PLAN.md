---
phase: 11-foundation-and-test-stability
plan: 04
type: execute
wave: 2
depends_on:
  - 11-02
files_modified:
  - src/STIGForge.Cli/CliHostFactory.cs
  - src/STIGForge.App/App.xaml.cs
autonomous: true
requirements:
  - OBSV-01
  - OBSV-04

must_haves:
  truths:
    - "CLI and WPF hosts register CorrelationIdEnricher with Serilog"
    - "CLI and WPF hosts use LoggingLevelSwitch for configurable verbosity"
    - "Log output templates include TraceId for correlation"
  artifacts:
    - path: "src/STIGForge.Cli/CliHostFactory.cs"
      provides: "CLI host with correlation enricher and level switch"
      contains: "CorrelationIdEnricher"
    - path: "src/STIGForge.App/App.xaml.cs"
      provides: "WPF host with correlation enricher and level switch"
      contains: "CorrelationIdEnricher"
  key_links:
    - from: "CliHostFactory.cs"
      to: "CorrelationIdEnricher"
      via: ".Enrich.With(new CorrelationIdEnricher())"
      pattern: "CorrelationIdEnricher"
    - from: "App.xaml.cs"
      to: "LoggingConfiguration.LevelSwitch"
      via: ".MinimumLevel.ControlledBy"
      pattern: "LoggingConfiguration\\.LevelSwitch"
---

<objective>
Wire correlation enricher and configurable logging into CLI and WPF hosts.

Purpose: This integrates the infrastructure from plan 02 into the actual application hosts, enabling correlation IDs and configurable log levels in production.

Output: Both hosts produce correlated, configurable logs.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation-and-test-stability/11-RESEARCH.md
@.planning/codebase/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire logging infrastructure into CLI host</name>
  <files>src/STIGForge.Cli/CliHostFactory.cs</files>
  <action>
    Update CliHostFactory.BuildHost to use the CorrelationIdEnricher and LoggingConfiguration from plan 02.

    In `src/STIGForge.Cli/CliHostFactory.cs`:
    1. Add using statement: `using STIGForge.Infrastructure.Logging;`
    2. In the UseSerilog callback (around line 30), replace:
       ```csharp
       .UseSerilog((_, lc) =>
       {
           var root = pathBuilderFactory().GetLogsRoot();
           Directory.CreateDirectory(root);
           lc.MinimumLevel.Information()
             .WriteTo.File(Path.Combine(root, "stigforge-cli.log"), rollingInterval: RollingInterval.Day);
       })
       ```
       With:
       ```csharp
       .UseSerilog((_, lc) =>
       {
           LoggingConfiguration.ConfigureFromEnvironment();

           var root = pathBuilderFactory().GetLogsRoot();
           Directory.CreateDirectory(root);

           lc.MinimumLevel.ControlledBy(LoggingConfiguration.LevelSwitch)
             .Enrich.With(new CorrelationIdEnricher())
             .Enrich.FromLogContext()
             .WriteTo.File(
                 Path.Combine(root, "stigforge-cli.log"),
                 rollingInterval: RollingInterval.Day,
                 outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] [{TraceId}] {Message:lj}{NewLine}{Exception}");
       })
       ```

    Key changes:
    - Call LoggingConfiguration.ConfigureFromEnvironment() to read STIGFORGE_LOG_LEVEL
    - Use .MinimumLevel.ControlledBy(LoggingConfiguration.LevelSwitch) for runtime control
    - Add .Enrich.With(new CorrelationIdEnricher()) for correlation IDs
    - Add .Enrich.FromLogContext() for context-based enrichment
    - Update outputTemplate to include [{TraceId}] for correlation

    Do NOT remove the existing pathBuilderFactory pattern - it is needed for test isolation.
  </action>
  <verify>
    ```bash
    dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj
    ```
    Build must succeed with no errors.
  </verify>
  <done>
    CliHostFactory uses CorrelationIdEnricher and LoggingConfiguration, with outputTemplate including TraceId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire logging infrastructure into WPF host</name>
  <files>src/STIGForge.App/App.xaml.cs</files>
  <action>
    Update the WPF App.xaml.cs to use the CorrelationIdEnricher and LoggingConfiguration from plan 02.

    In `src/STIGForge.App/App.xaml.cs`:
    1. Add using statement: `using STIGForge.Infrastructure.Logging;` (around line 16)
    2. In the UseSerilog callback (around line 36), replace:
       ```csharp
       .UseSerilog((ctx, lc) =>
       {
           lc.MinimumLevel.Information()
             .WriteTo.File(Path.Combine(
                 Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData),
                 "STIGForge", "logs", "stigforge.log"),
                 rollingInterval: RollingInterval.Day);
       })
       ```
       With:
       ```csharp
       .UseSerilog((ctx, lc) =>
       {
           LoggingConfiguration.ConfigureFromEnvironment();

           var logRoot = Path.Combine(
               Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData),
               "STIGForge", "logs");
           Directory.CreateDirectory(logRoot);

           lc.MinimumLevel.ControlledBy(LoggingConfiguration.LevelSwitch)
             .Enrich.With(new CorrelationIdEnricher())
             .Enrich.FromLogContext()
             .WriteTo.File(
                 Path.Combine(logRoot, "stigforge.log"),
                 rollingInterval: RollingInterval.Day,
                 outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] [{TraceId}] {Message:lj}{NewLine}{Exception}");
       })
       ```

    Key changes:
    - Call LoggingConfiguration.ConfigureFromEnvironment() to read STIGFORGE_LOG_LEVEL
    - Extract logRoot variable and ensure Directory.CreateDirectory for robustness
    - Use .MinimumLevel.ControlledBy(LoggingConfiguration.LevelSwitch) for runtime control
    - Add .Enrich.With(new CorrelationIdEnricher()) for correlation IDs
    - Add .Enrich.FromLogContext() for context-based enrichment
    - Update outputTemplate to include [{TraceId}] for correlation

    Preserve the existing log path (CommonApplicationData/STIGForge/logs) - this is where production logs are written.
  </action>
  <verify>
    ```bash
    dotnet build src/STIGForge.App/STIGForge.App.csproj
    ```
    Build must succeed with no errors.
  </verify>
  <done>
    App.xaml.cs uses CorrelationIdEnricher and LoggingConfiguration, with outputTemplate including TraceId.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify correlation and configuration work end-to-end</name>
  <files>tests/STIGForge.UnitTests/Cli/CliHostFactoryTests.cs</files>
  <action>
    Update the CliHostFactoryTests to verify that logs contain correlation IDs.

    Add a new test method to verify correlation (add after the existing tests):
    ```csharp
    [Fact]
    [Trait("Category", TestCategories.Integration)]
    public async Task BuildHost_LogContainsCorrelationId()
    {
        using var host = CliHostFactory.BuildHost(() => new TestPathBuilder(_tempRoot));

        await host.StartAsync();

        // Create a scope that logs something
        var logger = host.Services.GetRequiredService<ILogger<CliHostFactoryTests>>();
        logger.LogInformation("Test log message with correlation");

        await host.StopAsync();

        var logsRoot = Path.Combine(_tempRoot, "logs");
        var logFiles = Directory.GetFiles(logsRoot, "stigforge-cli*.log", SearchOption.TopDirectoryOnly);
        logFiles.Should().NotBeEmpty();

        var logContent = await File.ReadAllTextAsync(logFiles[0]);
        // Log should contain either TraceId (if Activity started) or CorrelationId
        // Both are 32-char hex strings (GUID without dashes)
        logContent.Should().MatchRegex(@"\[[a-f0-9]{32}\]", "log should contain correlation ID");
    }
    ```

    Also add the using statement at the top:
    ```csharp
    using static STIGForge.UnitTests.TestCategories;
    ```

    And add:
    ```csharp
    using Microsoft.Extensions.Logging;
    ```

    Verify the BuildHost_UsesConfiguredPathBuilderForSerilogLogDirectory test still passes with the updated configuration.
  </action>
  <verify>
    ```bash
    dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~CliHostFactoryTests"
    ```
    All tests must pass.
  </verify>
  <done>
    CliHostFactoryTests include verification that logs contain correlation IDs, and all existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify log level configuration works</name>
  <files>tests/STIGForge.UnitTests/Infrastructure/Logging/LoggingConfigurationTests.cs</files>
  <action>
    Create unit tests to verify the log level configuration behavior.

    Create directory if needed: `tests/STIGForge.UnitTests/Infrastructure/Logging/`

    Create file `tests/STIGForge.UnitTests/Infrastructure/Logging/LoggingConfigurationTests.cs`:
    ```csharp
    using FluentAssertions;
    using Serilog.Events;
    using STIGForge.Infrastructure.Logging;
    using Xunit;

    namespace STIGForge.UnitTests.Infrastructure.Logging;

    public class LoggingConfigurationTests
    {
        [Fact]
        public void Level_Should_Default_To_Information()
        {
            // Note: This test may be affected by other tests that change the level
            // In a real test suite, you might reset the level before each test
            LoggingConfiguration.LevelSwitch.MinimumLevel.Should().BeOneOf(
                LogEventLevel.Information,
                LogEventLevel.Debug,
                LogEventLevel.Warning,
                LogEventLevel.Error,
                LogEventLevel.Verbose);
        }

        [Fact]
        public void ConfigureFromEnvironment_Should_Set_Debug_Level()
        {
            // Arrange
            var originalValue = Environment.GetEnvironmentVariable("STIGFORGE_LOG_LEVEL");
            try
            {
                Environment.SetEnvironmentVariable("STIGFORGE_LOG_LEVEL", "Debug");

                // Act
                LoggingConfiguration.ConfigureFromEnvironment();

                // Assert
                LoggingConfiguration.LevelSwitch.MinimumLevel.Should().Be(LogEventLevel.Debug);
            }
            finally
            {
                Environment.SetEnvironmentVariable("STIGFORGE_LOG_LEVEL", originalValue);
                LoggingConfiguration.ConfigureFromEnvironment(); // Reset to original
            }
        }

        [Theory]
        [InlineData("debug", LogEventLevel.Debug)]
        [InlineData("DEBUG", LogEventLevel.Debug)]
        [InlineData("verbose", LogEventLevel.Verbose)]
        [InlineData("warning", LogEventLevel.Warning)]
        [InlineData("error", LogEventLevel.Error)]
        [InlineData("information", LogEventLevel.Information)]
        [InlineData("invalid", LogEventLevel.Information)]
        [InlineData("", LogEventLevel.Information)]
        public void ConfigureFromEnvironment_Should_Handle_All_Values(string value, LogEventLevel expected)
        {
            var originalValue = Environment.GetEnvironmentVariable("STIGFORGE_LOG_LEVEL");
            try
            {
                Environment.SetEnvironmentVariable("STIGFORGE_LOG_LEVEL", value);
                LoggingConfiguration.ConfigureFromEnvironment();
                LoggingConfiguration.LevelSwitch.MinimumLevel.Should().Be(expected);
            }
            finally
            {
                Environment.SetEnvironmentVariable("STIGFORGE_LOG_LEVEL", originalValue);
                LoggingConfiguration.ConfigureFromEnvironment();
            }
        }

        [Fact]
        public void CurrentLevelName_Should_Return_Level_Name()
        {
            LoggingConfiguration.CurrentLevelName.Should().BeOneOf(
                "Debug", "Verbose", "Warning", "Error", "Information");
        }
    }
    ```
  </action>
  <verify>
    ```bash
    dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~LoggingConfigurationTests"
    ```
    All tests must pass.
  </verify>
  <done>
    LoggingConfigurationTests exist and pass, verifying environment variable parsing and level switch behavior.
  </done>
</task>

</tasks>

<verification>
1. Both CLI and WPF projects build successfully
2. CliHostFactoryTests pass including new correlation test
3. LoggingConfigurationTests pass for all environment variable values
4. Log output template includes TraceId placeholder
</verification>

<success_criteria>
- CliHostFactory uses CorrelationIdEnricher and LoggingConfiguration.LevelSwitch
- App.xaml.cs uses CorrelationIdEnricher and LoggingConfiguration.LevelSwitch
- Log files contain correlation IDs (TraceId or CorrelationId)
- STIGFORGE_LOG_LEVEL environment variable controls log verbosity
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-and-test-stability/11-04-SUMMARY.md`
</output>
