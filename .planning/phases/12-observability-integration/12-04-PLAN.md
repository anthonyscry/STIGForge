---
phase: 12-observability-integration
plan: 04
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - src/STIGForge.Apply/ApplyRunner.cs
  - src/STIGForge.Apply/ApplyRequest.cs
autonomous: true
requirements:
  - OBSV-06
must_haves:
  truths:
    - "PowerShell child processes receive trace context via STIGFORGE_TRACE_ID and STIGFORGE_PARENT_SPAN_ID environment variables"
    - "Trace context is captured from Activity.Current at process creation time"
    - "Existing STIGFORGE_* environment variables continue to work alongside new trace context variables"
    - "PowerShell scripts can access trace context for their own logging"
  artifacts:
    - path: "src/STIGForge.Apply/ApplyRunner.cs"
      provides: "PowerShell process creation with trace context propagation"
      contains: "STIGFORGE_TRACE_ID"
    - path: "src/STIGForge.Apply/ApplyRequest.cs"
      provides: "Apply request model with optional trace context"
      exports: ["ApplyRequest"]
  key_links:
    - from: "ApplyRunner.RunScriptAsync"
      to: "TraceContext.GetCurrentContext"
      via: "ProcessStartInfo.Environment injection"
      pattern: "psi\\.Environment\\[\"STIGFORGE_TRACE_ID\"\\]"
    - from: "ApplyRunner.RunDscAsync"
      to: "TraceContext.GetCurrentContext"
      via: "ProcessStartInfo.Environment injection"
      pattern: "psi\\.Environment\\[\"STIGFORGE_TRACE_ID\"\\]"
    - from: "ApplyRunner.RunPowerStigCompileAsync"
      to: "TraceContext.GetCurrentContext"
      via: "ProcessStartInfo.Environment injection"
      pattern: "psi\\.Environment\\[\"STIGFORGE_TRACE_ID\"\\]"
---

<objective>
Modify ApplyRunner to propagate W3C trace context to PowerShell child processes via environment variables.

Purpose: Enable correlation of PowerShell script logs with parent mission spans. PowerShell 5.1 does not natively support W3C trace context headers, so we use environment variable propagation as a universal cross-process mechanism.

Output: Modified ApplyRunner with trace context injection into all PowerShell process launches.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-observability-integration/12-RESEARCH.md

# Prior plan output
@.planning/phases/12-observability-integration/12-01-SUMMARY.md

# Code to modify
@src/STIGForge.Apply/ApplyRunner.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trace context injection helper in ApplyRunner</name>
  <files>
    src/STIGForge.Apply/ApplyRunner.cs
  </files>
  <action>
    Add a private static method to ApplyRunner for injecting trace context into ProcessStartInfo:

    ```csharp
    using STIGForge.Infrastructure.Telemetry;

    // Add this method to ApplyRunner class (near other private helpers):

    /// <summary>
    /// Injects W3C trace context into PowerShell process environment variables.
    /// PowerShell scripts can access via $env:STIGFORGE_TRACE_ID, $env:STIGFORGE_PARENT_SPAN_ID.
    /// </summary>
    private static void InjectTraceContext(ProcessStartInfo psi)
    {
        var context = TraceContext.GetCurrentContext();
        if (context != null)
        {
            psi.Environment["STIGFORGE_TRACE_ID"] = context.TraceId;
            psi.Environment["STIGFORGE_PARENT_SPAN_ID"] = context.SpanId;
            psi.Environment["STIGFORGE_TRACE_FLAGS"] = context.TraceFlags;
        }
    }
    ```

    This method reads the current Activity context and serializes it to environment variables that PowerShell scripts can access.
  </action>
  <verify>
    Build the project: `dotnet build src/STIGForge.Apply/STIGForge.Apply.csproj`
  </verify>
  <done>
    InjectTraceContext method exists in ApplyRunner and compiles.
    Method captures TraceContext and sets STIGFORGE_TRACE_ID, STIGFORGE_PARENT_SPAN_ID, STIGFORGE_TRACE_FLAGS env vars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inject trace context into all PowerShell process launches</name>
  <files>
    src/STIGForge.Apply/ApplyRunner.cs
  </files>
  <action>
    Modify all three PowerShell process creation methods to call InjectTraceContext:

    1. In RunScriptAsync (around line 614, after existing environment variables):
    ```csharp
    psi.Environment["STIGFORGE_BUNDLE_ROOT"] = bundleRoot;
    psi.Environment["STIGFORGE_APPLY_LOG_DIR"] = logsDir;
    psi.Environment["STIGFORGE_SNAPSHOT_DIR"] = snapshotsDir;
    psi.Environment["STIGFORGE_HARDENING_MODE"] = mode.ToString();

    // Add this line:
    InjectTraceContext(psi);
    ```

    2. In RunDscAsync (around line 679, after existing environment variables):
    ```csharp
    psi.Environment["STIGFORGE_BUNDLE_ROOT"] = bundleRoot;
    psi.Environment["STIGFORGE_APPLY_LOG_DIR"] = logsDir;
    psi.Environment["STIGFORGE_SNAPSHOT_DIR"] = snapshotsDir;
    psi.Environment["STIGFORGE_HARDENING_MODE"] = mode.ToString();

    // Add this line:
    InjectTraceContext(psi);
    ```

    3. In RunPowerStigCompileAsync (around line 751, after existing environment variables):
    ```csharp
    psi.Environment["STIGFORGE_BUNDLE_ROOT"] = bundleRoot;
    psi.Environment["STIGFORGE_APPLY_LOG_DIR"] = logsDir;
    psi.Environment["STIGFORGE_SNAPSHOT_DIR"] = snapshotsDir;
    psi.Environment["STIGFORGE_HARDENING_MODE"] = mode.ToString();

    // Add this line:
    InjectTraceContext(psi);
    ```

    All three methods follow the same pattern - inject trace context after setting the existing STIGFORGE_* environment variables.
  </action>
  <verify>
    Build the project: `dotnet build src/STIGForge.Apply/STIGForge.Apply.csproj`
    Verify InjectTraceContext is called in all three methods.
  </verify>
  <done>
    RunScriptAsync, RunDscAsync, and RunPowerStigCompileAsync all inject trace context into PowerShell processes.
    PowerShell scripts can access $env:STIGFORGE_TRACE_ID for correlation.
  </done>
</task>

</tasks>

<verification>
1. Build src/STIGForge.Apply project
2. Verify InjectTraceContext method exists
3. Verify all three PowerShell creation methods (RunScriptAsync, RunDscAsync, RunPowerStigCompileAsync) call InjectTraceContext
4. Verify no regression to existing STIGFORGE_* environment variables
</verification>

<success_criteria>
- PowerShell child processes receive STIGFORGE_TRACE_ID, STIGFORGE_PARENT_SPAN_ID, STIGFORGE_TRACE_FLAGS env vars
- Trace context captured from Activity.Current at process creation time
- Existing STIGFORGE_* env vars (BUNDLE_ROOT, APPLY_LOG_DIR, etc.) continue to work
- No new external dependencies required
</success_criteria>

<output>
After completion, create `.planning/phases/12-observability-integration/12-04-SUMMARY.md`
</output>
