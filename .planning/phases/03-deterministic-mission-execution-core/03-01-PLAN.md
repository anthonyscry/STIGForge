---
phase: 03-deterministic-mission-execution-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Build/BundleBuilder.cs
  - src/STIGForge.Build/BundleModels.cs
  - src/STIGForge.Build/BuildTime.cs
  - tests/STIGForge.UnitTests/Build/BundleBuilderDeterminismTests.cs
autonomous: true
requirements:
  - BLD-01
must_haves:
  truths:
    - "Re-building a bundle from identical inputs produces identical file_hashes.sha256 manifest content"
    - "BundleManifest includes a SchemaVersion field set to 1"
    - "Build fails fast if Apply/ template directory is missing or empty after copy"
  artifacts:
    - path: "src/STIGForge.Build/BundleBuilder.cs"
      provides: "Deterministic bundle building with schema version and content validation"
      contains: "SchemaVersion, ValidateApplyTemplates, AssertDeterminism"
    - path: "src/STIGForge.Build/BundleModels.cs"
      provides: "BundleManifest with SchemaVersion field"
      contains: "SchemaVersion"
    - path: "tests/STIGForge.UnitTests/Build/BundleBuilderDeterminismTests.cs"
      provides: "Tests proving deterministic output for identical inputs"
      contains: "IdenticalInputs_ProduceIdenticalHashes"
  key_links:
    - from: "src/STIGForge.Build/BundleBuilder.cs"
      to: "BundleManifest"
      via: "SchemaVersion assignment in BuildAsync"
      pattern: "SchemaVersion.*=.*1"
    - from: "src/STIGForge.Build/BundleBuilder.cs"
      to: "file_hashes.sha256"
      via: "WriteHashManifestAsync deterministic ordering"
      pattern: "OrderBy.*StringComparer.OrdinalIgnoreCase"
---

<objective>
Enforce deterministic bundle output so identical inputs always produce identical bundle trees with verifiable integrity.

Purpose: BLD-01 requires deterministic Apply/, Verify/, Manual/, Evidence/, Reports/, and Manifest/ trees. The existing BundleBuilder already creates these directories and writes file_hashes.sha256 with sorted paths, but lacks a manifest schema version, a content validation gate for Apply/ templates, and a determinism assertion contract.
Output: Updated BundleBuilder with schema versioning, Apply/ template validation, and determinism assertion; BundleManifest model with SchemaVersion; unit tests proving deterministic output.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-deterministic-mission-execution-core/03-CONTEXT.md
@.planning/phases/03-deterministic-mission-execution-core/03-RESEARCH.md
@src/STIGForge.Build/BundleBuilder.cs
@src/STIGForge.Build/BundleModels.cs
@src/STIGForge.Build/BuildTime.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SchemaVersion to BundleManifest and deterministic BuildTime seeding</name>
  <files>src/STIGForge.Build/BundleModels.cs, src/STIGForge.Build/BuildTime.cs, src/STIGForge.Build/BundleBuilder.cs</files>
  <action>In BundleModels.cs, add `public int SchemaVersion { get; set; } = 1;` to BundleManifest class. In BuildTime.cs, add a static `Seed(DateTimeOffset value)` method and a `Reset()` method that allow tests to pin the timestamp (so re-builds produce identical manifest.json). The Seed/Reset pattern: store a `DateTimeOffset? _override` field; `Now` returns `_override ?? DateTimeOffset.UtcNow`. In BundleBuilder.BuildAsync, after constructing the BundleManifest, set `manifest.SchemaVersion = 1`. Also fix RunManifest.Timestamp assignment to use BuildTime.Now (it already does, verify). Ensure the run_log.txt also uses BuildTime.Now. The existing manifest.json serialization already uses WriteIndented — ensure property order is deterministic by using `JsonSerializerOptions { WriteIndented = true, PropertyNamingPolicy = null }` (default behavior, just confirm).</action>
  <verify>`dotnet build src/STIGForge.Build/STIGForge.Build.csproj` compiles cleanly. Grep for SchemaVersion in BundleModels.cs.</verify>
  <done>BundleManifest has SchemaVersion=1, BuildTime supports test seeding for deterministic timestamps.</done>
</task>

<task type="auto">
  <name>Task 2: Add Apply/ template validation and determinism assertion tests</name>
  <files>src/STIGForge.Build/BundleBuilder.cs, tests/STIGForge.UnitTests/Build/BundleBuilderDeterminismTests.cs</files>
  <action>In BundleBuilder.BuildAsync, after `CopyApplyTemplates(applyDir)`, add a validation step: check that the Apply/ directory exists and contains at least one file (Preflight.ps1 or RunApply.ps1). If not, and the template source was found, throw InvalidOperationException("Apply templates are incomplete: no apply scripts found in {applyDir}"). If template source was NOT found (repoRoot null or templateRoot missing), skip validation (template copy is best-effort for non-repo contexts). Create BundleBuilderDeterminismTests.cs with xUnit + FluentAssertions: (1) `IdenticalInputs_ProduceIdenticalHashes` — seed BuildTime, create a BundleBuilder with mock IPathBuilder/IHashingService/IClassificationScopeService/ReleaseAgeGate/OverlayConflictDetector, call BuildAsync twice with identical BundleBuildRequest, read both file_hashes.sha256 files, assert content equality. (2) `SchemaVersion_IsSetToOne` — build a bundle, read manifest.json, deserialize, assert SchemaVersion == 1. (3) `MissingApplyTemplates_SkipsValidation` — build in a temp dir without repo root, confirm no exception. Use NSubstitute for mocking (check existing test patterns). For the hash mock, return a fixed hash for any file path to ensure determinism.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter BundleBuilderDeterminism` — all tests pass.</verify>
  <done>Two identical builds produce identical hash manifests. SchemaVersion appears in manifest.json. Apply/ template validation fires only when templates were expected.</done>
</task>

</tasks>

<verification>
Run `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter BundleBuilderDeterminism` and confirm all tests pass. Build the full solution with `dotnet build` and confirm no regressions.
</verification>

<success_criteria>
BLD-01 determinism contract is enforced: identical inputs produce identical file_hashes.sha256. BundleManifest carries SchemaVersion=1 for forward compatibility. Build validates Apply/ template completeness when templates are available.
</success_criteria>

<output>
After completion, create `.planning/phases/03-deterministic-mission-execution-core/03-01-SUMMARY.md`
</output>
