---
phase: 01-mission-orchestration-and-apply-evidence
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/STIGForge.Build/BundleOrchestrator.cs
  - src/STIGForge.Apply/ApplyRunner.cs
  - src/STIGForge.Evidence/EvidenceCollector.cs
  - tests/STIGForge.UnitTests/Apply/ApplyRunnerTests.cs
  - tests/STIGForge.UnitTests/Evidence/EvidenceCollectorTests.cs
  - tests/STIGForge.UnitTests/Build/BundleOrchestratorTimelineTests.cs
autonomous: true
requirements:
  - FLOW-01
  - FLOW-02
  - APLY-01
  - APLY-02
must_haves:
  truths:
    - "Guided orchestration emits explicit mission phase events for apply/verify progression"
    - "Equivalent reruns preserve deterministic event ordering and stable lineage markers"
    - "Apply artifacts are captured as evidence with run+step identity and checksums"
  artifacts:
    - path: "src/STIGForge.Build/BundleOrchestrator.cs"
      provides: "Mission-run timeline emission at orchestration phase boundaries"
      contains: "OrchestrateAsync"
    - path: "src/STIGForge.Apply/ApplyRunner.cs"
      provides: "Step-level apply evidence metadata and rerun continuity markers"
      contains: "apply_run.json"
    - path: "src/STIGForge.Evidence/EvidenceCollector.cs"
      provides: "Checksum-backed evidence records with run/step provenance"
      contains: "Sha256"
  key_links:
    - from: "src/STIGForge.Build/BundleOrchestrator.cs"
      to: "MissionRunRepository"
      via: "append phase events"
      pattern: "AppendEventAsync"
    - from: "src/STIGForge.Apply/ApplyRunner.cs"
      to: "src/STIGForge.Evidence/EvidenceCollector.cs"
      via: "evidence metadata write per step"
      pattern: "WriteEvidence"
---

<objective>
Wire mission orchestration and apply execution to produce deterministic timeline + evidence continuity records for rerunnable missions.

Purpose: Deliver FLOW-01/FLOW-02 and APLY-01/APLY-02 by binding existing orchestrator/apply primitives to the new mission ledger.
Output: Timeline-aware orchestration events, run-scoped apply evidence metadata, and rerun lineage behavior.
</objective>

<execution_context>
@/home/anthonyscry/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-mission-orchestration-and-apply-evidence/01-RESEARCH.md
@.planning/phases/01-mission-orchestration-and-apply-evidence/01-01-SUMMARY.md
@src/STIGForge.Build/BundleOrchestrator.cs
@src/STIGForge.Apply/ApplyRunner.cs
@src/STIGForge.Evidence/EvidenceCollector.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Emit orchestration phase timeline events into MissionRun ledger</name>
  <files>src/STIGForge.Build/BundleOrchestrator.cs, tests/STIGForge.UnitTests/Build/BundleOrchestratorTimelineTests.cs</files>
  <action>Update orchestration flow to start a mission run, append explicit events for apply/verify/coverage phases (`started`, `completed`, `failed`, `skipped`), and persist deterministic sequence numbers. On blocking failures, append failure events before throwing. Keep current apply/verify behavior unchanged except for timeline emission side effects.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter BundleOrchestratorTimelineTests`</verify>
  <done>Orchestrate flow records deterministic timeline events with stable ordering and clear failure visibility for each mission phase.</done>
</task>

<task type="auto">
  <name>Task 2: Capture apply step evidence with run-scoped provenance and checksums</name>
  <files>src/STIGForge.Apply/ApplyRunner.cs, src/STIGForge.Evidence/EvidenceCollector.cs, tests/STIGForge.UnitTests/Evidence/EvidenceCollectorTests.cs</files>
  <action>Extend apply completion path so each step outcome (`powerstig_compile`, `apply_script`, `apply_dsc`) writes evidence metadata containing `runId`, `stepName`, `timestamp`, `sha256`, source/log paths, and bundle root. Preserve existing checksum behavior, but ensure metadata schema can represent rerun lineage fields (`supersedesEvidenceId` or equivalent) without broad export coupling.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "ApplyRunnerTests|EvidenceCollectorTests"`</verify>
  <done>Apply-run artifacts produce evidence metadata with deterministic run+step identity and SHA-256 references usable by downstream proof/export phases.</done>
</task>

<task type="auto">
  <name>Task 3: Implement deterministic rerun continuity markers for timeline and evidence</name>
  <files>src/STIGForge.Apply/ApplyRunner.cs, tests/STIGForge.UnitTests/Apply/ApplyRunnerTests.cs</files>
  <action>When rerunning an equivalent mission input, link the new run to prior run artifacts via explicit continuity markers (retained/superseded) and dedupe evidence entries by checksum for unchanged outputs. Ensure rerun writes remain append-only and never mutate prior run timeline rows.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter ApplyRunnerTests`</verify>
  <done>Reruns generate new run records with deterministic lineage links while preserving prior runs as immutable history.</done>
</task>

</tasks>

<verification>
Run `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "BundleOrchestratorTimelineTests|ApplyRunnerTests|EvidenceCollectorTests"` and confirm timeline sequencing + evidence continuity assertions pass.
</verification>

<success_criteria>
Mission execution emits deterministic phase events and run-scoped apply evidence with rerun continuity semantics, without mutating prior history.
</success_criteria>

<output>
After completion, create `.planning/phases/01-mission-orchestration-and-apply-evidence/01-03-SUMMARY.md`
</output>
