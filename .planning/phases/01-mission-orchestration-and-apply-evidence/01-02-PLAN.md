---
phase: 01-mission-orchestration-and-apply-evidence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Content/Import/ImportQueuePlanner.cs
  - src/STIGForge.Content/Import/ContentPackImporter.cs
  - src/STIGForge.Cli/Commands/ImportCommands.cs
  - src/STIGForge.App/MainViewModel.Import.cs
  - tests/STIGForge.UnitTests/Content/ImportQueuePlannerTests.cs
  - tests/STIGForge.UnitTests/Content/ContentPackImporterTests.cs
autonomous: true
requirements:
  - IMPT-01
must_haves:
  truths:
    - "Import operations move through explicit staged states before commit"
    - "Staging transitions are deterministic for identical input archives"
    - "Operator surfaces show staged outcome and commit/failure visibility"
  artifacts:
    - path: "src/STIGForge.Content/Import/ImportQueuePlanner.cs"
      provides: "Deterministic staged import plan and transition ordering"
      contains: "BuildContentImportPlan"
    - path: "src/STIGForge.Content/Import/ContentPackImporter.cs"
      provides: "Import staging state writes prior to final content commit"
      contains: "ImportConsolidatedZipAsync"
    - path: "src/STIGForge.App/MainViewModel.Import.cs"
      provides: "UI projection of staging and commit outcomes"
      contains: "ScanImportFolderAsync"
  key_links:
    - from: "src/STIGForge.Cli/Commands/ImportCommands.cs"
      to: "ContentPackImporter"
      via: "import-pack command flow"
      pattern: "ImportZipAsync"
    - from: "src/STIGForge.App/MainViewModel.Import.cs"
      to: "ImportQueuePlanner"
      via: "scan and planned import routing"
      pattern: "BuildContentImportPlan"
---

<objective>
Implement deterministic import staging transitions so content import is observable and auditable before commit.

Purpose: Satisfy IMPT-01 without broad importer redesign by extending existing queue/planner/importer paths.
Output: Staging-aware import planner/executor behavior and surfaced staged outcomes in CLI and WPF.
</objective>

<execution_context>
@/home/anthonyscry/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-mission-orchestration-and-apply-evidence/01-RESEARCH.md
@src/STIGForge.Content/Import/ImportQueuePlanner.cs
@src/STIGForge.Content/Import/ContentPackImporter.cs
@src/STIGForge.App/MainViewModel.Import.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend import planning with explicit staging transitions</name>
  <files>src/STIGForge.Content/Import/ImportQueuePlanner.cs</files>
  <action>Add staged transition semantics (`detected`, `planned`, `staged`, `committed`, `failed`) to planned import operations while preserving current deterministic route selection and ordering. Keep planner deterministic by continuing stable sort keys and route derivation; do not add random IDs or time-based ordering in plan output.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter ImportQueuePlannerTests`</verify>
  <done>Planner emits stable staged transition metadata for each operation and existing deterministic tests remain green.</done>
</task>

<task type="auto">
  <name>Task 2: Wire staging-before-commit behavior in import execution paths</name>
  <files>src/STIGForge.Content/Import/ContentPackImporter.cs, src/STIGForge.Cli/Commands/ImportCommands.cs</files>
  <action>Update import execution so each planned operation records staged state before commit and records commit/failure result after import. Keep existing importer APIs and file output contracts intact, but make staging transitions explicit in command output and persisted import metadata summaries.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "ContentPackImporterTests|CliCommandTests"`</verify>
  <done>CLI import flow exposes staged->committed (or staged->failed) outcomes for each planned operation without changing deterministic selection behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Surface staged transitions in WPF import workflow</name>
  <files>src/STIGForge.App/MainViewModel.Import.cs, tests/STIGForge.UnitTests/Content/ContentPackImporterTests.cs</files>
  <action>Update `ScanImportFolderAsync` summary generation to include staged transition counts and per-operation diagnostics in JSON/text summary artifacts and status text. Keep import UX flow intact (scan -> dedupe -> plan -> execute), and ensure failed operations still emit deterministic summary rows.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "ImportQueuePlannerTests|ContentPackImporterTests|ImportViewLayoutContractTests"`</verify>
  <done>WPF import scan outputs explicitly show staged lifecycle outcomes and remain deterministic across repeated scans of unchanged input.</done>
</task>

</tasks>

<verification>
Run `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "ImportQueuePlannerTests|ContentPackImporterTests|ImportInboxScannerTests"` and validate deterministic staged transition assertions.
</verification>

<success_criteria>
Import workflow records and exposes deterministic staged transitions before commit across planner, importer, CLI, and WPF surfaces.
</success_criteria>

<output>
After completion, create `.planning/phases/01-mission-orchestration-and-apply-evidence/01-02-SUMMARY.md`
</output>
