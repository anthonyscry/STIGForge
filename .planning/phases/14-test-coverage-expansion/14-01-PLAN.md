# Phase 14 Plan 01: Coverage Gates and Mutation Signal Rollout

---
phase: 14-test-coverage-expansion
plan: 01
type: execute
wave: 1
depends_on: [14-RESEARCH]
files_modified:
  - tools/release/Invoke-CoverageMerge.ps1
  - .github/workflows/ci.yml
  - .github/workflows/release-package.yml
  - .planning/phases/14-test-coverage-expansion/14-01-SUMMARY.md
requirements: [TEST-02, TEST-03, TEST-04, TEST-06]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CI generates a deterministic Cobertura file for critical coverage checks"
    - "CI publishes branch and line coverage report artifacts for review"
    - "CI fails when scoped line coverage falls below policy threshold"
    - "Mutation policy is evaluated as non-blocking evidence in automated lanes"
  artifacts:
    - path: "tools/release/Invoke-CoverageMerge.ps1"
      provides: "Deterministic coverage merge into .artifacts/coverage/ci/coverage.cobertura.xml"
      exports: [coverage-metrics, package-level aggregation]
    - path: ".github/workflows/ci.yml"
      provides: "CI steps for coverage collection, report generation, and gate execution"
      exports: [coverage-report.md, coverage-summary.json]
    - path: ".github/workflows/release-package.yml"
      provides: "Release-quality branch for same quality checks and policy checks"
      exports: [coverage artifacts in release-package run]

<objective>
Wire branch/line coverage collection and policy enforcement in CI, then stage mutation policy execution as non-blocking rollout evidence.

The immediate goal is deterministic visibility and enforcement of the scoped 80% line gate for PR validation, with mutation policy checks in report mode until mutation result generation is fully plumbed.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-test-coverage-expansion/14-RESEARCH.md
@.planning/phases/14-test-coverage-expansion/14-01-SUMMARY.md
@tools/release/Invoke-CoverageReport.ps1
@tools/release/Invoke-CoverageGate.ps1
@tools/release/Invoke-MutationPolicy.ps1
</context>

<tasks>

<task type="auto">
<name>Task 1: Add deterministic Cobertura merge utility</name>
<files>tools/release/Invoke-CoverageMerge.ps1</files>
<action>
Create a small PowerShell utility that merges coverage files from one or more collector outputs into a single deterministic Cobertura document.

Implementation:
1. Add `Invoke-CoverageMerge.ps1` with params:
   - `-SourceDirectory` (default `.artifacts/coverage`)
   - `-OutputPath` (default `.artifacts/coverage/ci/coverage.cobertura.xml`)
2. Recursively discover `coverage.cobertura.xml` files under `SourceDirectory`.
3. Sum package-level metrics (`lines-covered`, `lines-valid`, `branches-covered`, `branches-valid`).
4. Emit merged `.coverage` root with combined totals and one package entry per unique package.
5. Write UTF-8 XML to `OutputPath` and fail early if no valid coverage files are present.

Keep failures explicit to prevent silent policy drift.
</action>
<verify>
<command>pwsh -NoProfile -ExecutionPolicy Bypass -File tools/release/Invoke-CoverageMerge.ps1 -SourceDirectory tests/STIGForge.IntegrationTests/Release/Fixtures -OutputPath .artifacts/coverage/coverage.cobertura.xml</command>
<expect>Command fails with a clear message that no collect coverage files were found</expect>
</verify>
<done>`Invoke-CoverageMerge.ps1` aggregates one or more Cobertura files and writes deterministic merged coverage output for downstream gate/report steps.</done>
</task>

<task type="auto">
<name>Task 2: Wire branch/line coverage reporting and scoped line gate into CI</name>
<files>
.github/workflows/ci.yml
</files>
<action>
Add CI collection and gate steps after existing contract tests and before release gate.

Implementation:
1. Add step to collect coverage from both existing unit/integration contract test sets with `--collect:"XPlat Code Coverage"` into `.artifacts/coverage/ci/{unit|integration}`.
2. Run `Invoke-CoverageMerge.ps1` to produce `.artifacts/coverage/ci/coverage.cobertura.xml`.
3. Run `Invoke-CoverageReport.ps1` against merged report and write to `.artifacts/coverage/ci/report`.
4. Run `Invoke-CoverageGate.ps1` against the merged report.
5. Upload a new artifact package (for branch/line summary + merged report + raw coverage outputs).

This turns `TEST-03` and `TEST-04` into active CI gates.
</action>
<verify>
<command>python -m pytest</command>
<expect>Not required for planning artifact; execution to be verified via GitHub Actions matrix</expect>
</verify>
<done>CI writes merged coverage, publishes report artifacts, and runs scoped gate with fail-on-threshold behavior.</done>
</task>

<task type="auto">
<name>Task 3: Add mutation policy reporting in release workflows</name>
<files>
.github/workflows/ci.yml
.github/workflows/release-package.yml
</files>
<action>
Add non-blocking policy checks that surface mutation baseline health without hard-failing local runs when no mutation artifacts are available.

Implementation:
1. Add `-Result path` step to check for `.artifacts/mutation/current-result.json`.
2. If present, call `Invoke-MutationPolicy.ps1` in report mode (no `-Enforce`).
3. In CI, treat missing result as informative skip (do not fail).
4. In release-package, run the same skip-or-report step under `inputs.run_release_gate`.

This keeps `TEST-06` moving while preserving fail-closed posture.
</action>
<verify>
<command>pwsh -NoProfile -ExecutionPolicy Bypass -File tools/release/Invoke-MutationPolicy.ps1 -CurrentResultPath tests/STIGForge.IntegrationTests/Release/Fixtures/mutation-current-pass.json -PolicyPath tools/release/mutation-policy.json</command>
<expect>Returns 0 and outputs mode=report</expect>
</verify>
<done>Mutation policy is evaluated and reported in CI/release workflows without enforcing missing-result false negatives.</done>
</task>

</tasks>

<verification>
- `tools/release/Invoke-CoverageMerge.ps1` exists and writes `.artifacts/coverage/ci/coverage.cobertura.xml` from at least one collector output.
- CI exposes `.artifacts/coverage/ci/report/coverage-report.md` and `coverage-summary.json`.
- CI fails when scoped merged coverage falls below `coverage-gate-policy.json` threshold.
- Release-package and CI report mutation policy in non-enforcing mode when result files are available.
</verification>

<success_criteria>
- `TEST-02`: coverage data is collected for scoped assemblies and compared against policy threshold.
- `TEST-03`: branch and line totals are emitted in CI artifacts for human and machine checks.
- `TEST-04`: low scoped coverage breaks CI.
- `TEST-06`: mutation signal reporting is wired into automated workflows and gated by explicit enforcement policy in future phase.
</success_criteria>

<output>
After execution, adjust `.planning/phases/14-test-coverage-expansion/14-01-SUMMARY.md` with execution evidence and update `.planning/STATE.md` plan count.
</output>
