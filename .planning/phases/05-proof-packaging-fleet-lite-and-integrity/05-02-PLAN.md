---
phase: 05-proof-packaging-fleet-lite-and-integrity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Infrastructure/System/FleetService.cs
  - src/STIGForge.Export/FleetSummaryService.cs
  - src/STIGForge.Cli/Commands/FleetCommands.cs
  - tests/STIGForge.UnitTests/Infrastructure/FleetArtifactCollectionTests.cs
  - tests/STIGForge.UnitTests/Export/FleetSummaryServiceTests.cs
autonomous: true
requirements:
  - FLT-01
must_haves:
  truths:
    - "FleetService.CollectArtifactsAsync pulls artifacts from remote hosts via WinRM into fleet_results/{hostname}/ directories"
    - "Artifact collection is best-effort — failure to collect from one host does not block others"
    - "Per-host CKL generation runs CklExporter per host using collected artifacts"
    - "FleetSummaryService aggregates per-host results into fleet_summary.json, fleet_summary.csv, and fleet_summary.txt"
    - "Control status matrix has rows = controls, columns = hosts, cells = Pass/Fail/NA/NR"
    - "Fleet POA&M aggregation produces one combined POA&M with host column"
    - "fleet-summary CLI command generates unified fleet summary from a results directory"
  artifacts:
    - path: "src/STIGForge.Infrastructure/System/FleetService.cs"
      provides: "CollectArtifactsAsync and GeneratePerHostCklAsync methods"
      contains: "CollectArtifactsAsync, fleet_results, CopyFromRemoteAsync, GeneratePerHostCklAsync"
    - path: "src/STIGForge.Export/FleetSummaryService.cs"
      provides: "Fleet summary aggregation with control status matrix and fleet POA&M"
      contains: "FleetSummaryService, GenerateSummary, ControlStatusMatrix, FleetPoamAggregator, fleet_summary"
    - path: "src/STIGForge.Cli/Commands/FleetCommands.cs"
      provides: "fleet-summary and fleet-collect CLI commands"
      contains: "fleet-summary, fleet-collect, --results-dir, --output"
    - path: "tests/STIGForge.UnitTests/Infrastructure/FleetArtifactCollectionTests.cs"
      provides: "Tests for artifact collection resilience and per-host directory structure"
      contains: "CollectArtifacts_CreatesPerHostDirectories, CollectArtifacts_ContinuesOnHostFailure, PerHostCkl_GeneratedFromCollectedArtifacts"
    - path: "tests/STIGForge.UnitTests/Export/FleetSummaryServiceTests.cs"
      provides: "Tests for fleet summary aggregation and control status matrix"
      contains: "Summary_AggregatesPerHostCompliance, ControlStatusMatrix_RowsAreControls, FleetPoam_IncludesHostColumn"
  key_links:
    - from: "src/STIGForge.Cli/Commands/FleetCommands.cs"
      to: "FleetSummaryService"
      via: "fleet-summary handler invokes GenerateSummary"
      pattern: "GenerateSummary"
    - from: "src/STIGForge.Infrastructure/System/FleetService.cs"
      to: "CklExporter"
      via: "GeneratePerHostCklAsync calls CklExporter.ExportCkl per host"
      pattern: "CklExporter.ExportCkl"
---

<objective>
Add fleet artifact collection, per-host CKL generation, fleet summary aggregation service, and fleet-summary CLI command.

Purpose: FLT-01 requires fleet-lite WinRM runs to generate host-separated artifacts and a unified operator summary. The existing FleetService handles remote execution but does not collect artifacts back to the operator machine, generate per-host CKL files, or produce a unified fleet summary. Per CONTEXT.md: artifacts pulled via WinRM Copy-Item into `fleet_results/{hostname}/`, per-host CKL generation, FleetSummaryService aggregates compliance percentages and a control status matrix (controls x hosts), fleet POA&M with host column, and CLI `fleet-summary` command.
Output: CollectArtifactsAsync on FleetService, FleetSummaryService with control status matrix, fleet-collect and fleet-summary CLI commands, unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-CONTEXT.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-RESEARCH.md
@src/STIGForge.Infrastructure/System/FleetService.cs
@src/STIGForge.Export/CklExporter.cs
@src/STIGForge.Export/PoamGenerator.cs
@src/STIGForge.Cli/Commands/FleetCommands.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CollectArtifactsAsync and per-host CKL generation to FleetService</name>
  <files>src/STIGForge.Infrastructure/System/FleetService.cs</files>
  <action>Add the following methods to FleetService:

1. `async Task<FleetCollectionResult> CollectArtifactsAsync(FleetCollectionRequest request, CancellationToken ct)` — iterates request.Targets in parallel (same semaphore pattern as ExecuteAsync). For each target, calls `CopyFromRemoteAsync(target, request.RemoteBundleRoot, localHostDir, ct)` where localHostDir is `Path.Combine(request.LocalResultsRoot, "fleet_results", target.HostName)`. Collection is best-effort: catch exceptions per host and continue. Returns FleetCollectionResult with per-host success/failure and collected file counts.

2. `private async Task<FleetHostCollectionResult> CopyFromRemoteAsync(FleetTarget target, string remoteBundleRoot, string localDir, CancellationToken ct)` — builds a PowerShell script that uses `Copy-Item -FromSession` to copy from the remote bundle root to the local directory. Creates localDir. Runs via the existing RunPowerShellRemoteAsync infrastructure. Returns FleetHostCollectionResult with MachineName, Success, FilesCollected, Error.

3. `void GeneratePerHostCkl(string fleetResultsRoot)` — iterates each subdirectory in fleetResultsRoot (each is a hostname). For each host directory that contains verification results (Verify/ subdirectory), calls CklExporter.ExportCkl with BundleRoot = hostDir, OutputDirectory = Path.Combine(hostDir, "Export"), HostName = directory name. This is synchronous since CklExporter is synchronous.

Add supporting models:
- `FleetCollectionRequest`: Targets, RemoteBundleRoot, LocalResultsRoot, MaxConcurrency, TimeoutSeconds
- `FleetCollectionResult`: HostResults (list of FleetHostCollectionResult), TotalHosts, SuccessCount, FailureCount
- `FleetHostCollectionResult`: MachineName, Success, FilesCollected, Error</action>
  <verify>`dotnet build src/STIGForge.Infrastructure/STIGForge.Infrastructure.csproj` compiles. Existing FleetService tests still pass: `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter FleetService`.</verify>
  <done>FleetService has CollectArtifactsAsync for best-effort artifact pull and GeneratePerHostCkl for per-host CKL generation from collected artifacts.</done>
</task>

<task type="auto">
  <name>Task 2: Create FleetSummaryService with control status matrix and fleet POA&M</name>
  <files>src/STIGForge.Export/FleetSummaryService.cs</files>
  <action>Create FleetSummaryService.cs in src/STIGForge.Export/ as a public class:

1. `FleetSummary GenerateSummary(string fleetResultsRoot)` — scans `fleet_results/` subdirectories. For each host directory, loads consolidated-results.json from the Verify/ subdirectory (same pattern as CklExporter.LoadResultsForBundle). Builds:
   - Per-host compliance stats: host name, total controls, pass count, fail count, na count, nr count, compliance percentage (pass / (pass + fail) * 100).
   - Control status matrix: Dictionary<string controlId, Dictionary<string hostName, string status>>. Status values: "Pass", "Fail", "NA", "NR". Sort controls by VulnId/RuleId. Sort hosts alphabetically.
   - Fleet-wide failing controls: controls that fail on any host, with list of affected hosts.

2. `PoamPackage GenerateFleetPoam(string fleetResultsRoot, string systemName)` — similar to PoamGenerator.GeneratePoam but aggregates across all hosts. Each PoamItem gains a `HostsAffected` field (comma-separated list of hostnames where the control fails). Uses the existing PoamItem model — add `string? HostsAffected` property to PoamItem in PoamGenerator.cs.

3. `void WriteSummaryFiles(FleetSummary summary, string outputDir)` — writes three files:
   - `fleet_summary.json`: full summary as JSON (sorted keys, WriteIndented)
   - `fleet_summary.csv`: rows = controls, columns = Host1Status, Host2Status, etc. Header: ControlId, Title, Severity, {Host1}, {Host2}, ...
   - `fleet_summary.txt`: human-readable report with per-host compliance percentages table and fleet-wide summary stats.

4. FleetSummary model: PerHostStats (list of FleetHostStats), ControlStatusMatrix, FailingControls, FleetWideCompliance (percentage), GeneratedAt.
5. FleetHostStats model: HostName, TotalControls, PassCount, FailCount, NaCount, NrCount, CompliancePercentage.</action>
  <verify>`dotnet build src/STIGForge.Export/STIGForge.Export.csproj` compiles.</verify>
  <done>FleetSummaryService generates per-host compliance stats, control status matrix, and fleet POA&M with host column. Summary output in JSON, CSV, and TXT formats.</done>
</task>

<task type="auto">
  <name>Task 3: Register fleet-collect and fleet-summary CLI commands</name>
  <files>src/STIGForge.Cli/Commands/FleetCommands.cs</files>
  <action>Add two new command registrations in FleetCommands.Register:

1. `fleet-collect` command: options `--targets` (required, comma-separated hostnames), `--remote-bundle-path` (optional, default C:\STIGForge\bundle), `--output` (required, local results root directory), `--concurrency` (optional, default 5), `--timeout` (optional, default 600), `--json` (optional, JSON output). Handler: parse targets, create FleetCollectionRequest, call FleetService.CollectArtifactsAsync. Then call FleetService.GeneratePerHostCkl on the fleet_results directory. Print: per-host collection status (OK/FAIL, files collected), total summary.

2. `fleet-summary` command: options `--results-dir` (required, path to fleet_results directory), `--output` (optional, output directory, defaults to results-dir/../fleet_summary), `--system-name` (optional, default "Fleet"), `--json` (optional, JSON-only output). Handler: instantiate FleetSummaryService, call GenerateSummary. Call WriteSummaryFiles. Call GenerateFleetPoam and write POA&M files. Print: per-host compliance table, fleet-wide compliance, output paths.

Follow the existing FleetCommands patterns for option handling and output formatting.</action>
  <verify>`dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj` compiles. `dotnet run --project src/STIGForge.Cli -- fleet-collect --help` and `fleet-summary --help` show correct options.</verify>
  <done>fleet-collect and fleet-summary CLI commands registered. fleet-collect pulls artifacts and generates per-host CKL. fleet-summary aggregates results and writes summary files.</done>
</task>

<task type="auto">
  <name>Task 4: Add fleet artifact collection and summary service tests</name>
  <files>tests/STIGForge.UnitTests/Infrastructure/FleetArtifactCollectionTests.cs, tests/STIGForge.UnitTests/Export/FleetSummaryServiceTests.cs</files>
  <action>Create FleetArtifactCollectionTests.cs with xUnit tests:

1. `GeneratePerHostCkl_CreatesExportPerHost` — create temp fleet_results directory with two host subdirectories, each containing a Verify/consolidated-results.json with sample results. Call GeneratePerHostCkl. Verify each host directory has an Export/ subdirectory with a .ckl file.
2. `GeneratePerHostCkl_SkipsHostsWithoutVerifyResults` — create a host directory without Verify/. Call GeneratePerHostCkl. Verify no Export/ directory created for that host but other hosts still get CKL.
3. `CollectionRequest_ModelProperties` — verify FleetCollectionRequest defaults (MaxConcurrency=5, TimeoutSeconds=600).

Create FleetSummaryServiceTests.cs:

1. `Summary_AggregatesPerHostCompliance` — create fleet_results with 2 hosts, each with 10 controls (varying pass/fail). Generate summary. Verify each host's CompliancePercentage is correct.
2. `ControlStatusMatrix_RowsAreControls_ColumnsAreHosts` — create fleet_results with 3 hosts and overlapping controls. Verify matrix has control IDs as keys and host statuses as values.
3. `ControlStatusMatrix_SortedByControlId` — verify matrix keys are sorted alphabetically.
4. `FleetPoam_IncludesHostColumn` — create fleet_results where control V-1234 fails on host-a and host-b but passes on host-c. Generate fleet POA&M. Verify V-1234 POA&M item has HostsAffected = "host-a,host-b".
5. `WriteSummary_CreatesAllThreeFormats` — generate and write summary. Verify fleet_summary.json, fleet_summary.csv, fleet_summary.txt all exist.
6. `FleetWideCompliance_CalculatedCorrectly` — verify fleet-wide compliance is weighted average across hosts.

Use temp directories for all tests. Create realistic consolidated-results.json fixtures using JsonSerializer.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FleetArtifactCollection|FleetSummaryService"` — all tests pass.</verify>
  <done>Fleet artifact collection tests verify per-host CKL generation and resilience. Fleet summary tests verify aggregation, control status matrix ordering, fleet POA&M with host column, and all output formats.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes for Infrastructure, Export, Cli, and UnitTests projects
- `dotnet test --filter "FleetArtifactCollection|FleetSummaryService|FleetService"` — all tests pass (new and existing)
- `fleet-collect --help` and `fleet-summary --help` show correct options
- Fleet summary JSON contains control status matrix with hosts as columns
- Fleet POA&M items include HostsAffected field
</verification>

<success_criteria>
FLT-01 is satisfied: fleet-lite operations collect host-separated artifacts, generate per-host CKL, produce a unified fleet summary with compliance percentages and control status matrix, and create fleet-aggregated POA&M with host attribution.
</success_criteria>

<output>
After completion, create `.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-02-SUMMARY.md`
</output>
