---
phase: 05-proof-packaging-fleet-lite-and-integrity
plan: 04
type: execute
wave: 2
depends_on: [05-01, 05-02]
files_modified:
  - src/STIGForge.App/Views/ExportView.xaml
  - src/STIGForge.App/Views/ExportView.xaml.cs
  - src/STIGForge.App/Views/FleetView.xaml
  - src/STIGForge.App/Views/FleetView.xaml.cs
  - src/STIGForge.App/MainViewModel.Export.cs
  - src/STIGForge.App/MainViewModel.Fleet.cs
autonomous: true
requirements:
  - EXP-01
  - FLT-01
must_haves:
  truths:
    - "ExportView displays submission readiness status with pass/fail checklist after eMASS export"
    - "ExportView shows packageHash and validation result summary"
    - "ExportView provides import-attestations button that opens file picker for filled attestation CSV"
    - "FleetView displays per-host compliance percentages after fleet-summary generation"
    - "FleetView shows fleet-wide compliance percentage and control status matrix summary"
    - "FleetView provides fleet-collect and fleet-summary buttons wired to FleetService and FleetSummaryService"
  artifacts:
    - path: "src/STIGForge.App/Views/ExportView.xaml"
      provides: "Submission readiness checklist, packageHash display, import-attestations button"
      contains: "SubmissionReadiness, PackageHash, ImportAttestationsCommand, ValidationSummary"
    - path: "src/STIGForge.App/Views/FleetView.xaml"
      provides: "Fleet compliance table, fleet-collect and fleet-summary buttons"
      contains: "FleetComplianceTable, FleetCollectCommand, FleetSummaryCommand, ControlStatusMatrix"
    - path: "src/STIGForge.App/MainViewModel.Export.cs"
      provides: "Export ViewModel partial with submission readiness and attestation import commands"
      contains: "ExportEmassCommand, ImportAttestationsCommand, SubmissionReadiness, PackageHash"
    - path: "src/STIGForge.App/MainViewModel.Fleet.cs"
      provides: "Fleet ViewModel partial with collect, summary, and compliance display"
      contains: "FleetCollectCommand, FleetSummaryCommand, FleetComplianceStats, FleetWideCompliance"
  key_links:
    - from: "src/STIGForge.App/MainViewModel.Export.cs"
      to: "EmassExporter"
      via: "ExportEmassCommand handler calls ExportAsync"
      pattern: "EmassExporter.*ExportAsync"
    - from: "src/STIGForge.App/MainViewModel.Fleet.cs"
      to: "FleetSummaryService"
      via: "FleetSummaryCommand handler calls GenerateSummary"
      pattern: "FleetSummaryService.*GenerateSummary"
---

<objective>
Wire submission readiness, package integrity display, and attestation import into ExportView, and fleet compliance summary into FleetView.

Purpose: Operators need WPF visibility into the submission readiness status of export packages and fleet-wide compliance. ExportView currently has minimal code-behind. FleetView is similarly a stub. Per CONTEXT.md: submission readiness flags give operators a clear go/no-go signal, and the fleet summary control status matrix is the "money view" for multi-host management.
Output: Enhanced ExportView with readiness checklist and attestation import, enhanced FleetView with compliance table and fleet summary controls, ViewModel partials.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-CONTEXT.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-RESEARCH.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-01-PLAN.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-02-PLAN.md
@src/STIGForge.App/Views/ExportView.xaml.cs
@src/STIGForge.App/Views/FleetView.xaml.cs
@src/STIGForge.App/MainViewModel.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MainViewModel.Export.cs partial with export commands and submission readiness state</name>
  <files>src/STIGForge.App/MainViewModel.Export.cs</files>
  <action>Create MainViewModel.Export.cs as a partial class extension of MainViewModel (following the existing pattern of MainViewModel.ApplyVerify.cs, MainViewModel.ToolDefaults.cs, etc.).

Add the following properties and commands:

**Properties (with INotifyPropertyChanged):**
- `ExportResult? LastExportResult` — stores the most recent export result for display
- `SubmissionReadiness? ExportReadiness` — readiness flags from the last export
- `string ExportPackageHash` — packageHash string from manifest
- `string ExportValidationSummary` — human-readable validation summary (VALID/INVALID + error/warning counts)
- `bool IsExportRunning` — busy indicator
- `string ExportStatusText` — status message

**Commands (RelayCommand/AsyncRelayCommand):**
- `AsyncRelayCommand ExportEmassCommand` — handler: resolve EmassExporter from DI (IPathBuilder, IHashingService, IAuditTrailService), prompt user for bundle root (use existing folder picker pattern), call ExportAsync, update LastExportResult/ExportReadiness/ExportPackageHash/ExportValidationSummary. Set ExportStatusText to result summary.
- `AsyncRelayCommand ImportAttestationsCommand` — handler: open file picker for CSV file (filter *.csv), prompt for package root (or use last export output root), call AttestationImporter.ImportAttestations, show result dialog with updated/skipped/notfound counts. Record audit entry.

Initialize commands in the partial class constructor or a partial InitializeExportCommands method called from the main constructor.</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles.</verify>
  <done>MainViewModel.Export.cs provides ExportEmassCommand, ImportAttestationsCommand, and submission readiness state properties for ExportView binding.</done>
</task>

<task type="auto">
  <name>Task 2: Update ExportView.xaml with submission readiness checklist and attestation import</name>
  <files>src/STIGForge.App/Views/ExportView.xaml, src/STIGForge.App/Views/ExportView.xaml.cs</files>
  <action>Replace the minimal ExportView.xaml with a functional layout. Follow the existing WPF patterns (DarkTheme/LightTheme styles, Grid layouts, consistent margins).

Layout structure:
1. **Header section**: "Export Package" title with Export eMASS button (bound to ExportEmassCommand). Bundle root text field with folder picker.

2. **Submission Readiness section** (visible after export): Header "Submission Readiness". Four status rows, each showing a checklist item with pass/fail icon:
   - All Controls Covered: {pass/fail icon} bound to ExportReadiness.AllControlsCovered
   - Evidence Present: {pass/fail icon} bound to ExportReadiness.EvidencePresent
   - POA&M Complete: {pass/fail icon} bound to ExportReadiness.PoamComplete
   - Attestations Complete: {pass/fail icon} bound to ExportReadiness.AttestationsComplete
   - Verdict row: "READY FOR SUBMISSION" or "NOT READY" with appropriate color, bound to ExportReadiness.IsReady
   Use BoolToVisibilityConverter for conditional display. Use green/red TextBlock foreground for pass/fail.

3. **Package Integrity section** (visible after export): Package Hash value (monospace font), Validation Result summary text.

4. **Attestation Import section**: "Import Completed Attestations" button (bound to ImportAttestationsCommand). Status text showing last import result.

5. **Export Output section** (visible after export): output root path, link-style TextBlock to open in Explorer.

Keep ExportView.xaml.cs minimal (just InitializeComponent). All logic is in ViewModel.</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles.</verify>
  <done>ExportView shows submission readiness checklist, package hash, validation summary, and attestation import button. All bound to MainViewModel.Export.cs properties.</done>
</task>

<task type="auto">
  <name>Task 3: Create MainViewModel.Fleet.cs partial with fleet collect/summary commands</name>
  <files>src/STIGForge.App/MainViewModel.Fleet.cs</files>
  <action>Create MainViewModel.Fleet.cs as a partial class extension of MainViewModel.

**Properties:**
- `FleetSummary? LastFleetSummary` — stores the most recent fleet summary
- `ObservableCollection<FleetHostStats> FleetComplianceStats` — per-host compliance for DataGrid binding
- `double FleetWideCompliance` — fleet-wide percentage for display
- `bool IsFleetRunning` — busy indicator
- `string FleetStatusText` — status message
- `string FleetResultsDirectory` — directory for fleet results

**Commands:**
- `AsyncRelayCommand FleetCollectCommand` — handler: resolve FleetService (with ICredentialStore and IAuditTrailService from DI), prompt for targets (parse comma-separated from text input), prompt for results directory, call CollectArtifactsAsync then GeneratePerHostCkl. Update FleetStatusText with results. Then automatically run fleet summary if collection succeeds.
- `AsyncRelayCommand FleetSummaryCommand` — handler: prompt for results directory (or use FleetResultsDirectory), instantiate FleetSummaryService, call GenerateSummary, call WriteSummaryFiles. Update LastFleetSummary, FleetComplianceStats, FleetWideCompliance. Set FleetStatusText to summary.
- `AsyncRelayCommand FleetApplyCommand` — handler: delegate to existing fleet-apply logic (resolve FleetService, execute). Update fleet status after completion.
- `AsyncRelayCommand FleetVerifyCommand` — similar to FleetApplyCommand for verify operation.

Initialize in a partial InitializeFleetCommands method.</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles.</verify>
  <done>MainViewModel.Fleet.cs provides FleetCollectCommand, FleetSummaryCommand, and compliance state properties for FleetView binding.</done>
</task>

<task type="auto">
  <name>Task 4: Update FleetView.xaml with compliance table and fleet controls</name>
  <files>src/STIGForge.App/Views/FleetView.xaml, src/STIGForge.App/Views/FleetView.xaml.cs</files>
  <action>Replace the minimal FleetView.xaml with a functional layout.

Layout structure:
1. **Header section**: "Fleet Operations" title. Targets text input (TextBox bound to a fleet targets string property). Results directory text input with folder picker.

2. **Action buttons row**: Fleet Apply, Fleet Verify, Fleet Collect, Fleet Summary buttons. Each bound to the corresponding command. All disable when IsFleetRunning is true.

3. **Fleet Compliance Table** (visible after summary): DataGrid bound to FleetComplianceStats. Columns: Host Name, Total Controls, Pass, Fail, NA, NR, Compliance %. Use conditional row coloring: green for >= 80%, yellow for 50-79%, red for < 50%.

4. **Fleet-Wide Summary** (visible after summary): Large compliance percentage display (e.g., "Fleet Compliance: 72.3%"). Total hosts, total controls, total failing controls.

5. **Status bar**: FleetStatusText at the bottom.

Keep FleetView.xaml.cs minimal. All logic in ViewModel.</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles.</verify>
  <done>FleetView shows fleet action buttons, per-host compliance DataGrid, and fleet-wide compliance summary. All bound to MainViewModel.Fleet.cs properties.</done>
</task>

</tasks>

<verification>
- `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles cleanly
- ExportView.xaml bindings match MainViewModel.Export.cs property names
- FleetView.xaml bindings match MainViewModel.Fleet.cs property names
- No XAML binding errors at compile time
- Full solution `dotnet build` passes
</verification>

<success_criteria>
WPF integration is complete: ExportView displays submission readiness checklist with go/no-go signal, package hash, and attestation import. FleetView displays per-host compliance table with conditional coloring, fleet-wide compliance, and fleet operations buttons.
</success_criteria>

<output>
After completion, create `.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-04-SUMMARY.md`
</output>
