---
phase: 05-proof-packaging-fleet-lite-and-integrity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Export/EmassExporter.cs
  - src/STIGForge.Export/ExportModels.cs
  - src/STIGForge.Export/EmassPackageValidator.cs
  - src/STIGForge.Export/AttestationImporter.cs
  - src/STIGForge.Cli/Commands/ExportCommands.cs
  - tests/STIGForge.UnitTests/Export/ExportDeterminismTests.cs
  - tests/STIGForge.UnitTests/Export/AttestationImporterTests.cs
autonomous: true
requirements:
  - EXP-01
must_haves:
  truths:
    - "JSON exports use sorted keys via JsonSerializerOptions with PropertyNamingPolicy and a custom key-sorting converter"
    - "CSV exports use deterministic row ordering by ControlId (VulnId sort key)"
    - "Export metadata timestamps use a fixed export-start time captured once at the beginning of ExportAsync, not per-file DateTimeOffset.Now"
    - "manifest.json includes fileCount, packageHash (SHA-256 of file_hashes.sha256), and submissionReadiness block"
    - "EmassPackageValidator checks submissionReadiness flags and produces a submission readiness checklist in the validation report"
    - "import-attestations CLI command merges filled CSV back into attestation JSON"
    - "export-emass CLI command invokes EmassExporter.ExportAsync with all required options"
  artifacts:
    - path: "src/STIGForge.Export/EmassExporter.cs"
      provides: "Deterministic export with fixed timestamps, sorted keys, packageHash, and submissionReadiness"
      contains: "exportStartTime, fileCount, packageHash, submissionReadiness, SubmissionReadiness"
    - path: "src/STIGForge.Export/ExportModels.cs"
      provides: "SubmissionReadiness model for manifest.json"
      contains: "SubmissionReadiness, AllControlsCovered, EvidencePresent, PoamComplete, AttestationsComplete"
    - path: "src/STIGForge.Export/EmassPackageValidator.cs"
      provides: "Submission readiness validation and checklist"
      contains: "ValidateSubmissionReadiness, SubmissionReadinessChecklist"
    - path: "src/STIGForge.Export/AttestationImporter.cs"
      provides: "CSV-to-JSON attestation merge service"
      contains: "ImportAttestations, MergeAttestations, ParseAttestationCsv"
    - path: "src/STIGForge.Cli/Commands/ExportCommands.cs"
      provides: "export-emass and import-attestations CLI commands"
      contains: "export-emass, import-attestations, --bundle, --output, --package, --file"
    - path: "tests/STIGForge.UnitTests/Export/ExportDeterminismTests.cs"
      provides: "Tests for export determinism guarantees"
      contains: "SortedKeys_JsonOutput, FixedTimestamp_AcrossFiles, PackageHash_MatchesHashManifest, SubmissionReadiness_InManifest"
    - path: "tests/STIGForge.UnitTests/Export/AttestationImporterTests.cs"
      provides: "Tests for attestation CSV import/merge"
      contains: "Import_MergesCsvIntoJson, Import_UpdatesComplianceStatus, Import_SkipsEmptyRows"
  key_links:
    - from: "src/STIGForge.Cli/Commands/ExportCommands.cs"
      to: "EmassExporter"
      via: "export-emass handler invokes ExportAsync"
      pattern: "ExportAsync"
    - from: "src/STIGForge.Cli/Commands/ExportCommands.cs"
      to: "AttestationImporter"
      via: "import-attestations handler invokes ImportAttestations"
      pattern: "ImportAttestations"
    - from: "src/STIGForge.Export/EmassExporter.cs"
      to: "SubmissionReadiness"
      via: "WriteManifest includes submissionReadiness block"
      pattern: "submissionReadiness"
---

<objective>
Harden eMASS export for determinism, add packageHash and submissionReadiness to manifest, add attestation CSV import, and register export-emass CLI command.

Purpose: EXP-01 requires export to produce CKL, standalone POA&M, and deterministic eMASS package with indices, checksums, and attestations. The existing EmassExporter pipeline works but lacks determinism guarantees (sorted keys, fixed timestamps), package-level integrity proof (packageHash), submission readiness signals, attestation ingestion, and a CLI command. Per CONTEXT.md: JSON sorted keys, CSV sorted by ControlId, fixed export-start timestamp, manifest.json gains fileCount/packageHash/submissionReadiness, and `import-attestations` merges filled CSV back into attestation JSON.
Output: Deterministic EmassExporter, SubmissionReadiness model, enhanced EmassPackageValidator, AttestationImporter service, export-emass and import-attestations CLI commands, unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-CONTEXT.md
@.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-RESEARCH.md
@src/STIGForge.Export/EmassExporter.cs
@src/STIGForge.Export/ExportModels.cs
@src/STIGForge.Export/EmassPackageValidator.cs
@src/STIGForge.Export/AttestationGenerator.cs
@src/STIGForge.Cli/Commands/ExportCommands.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export determinism to EmassExporter and SubmissionReadiness model</name>
  <files>src/STIGForge.Export/EmassExporter.cs, src/STIGForge.Export/ExportModels.cs</files>
  <action>In ExportModels.cs, add a `SubmissionReadiness` class with bool properties: `AllControlsCovered`, `EvidencePresent`, `PoamComplete`, `AttestationsComplete`, and a computed `bool IsReady => AllControlsCovered && EvidencePresent && PoamComplete && AttestationsComplete`.

In EmassExporter.ExportAsync, apply the following determinism changes:

1. **Fixed export timestamp**: At the top of ExportAsync, capture `var exportStartTime = DateTimeOffset.Now;`. Replace all subsequent `DateTimeOffset.Now` references with `exportStartTime` throughout the method (manifest createdAt, export_log.txt, attestation GeneratedAt).

2. **Sorted JSON keys**: Create a private static readonly `JsonSerializerOptions DeterministicJsonOptions` with `WriteIndented = true`, `PropertyNamingPolicy = JsonNamingPolicy.CamelCase`, and `DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull`. Use this for all JSON serialization in the exporter (manifest, validation report JSON). Note: System.Text.Json serializes properties in declaration order, which is deterministic. The key requirement is consistent naming policy across all outputs.

3. **Manifest enhancements**: In WriteManifest, add to the anonymous manifest object: `fileCount` (count of files in the hash manifest), `packageHash` (compute after WriteHashManifestAsync by reading file_hashes.sha256 and computing its SHA-256), and a `submissionReadiness` object. Compute submissionReadiness by checking: allControlsCovered = consolidated results count > 0 and no NotReviewed results remain, evidencePresent = evidence directory has files, poamComplete = poam.json exists and has items, attestationsComplete = all attestation records have ComplianceStatus != "Pending".

4. **Reorder manifest write**: Move WriteManifest call to AFTER WriteHashManifestAsync so packageHash is available. Compute packageHash by reading file_hashes.sha256 and hashing it with _hash.Sha256FileAsync.

5. **Fixed export-log timestamp**: In the export_log.txt write, use exportStartTime instead of DateTimeOffset.Now.</action>
  <verify>`dotnet build src/STIGForge.Export/STIGForge.Export.csproj` compiles. Existing EmassExporter tests still pass: `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter EmassExporter`. Existing integration tests pass: `dotnet test tests/STIGForge.IntegrationTests/STIGForge.IntegrationTests.csproj --filter EmassExporter`.</verify>
  <done>EmassExporter uses fixed export-start timestamp, consistent JSON serialization, manifest includes fileCount/packageHash/submissionReadiness. SubmissionReadiness model added to ExportModels.cs.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance EmassPackageValidator with submission readiness checks</name>
  <files>src/STIGForge.Export/EmassPackageValidator.cs</files>
  <action>Add a new method `ValidateSubmissionReadiness(string root, List<string> errors, List<string> warnings, ValidationMetrics metrics)` called from ValidatePackage after ValidateContentIntegrity.

The method reads `manifest.json`, extracts the `submissionReadiness` object, and checks each flag:
- If `allControlsCovered` is false: add warning "Not all controls have been reviewed (some remain NotReviewed)"
- If `evidencePresent` is false: add warning "No evidence files found for controls"
- If `poamComplete` is false: add warning "POA&M may be incomplete"
- If `attestationsComplete` is false: add warning "Some attestations are still Pending"

Add a `SubmissionReadinessChecklist` section to WriteValidationReport that lists each readiness criterion with pass/fail status. Format:
```
SUBMISSION READINESS:
  [PASS] All controls covered
  [FAIL] Evidence present
  [PASS] POA&M complete
  [FAIL] Attestations complete
  Verdict: NOT READY
```

Add `SubmissionReadinessResult` to ValidationMetrics with bool properties matching the readiness flags, so it appears in both text and JSON validation reports.</action>
  <verify>`dotnet build src/STIGForge.Export/STIGForge.Export.csproj` compiles. `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter EmassPackageValidator` — existing tests pass.</verify>
  <done>EmassPackageValidator checks submissionReadiness from manifest and produces a submission readiness checklist in the validation report. Both text and JSON reports include readiness status.</done>
</task>

<task type="auto">
  <name>Task 3: Create AttestationImporter and register export-emass + import-attestations CLI commands</name>
  <files>src/STIGForge.Export/AttestationImporter.cs, src/STIGForge.Cli/Commands/ExportCommands.cs</files>
  <action>Create AttestationImporter.cs in src/STIGForge.Export/ as a static class with:

1. `static AttestationImportResult ImportAttestations(string packageRoot, string csvFilePath)` — reads the filled CSV file (attestation_template.csv format), reads existing attestations.json from `05_Attestations/`, merges by ControlId: for each CSV row with non-empty ComplianceStatus (not "Pending"), update the matching AttestationRecord's AttestorName, AttestorRole, AttestationDate, ComplianceStatus, ComplianceEvidence, Limitations, NextReviewDate. Write updated attestations.json back. Return AttestationImportResult with Updated count, Skipped count, NotFound count.

2. `static List<AttestationCsvRow> ParseAttestationCsv(string csvPath)` — parses the CSV with header matching (column index by header name, tolerant of extra columns). Skip rows where ControlId is empty.

3. `AttestationImportResult` class: `int Updated`, `int Skipped`, `int NotFound`, `List<string> NotFoundControls`.

In ExportCommands.cs, add two new command registrations:

1. `export-emass` command: options `--bundle` (required), `--output` (optional output root override). Handler: resolve IPathBuilder, IHashingService, IAuditTrailService from DI, instantiate EmassExporter, call ExportAsync. Print: output root, control count, validation result, submission readiness status.

2. `import-attestations` command: options `--package` (required, eMASS package root), `--file` (required, path to filled attestation CSV). Handler: call AttestationImporter.ImportAttestations(package, file). Print: updated/skipped/notfound counts. If notFoundControls has entries, list them.</action>
  <verify>`dotnet build src/STIGForge.Export/STIGForge.Export.csproj` and `dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj` compile. `dotnet run --project src/STIGForge.Cli -- export-emass --help` shows usage. `dotnet run --project src/STIGForge.Cli -- import-attestations --help` shows usage.</verify>
  <done>AttestationImporter merges filled CSV into attestation JSON. export-emass and import-attestations CLI commands are registered and functional.</done>
</task>

<task type="auto">
  <name>Task 4: Add export determinism and attestation import tests</name>
  <files>tests/STIGForge.UnitTests/Export/ExportDeterminismTests.cs, tests/STIGForge.UnitTests/Export/AttestationImporterTests.cs</files>
  <action>Create ExportDeterminismTests.cs with xUnit tests:

1. `FixedTimestamp_UsedInManifest` — create a mock bundle, run EmassExporter.ExportAsync, parse output manifest.json, verify createdAt matches the export start time (within 1 second tolerance), not the file write time.
2. `PackageHash_MatchesHashManifest` — run export, read file_hashes.sha256, compute its SHA-256, compare to packageHash in manifest.json.
3. `SubmissionReadiness_AllTrue_WhenComplete` — set up bundle with all controls reviewed, evidence present, POA&M items, and all attestations non-Pending. Verify submissionReadiness.isReady == true in manifest.
4. `SubmissionReadiness_False_WhenPendingAttestations` — set up bundle with Pending attestations. Verify attestationsComplete == false.
5. `CsvRowOrdering_DeterministicByControlId` — verify control_evidence_index.csv rows are sorted by VulnId/RuleId.

Create AttestationImporterTests.cs:

1. `Import_MergesCsvIntoJson` — create attestations.json with 3 Pending records, create CSV with 2 filled records (Compliant, NonCompliant), import. Verify 2 updated, 1 skipped (still Pending).
2. `Import_UpdatesAllFields` — import one record, verify AttestorName, AttestorRole, AttestationDate, ComplianceStatus, ComplianceEvidence, Limitations, NextReviewDate are all updated from CSV.
3. `Import_SkipsEmptyRows` — CSV with blank ControlId rows. Verify they are silently skipped.
4. `Import_ReportsNotFoundControls` — CSV with a ControlId not in attestations.json. Verify NotFound = 1 and NotFoundControls contains the ID.

Use temp directories for all file I/O. Follow existing test patterns (xUnit, FluentAssertions where used, temp dirs with cleanup).</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "ExportDeterminism|AttestationImporter"` — all tests pass.</verify>
  <done>Export determinism tests verify fixed timestamps, packageHash, submissionReadiness, and CSV ordering. Attestation importer tests verify CSV merge, field updates, empty row handling, and not-found reporting.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes for Export, Cli, and UnitTests projects
- `dotnet test --filter "ExportDeterminism|AttestationImporter|EmassExporter|EmassPackageValidator"` — all tests pass (new and existing)
- `export-emass --help` and `import-attestations --help` show correct options
- manifest.json contains fileCount, packageHash, and submissionReadiness block
- Validation report includes submission readiness checklist
</verification>

<success_criteria>
EXP-01 is satisfied: eMASS export is deterministic (sorted keys, fixed timestamps), manifest includes packageHash and submissionReadiness, validation report has submission readiness checklist, attestation CSV import works, and both export-emass and import-attestations CLI commands are operational.
</success_criteria>

<output>
After completion, create `.planning/phases/05-proof-packaging-fleet-lite-and-integrity/05-01-SUMMARY.md`
</output>
