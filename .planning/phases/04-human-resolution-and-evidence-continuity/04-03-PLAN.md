---
phase: 04-human-resolution-and-evidence-continuity
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/STIGForge.Core/Services/BaselineDiffService.cs
  - src/STIGForge.Core/Services/AnswerRebaseService.cs
  - src/STIGForge.Cli/Commands/DiffRebaseCommands.cs
  - tests/STIGForge.UnitTests/Core/AnswerImpactTests.cs
  - tests/STIGForge.UnitTests/Core/AnswerRebaseServiceTests.cs
autonomous: true
requirements:
  - REB-01
  - REB-02
must_haves:
  truths:
    - "Pack diff output includes answer impact assessment (valid/uncertain/invalid) when answers exist for a bundle"
    - "diff-packs CLI displays answer impact column when --bundle is provided"
    - "AnswerRebaseService produces confidence-scored actions mirroring OverlayRebaseService pattern"
    - "Answer rebase auto-carries unchanged controls (confidence >= 0.8) and blocks removed controls with existing answers"
    - "rebase-answers CLI writes answers_rebased.json with lineage tracking fields"
  artifacts:
    - path: "src/STIGForge.Core/Services/BaselineDiffService.cs"
      provides: "Answer impact assessment on ControlDiff entries"
      contains: "AnswerImpact, AnswerValidity, AssessAnswerImpact"
    - path: "src/STIGForge.Core/Services/AnswerRebaseService.cs"
      provides: "Answer rebase with confidence scoring and blocking conflicts"
      contains: "AnswerRebaseService, AnswerRebaseReport, AnswerRebaseAction, RebaseAnswersAsync, ApplyAnswerRebaseAsync"
    - path: "src/STIGForge.Cli/Commands/DiffRebaseCommands.cs"
      provides: "Extended diff-packs with --bundle and new rebase-answers command"
      contains: "rebase-answers, --bundle, answers_rebased.json"
    - path: "tests/STIGForge.UnitTests/Core/AnswerRebaseServiceTests.cs"
      provides: "Tests for answer rebase confidence, blocking, and lineage"
      contains: "UnchangedControl_AutoCarry, RemovedControl_BlockingConflict, HighImpactChange_ReviewRequired"
  key_links:
    - from: "src/STIGForge.Core/Services/AnswerRebaseService.cs"
      to: "BaselineDiffService"
      via: "ComparePacksAsync for diff input"
      pattern: "ComparePacksAsync"
    - from: "src/STIGForge.Core/Services/AnswerRebaseService.cs"
      to: "ManualAnswerService"
      via: "LoadAnswerFile for source answers"
      pattern: "LoadAnswerFile|ExportAnswers"
    - from: "src/STIGForge.Core/Services/BaselineDiffService.cs"
      to: "ManualAnswerService"
      via: "Answer lookup for impact assessment"
      pattern: "AssessAnswerImpact|AnswerValidity"
---

<objective>
Add answer impact assessment to pack diff and create AnswerRebaseService for carrying manual answers across STIG version updates with confidence scoring.

Purpose: REB-01 requires pack diff to report add/remove/text/mapping deltas with answer impact. REB-02 requires answer rebase to auto-carry high-confidence matches and route uncertain carries for review. This plan extends BaselineDiffService with answer validity scoring and creates AnswerRebaseService mirroring the proven OverlayRebaseService pattern.
Output: Answer impact on diff, AnswerRebaseService with confidence scoring, rebase-answers CLI command, unit tests for both features.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-human-resolution-and-evidence-continuity/04-CONTEXT.md
@.planning/phases/04-human-resolution-and-evidence-continuity/04-RESEARCH.md
@src/STIGForge.Core/Services/BaselineDiffService.cs
@src/STIGForge.Core/Services/OverlayRebaseService.cs
@src/STIGForge.Core/Services/ManualAnswerService.cs
@src/STIGForge.Cli/Commands/DiffRebaseCommands.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add answer impact assessment to BaselineDiffService and create AnswerRebaseService</name>
  <files>src/STIGForge.Core/Services/BaselineDiffService.cs, src/STIGForge.Core/Services/AnswerRebaseService.cs</files>
  <action>**Part A — Answer Impact on Diff (BaselineDiffService.cs):**

Add an `AnswerValidity` enum: `Valid`, `Uncertain`, `Invalid`, `NoAnswer`.

Add an `AnswerImpact` class: `string ControlKey`, `AnswerValidity Validity`, `string Reason`, `ManualAnswer? ExistingAnswer`.

Add `AnswerImpact? AnswerImpact` property to the existing `ControlDiff` class (nullable — only populated when answers exist).

Add a method `void AssessAnswerImpact(BaselineDiff diff, AnswerFile answerFile)` to BaselineDiffService. For each ControlDiff in diff.ModifiedControls: look up the answer by control key (RuleId match from AnswerFile). If no answer: set AnswerImpact with Validity=NoAnswer. If answer exists: apply the validity logic from CONTEXT.md decisions:
- CheckText unchanged → Valid ("Answer still applies — check criteria unchanged")
- CheckText changed but FixText same → Uncertain ("Check criteria changed but remediation unchanged — review recommended")
- Both CheckText and FixText changed → Invalid ("Both check and fix criteria changed — answer likely invalid")

For diff.RemovedControls with answers: Validity=Invalid, Reason="Control removed from baseline".
For diff.AddedControls: no answer impact (new controls have no prior answers).

**Part B — AnswerRebaseService (new file):**

Create AnswerRebaseService.cs mirroring OverlayRebaseService's structure exactly:

Models (in same file, same pattern as OverlayRebaseService):
- `AnswerRebaseReport`: `string BundleRoot`, `string BaselinePackId`, `string NewPackId`, `DateTimeOffset RebasedAt`, `bool Success`, `string? ErrorMessage`, `List<AnswerRebaseAction> Actions`, `double OverallConfidence = 1.0`, `int SafeActions`, `int ReviewNeeded`, `int HighRisk`, `int BlockingConflicts`, `bool HasBlockingConflicts => BlockingConflicts > 0`.
- `AnswerRebaseAction`: `string ControlKey`, `AnswerRebaseActionType ActionType`, `string Reason`, `string RecommendedAction`, `double Confidence`, `bool RequiresReview`, `bool IsBlockingConflict`, `ManualAnswer? OriginalAnswer`, `List<ControlFieldChange> FieldChanges`.
- `AnswerRebaseActionType` enum: `Carry` (unchanged, confidence 1.0), `CarryWithWarning` (minor change, 0.5-0.8), `ReviewRequired` (major change, < 0.5), `Remove` (control deleted), `Remap` (future).

Service class `AnswerRebaseService`:
- Constructor: `ManualAnswerService answerService`, `BaselineDiffService diffService`, `IAuditTrailService? audit = null`.
- `async Task<AnswerRebaseReport> RebaseAnswersAsync(string bundleRoot, string baselinePackId, string newPackId, CancellationToken ct)`:
  1. Load AnswerFile via ManualAnswerService.LoadAnswerFile(bundleRoot).
  2. Get diff via BaselineDiffService.ComparePacksAsync(baselinePackId, newPackId).
  3. For each answer in AnswerFile.Answers: find in diff. Use same DetermineRebaseAction pattern as OverlayRebaseService but operating on ManualAnswer instead of ControlOverride. Confidence thresholds per CONTEXT.md: >= 0.8 auto-carry, 0.5-0.8 carry-with-warning, < 0.5 review-required.
  4. Removed controls with existing answers → IsBlockingConflict=true.
  5. Unchanged controls → ActionType=Carry, Confidence=1.0.
  6. Modified controls: high-impact changes → ReviewRequired (Confidence=0.4), medium-impact → CarryWithWarning (Confidence=0.7), low-impact only → Carry (Confidence=0.9).
  7. Populate summary counts (SafeActions, ReviewNeeded, HighRisk, BlockingConflicts).
  8. Audit trail (same fire-and-forget pattern as OverlayRebaseService).

- `AnswerFile ApplyAnswerRebase(AnswerRebaseReport report, AnswerFile sourceAnswers)`:
  1. If report.HasBlockingConflicts → throw InvalidOperationException (same pattern as OverlayRebaseService.ApplyRebaseAsync).
  2. Create new AnswerFile. For each action that is not Remove and not blocking: copy the original answer. For CarryWithWarning: append "[REBASED: {Confidence:P0}]" to Comment.
  3. Add lineage fields: for each rebased answer, set Comment prefix with rebase metadata (originalAnswerAt, rebasedAt, rebaseConfidence) since ManualAnswer model doesn't have dedicated lineage fields — use Comment as the carrier.
  4. Return the rebased AnswerFile.</action>
  <verify>`dotnet build src/STIGForge.Core/STIGForge.Core.csproj` compiles. Grep for AnswerRebaseService and AssessAnswerImpact.</verify>
  <done>AnswerImpact on ControlDiff populated with Valid/Uncertain/Invalid scoring. AnswerRebaseService mirrors OverlayRebaseService with confidence thresholds from CONTEXT.md. Blocking conflicts enforced for removed controls.</done>
</task>

<task type="auto">
  <name>Task 2: Add rebase-answers CLI command, extend diff-packs with --bundle, and add unit tests</name>
  <files>src/STIGForge.Cli/Commands/DiffRebaseCommands.cs, tests/STIGForge.UnitTests/Core/AnswerImpactTests.cs, tests/STIGForge.UnitTests/Core/AnswerRebaseServiceTests.cs</files>
  <action>**Part A — Extend diff-packs command:**

In DiffRebaseCommands.cs, add a `--bundle` option (optional, string) to the existing `diff-packs` command. When --bundle is provided: after computing the diff, instantiate ManualAnswerService, load AnswerFile from the bundle, call BaselineDiffService.AssessAnswerImpact(diff, answerFile). In the console output, add an "Answer Impact" column to the changed controls section: `{AnswerImpact.Validity} — {AnswerImpact.Reason}`. In the markdown report (when --output provided), add an "Answer Impact" section listing controls with their validity assessment.

**Part B — Add rebase-answers command:**

Register `rebase-answers` command with options: `--bundle` (required, string — source bundle with answers), `--baseline` (required, string — baseline pack ID), `--target` (required, string — target pack ID), `--apply` (optional, bool — apply the rebase and write answers_rebased.json), `--output` (optional, string — write report to file), `--json` (optional, bool — JSON output).

Handler pattern (mirror rebase-overlay exactly):
1. Build host, get AnswerRebaseService from DI (register it — or construct manually: `new AnswerRebaseService(new ManualAnswerService(), diffService, audit)`).
2. Call RebaseAnswersAsync(bundle, baseline, target).
3. If not success: error and exit.
4. Print summary: overall confidence, safe/review/blocking/high-risk counts.
5. Print action table (same icon pattern as rebase-overlay: OK/~~/!!/--/=>).
6. If --json: serialize report. If --output: write markdown report.
7. If --apply: check for blocking conflicts (same guard as rebase-overlay). If clear: call ApplyAnswerRebase, serialize result to `{bundleRoot}/Manual/answers_rebased.json` (alongside the original answers.json). The rebased file includes lineage metadata in comments. Print "Rebased answers written to: {path}".

**Part C — Unit tests:**

Create AnswerImpactTests.cs:
- `CheckTextUnchanged_AnswerValid` — modify only FixText in control, assess impact, assert Valid.
- `CheckTextChanged_FixTextSame_AnswerUncertain` — modify only CheckText, assert Uncertain.
- `BothChanged_AnswerInvalid` — modify both CheckText and FixText, assert Invalid.
- `NoAnswer_NoImpact` — control modified but no answer exists, assert NoAnswer.

Create AnswerRebaseServiceTests.cs:
- `UnchangedControl_AutoCarry` — answer for unchanged control, assert ActionType=Carry, Confidence=1.0.
- `RemovedControl_BlockingConflict` — answer for removed control, assert IsBlockingConflict=true, ActionType=Remove.
- `HighImpactChange_ReviewRequired` — answer for control with CheckText change, assert ActionType=ReviewRequired, Confidence < 0.5.
- `LowImpactChange_Carry` — answer for control with only Discussion change, assert ActionType=Carry, Confidence >= 0.8.
- `ApplyRebase_BlocksOnConflicts` — report with blocking conflicts, assert ApplyAnswerRebase throws InvalidOperationException.
- `ApplyRebase_WritesRebasedAnswers` — clean report, apply rebase, assert output AnswerFile contains carried answers with rebase metadata in Comments.

Use NSubstitute for IControlRepository mock (needed by BaselineDiffService). Set up mock control lists for baseline and target packs to produce the desired diff scenarios.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "AnswerImpact|AnswerRebaseService"` — all tests pass. `dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj` compiles.</verify>
  <done>diff-packs --bundle shows answer validity per changed control. rebase-answers CLI produces confidence report and writes answers_rebased.json with lineage. 10 unit tests pass covering impact assessment and rebase logic.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes for Core and Cli projects
- `dotnet test --filter "AnswerImpact|AnswerRebaseService"` — all 10 tests pass
- Manual verification: diff-packs --baseline A --target B --bundle C shows answer impact column
- Manual verification: rebase-answers --bundle C --baseline A --target B --apply writes answers_rebased.json
</verification>

<success_criteria>
- AnswerImpact on ControlDiff correctly classifies Valid/Uncertain/Invalid based on CheckText/FixText changes
- AnswerRebaseService produces confidence-scored actions mirroring OverlayRebaseService
- Blocking conflicts enforced for removed controls with existing answers
- diff-packs --bundle displays answer impact
- rebase-answers CLI functional with --apply writing answers_rebased.json with lineage
- 10 unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/04-human-resolution-and-evidence-continuity/04-03-SUMMARY.md`
</output>
