---
phase: 04-human-resolution-and-evidence-continuity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Core/Models/ManualAnswer.cs
  - src/STIGForge.Core/Services/ManualAnswerService.cs
  - src/STIGForge.Cli/Commands/ManualCommands.cs
  - tests/STIGForge.UnitTests/Core/ManualAnswerExportImportTests.cs
autonomous: true
requirements:
  - MAN-01
must_haves:
  truths:
    - "Operator can export all manual answers from a bundle to a standalone JSON file with metadata header"
    - "Operator can import answers from a JSON file into a different bundle, matching by RuleId with VulnId fallback"
    - "Import only overwrites answers that are still Open or NotReviewed — resolved answers are never clobbered"
    - "Export metadata includes stigId, exportedAt, and exportedBy fields for traceability"
  artifacts:
    - path: "src/STIGForge.Core/Models/ManualAnswer.cs"
      provides: "AnswerFileExport model with metadata header"
      contains: "AnswerFileExport, StigId, ExportedAt, ExportedBy"
    - path: "src/STIGForge.Core/Services/ManualAnswerService.cs"
      provides: "ExportAnswers and ImportAnswers methods"
      contains: "ExportAnswersAsync, ImportAnswersAsync, AnswerImportResult"
    - path: "src/STIGForge.Cli/Commands/ManualCommands.cs"
      provides: "export-answers and import-answers CLI commands"
      contains: "export-answers, import-answers, --bundle, --output, --file"
    - path: "tests/STIGForge.UnitTests/Core/ManualAnswerExportImportTests.cs"
      provides: "Tests for export/import round-trip and conflict resolution"
      contains: "Export_IncludesMetadata, Import_MatchesByRuleId, Import_SkipsResolvedAnswers"
  key_links:
    - from: "src/STIGForge.Cli/Commands/ManualCommands.cs"
      to: "ManualAnswerService"
      via: "ExportAnswersAsync/ImportAnswersAsync calls"
      pattern: "ExportAnswersAsync|ImportAnswersAsync"
    - from: "src/STIGForge.Core/Services/ManualAnswerService.cs"
      to: "AnswerFile"
      via: "LoadAnswerFile -> export/import serialization"
      pattern: "AnswerFileExport"
---

<objective>
Add answer file export/import to ManualAnswerService with CLI commands for cross-bundle and cross-system answer portability.

Purpose: MAN-01 requires reusable answer files. Operators who resolve manual controls on one system need to reapply those decisions on identical STIG profiles elsewhere. The existing ManualAnswerService already handles persistence and matching — this plan adds export with metadata, import with conflict-safe merge, and CLI commands.
Output: AnswerFileExport model, ExportAnswersAsync/ImportAnswersAsync on ManualAnswerService, export-answers and import-answers CLI commands, unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-human-resolution-and-evidence-continuity/04-CONTEXT.md
@.planning/phases/04-human-resolution-and-evidence-continuity/04-RESEARCH.md
@src/STIGForge.Core/Models/ManualAnswer.cs
@src/STIGForge.Core/Services/ManualAnswerService.cs
@src/STIGForge.Cli/Commands/DiffRebaseCommands.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AnswerFileExport model and export/import methods to ManualAnswerService</name>
  <files>src/STIGForge.Core/Models/ManualAnswer.cs, src/STIGForge.Core/Services/ManualAnswerService.cs</files>
  <action>In ManualAnswer.cs, add a new class `AnswerFileExport` that wraps the existing AnswerFile with export-specific metadata: `string? StigId`, `string? ExportedAt` (ISO 8601 string), `string? ExportedBy` (Environment.UserName at export time), and `AnswerFile Answers` (the existing model). This is the portable format — distinct from the internal AnswerFile stored in bundles.

In ManualAnswerService.cs, add two methods:

1. `AnswerFileExport ExportAnswers(string bundleRoot, string? stigId = null)` — loads the current AnswerFile via LoadAnswerFile, wraps it in AnswerFileExport with metadata populated (ExportedAt = DateTimeOffset.UtcNow.ToString("o"), ExportedBy = Environment.UserName, StigId from parameter or null). Returns the export object. Also add `void WriteExportFile(string outputPath, AnswerFileExport export)` that serializes to JSON with WriteIndented=true and camelCase naming.

2. `AnswerImportResult ImportAnswers(string bundleRoot, AnswerFileExport import)` — loads existing AnswerFile, iterates import.Answers.Answers, for each imported ManualAnswer: find existing answer by RuleId match (case-insensitive), then VulnId fallback. If no existing match: add the imported answer. If existing match with status "Open" (normalized): overwrite with imported answer. If existing match with any other status (Pass, Fail, NotApplicable): skip (do NOT clobber resolved answers). Track counts in a new `AnswerImportResult` class: `int Imported`, `int Skipped`, `int Total`, `List<string> SkippedControls` (RuleId/VulnId of skipped). Save the merged AnswerFile. Also add `AnswerFileExport ReadExportFile(string filePath)` that deserializes from JSON.

Add the `AnswerImportResult` class in ManualAnswerService.cs (same file pattern as ManualProgressStats).</action>
  <verify>`dotnet build src/STIGForge.Core/STIGForge.Core.csproj` compiles. Grep for AnswerFileExport in ManualAnswer.cs and ExportAnswers in ManualAnswerService.cs.</verify>
  <done>AnswerFileExport model exists with StigId/ExportedAt/ExportedBy. ExportAnswers returns wrapped answer file with metadata. ImportAnswers merges with conflict-safe logic (skip resolved). AnswerImportResult tracks counts.</done>
</task>

<task type="auto">
  <name>Task 2: Add export-answers and import-answers CLI commands with unit tests</name>
  <files>src/STIGForge.Cli/Commands/ManualCommands.cs, tests/STIGForge.UnitTests/Core/ManualAnswerExportImportTests.cs</files>
  <action>Create ManualCommands.cs in src/STIGForge.Cli/Commands/ following the same pattern as DiffRebaseCommands.cs (static class with Register method, System.CommandLine commands).

Register two commands:

1. `export-answers` with options: `--bundle` (required, string — bundle root path), `--output` (required, string — output JSON file path), `--stig-id` (optional, string — STIG identifier for metadata). Handler: instantiate ManualAnswerService, call ExportAnswers(bundle, stigId), call WriteExportFile(output, export). Print: "Exported {N} answers to {output}" and metadata summary (StigId, ExportedAt, ExportedBy).

2. `import-answers` with options: `--bundle` (required, string — target bundle root), `--file` (required, string — path to exported JSON file). Handler: instantiate ManualAnswerService, call ReadExportFile(file), call ImportAnswers(bundle, import). Print: "Imported {result.Imported} answers, skipped {result.Skipped} (already resolved)". If SkippedControls.Count > 0, print each skipped control.

Register ManualCommands in the CLI root command registration (find where other Commands.Register calls are made — likely in Program.cs or a registration method — and add ManualCommands.Register).

Create ManualAnswerExportImportTests.cs with xUnit tests:
- `Export_IncludesMetadata` — create a temp bundle dir with an answers.json containing 2 answers, call ExportAnswers, assert ExportedAt is not null, ExportedBy is not null, Answers.Answers.Count == 2.
- `Import_MatchesByRuleId` — create empty target bundle, create AnswerFileExport with 2 answers (Pass, Fail), import, verify both are in target answers.json.
- `Import_SkipsResolvedAnswers` — create target bundle with one answer at status Pass, import file with same RuleId at status Fail, verify target still has Pass (not overwritten).
- `Import_OverwritesOpenAnswers` — create target with one Open answer, import same RuleId with Pass, verify target now has Pass.
- `RoundTrip_ExportThenImport` — export from bundle A, import into empty bundle B, verify identical answers.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter ManualAnswerExportImport` — all tests pass. `dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj` compiles.</verify>
  <done>export-answers and import-answers CLI commands work. Import respects resolved answer protection. Round-trip export/import preserves all answer data. All 5 tests pass.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes for Core and Cli projects
- `dotnet test --filter ManualAnswerExportImport` — all tests pass
- Manual verification: create temp bundle with answers, run export-answers, inspect JSON output for metadata fields, run import-answers into empty bundle, verify answers appear
</verification>

<success_criteria>
- AnswerFileExport model has StigId, ExportedAt, ExportedBy metadata
- ExportAnswers wraps answer file with metadata header
- ImportAnswers merges with conflict-safe logic: Open/NotReviewed overwritten, resolved answers protected
- CLI export-answers and import-answers commands registered and functional
- 5 unit tests passing covering round-trip, conflict resolution, and metadata
</success_criteria>

<output>
After completion, create `.planning/phases/04-human-resolution-and-evidence-continuity/04-01-SUMMARY.md`
</output>
