---
phase: 04-human-resolution-and-evidence-continuity
plan: 04
type: execute
wave: 2
depends_on: [04-01, 04-03]
files_modified:
  - src/STIGForge.App/ViewModels/ManualCheckWizardViewModel.cs
  - src/STIGForge.App/Views/ManualCheckWizard.xaml
  - src/STIGForge.App/ViewModels/AnswerRebaseWizardViewModel.cs
  - src/STIGForge.App/Views/AnswerRebaseWizard.xaml
  - src/STIGForge.App/Views/AnswerRebaseWizard.xaml.cs
  - src/STIGForge.App/ViewModels/DiffViewerViewModel.cs
  - src/STIGForge.App/Views/DiffViewer.xaml
autonomous: true
requirements:
  - MAN-01
  - REB-01
  - REB-02
must_haves:
  truths:
    - "ManualCheckWizard toolbar has Export Answers and Import Answers buttons"
    - "Export button writes answer file to user-selected path via SaveFileDialog"
    - "Import button reads answer file, reports import result counts to operator"
    - "AnswerRebaseWizard follows 3-step flow matching RebaseWizard (Select -> Analyze -> Apply)"
    - "DiffViewer shows answer impact column when answers exist for the bundle"
  artifacts:
    - path: "src/STIGForge.App/ViewModels/ManualCheckWizardViewModel.cs"
      provides: "Export/Import commands on ManualCheckWizard"
      contains: "ExportAnswersCommand, ImportAnswersCommand, SaveFileDialog, OpenFileDialog"
    - path: "src/STIGForge.App/ViewModels/AnswerRebaseWizardViewModel.cs"
      provides: "3-step answer rebase wizard ViewModel"
      contains: "AnswerRebaseWizardViewModel, AnalyzeRebase, ApplyRebase, WizardScreen"
    - path: "src/STIGForge.App/Views/AnswerRebaseWizard.xaml"
      provides: "Answer rebase wizard XAML layout"
      contains: "AnswerRebaseWizard, Welcome, Analysis, Completion"
    - path: "src/STIGForge.App/ViewModels/DiffViewerViewModel.cs"
      provides: "Answer impact display integration in DiffViewer"
      contains: "AnswerImpact, AnswerValidity"
  key_links:
    - from: "src/STIGForge.App/ViewModels/ManualCheckWizardViewModel.cs"
      to: "ManualAnswerService"
      via: "ExportAnswers/ImportAnswers calls"
      pattern: "ExportAnswers|ImportAnswers"
    - from: "src/STIGForge.App/ViewModels/AnswerRebaseWizardViewModel.cs"
      to: "AnswerRebaseService"
      via: "RebaseAnswersAsync call"
      pattern: "RebaseAnswersAsync"
---

<objective>
Add WPF answer export/import toolbar buttons to ManualCheckWizard, create AnswerRebaseWizard with 3-step flow, and integrate answer impact display into DiffViewer.

Purpose: MAN-01 requires WPF export/import buttons on ManualView toolbar. REB-01 requires answer impact visibility in DiffViewer. REB-02 requires an AnswerRebaseWizard following the same 3-step pattern as the existing RebaseWizard. This plan adds all WPF surfaces for Phase 4 features.
Output: Export/Import buttons on ManualCheckWizard, AnswerRebaseWizard (XAML + ViewModel), answer impact in DiffViewer.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-human-resolution-and-evidence-continuity/04-CONTEXT.md
@.planning/phases/04-human-resolution-and-evidence-continuity/04-RESEARCH.md
@src/STIGForge.App/ViewModels/ManualCheckWizardViewModel.cs
@src/STIGForge.App/ViewModels/RebaseWizardViewModel.cs
@src/STIGForge.App/ViewModels/DiffViewerViewModel.cs
@src/STIGForge.Core/Services/ManualAnswerService.cs
@src/STIGForge.Core/Services/AnswerRebaseService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export/import buttons to ManualCheckWizard and answer impact to DiffViewer</name>
  <files>src/STIGForge.App/ViewModels/ManualCheckWizardViewModel.cs, src/STIGForge.App/Views/ManualCheckWizard.xaml, src/STIGForge.App/ViewModels/DiffViewerViewModel.cs, src/STIGForge.App/Views/DiffViewer.xaml</files>
  <action>**Part A — ManualCheckWizard export/import:**

In ManualCheckWizardViewModel.cs, add two RelayCommand methods:

1. `ExportAnswers()` — show SaveFileDialog (filter: "JSON files (*.json)|*.json", default extension "json", suggested filename "answers_export_{timestamp}.json"). If user confirms: call `_answerService.ExportAnswers(_bundleRoot)`, then `_answerService.WriteExportFile(dialog.FileName, export)`. Set EvidenceStatus to "Exported {N} answers to {path}". Catch and display errors via EvidenceStatus.

2. `ImportAnswers()` — show OpenFileDialog (filter: "JSON files (*.json)|*.json"). If user confirms: call `_answerService.ReadExportFile(dialog.FileName)`, then `_answerService.ImportAnswers(_bundleRoot, import)`. Set EvidenceStatus to "Imported {result.Imported} answers, skipped {result.Skipped} already resolved". Reload stats via LoadStats(). If SkippedControls.Count > 0: append list of skipped controls to status. Catch and display errors.

In ManualCheckWizard.xaml, add a toolbar StackPanel (horizontal, aligned right) on the Welcome screen containing two buttons: "Export Answers" (bound to ExportAnswersCommand) and "Import Answers" (bound to ImportAnswersCommand). Style consistently with existing wizard buttons.

**Part B — DiffViewer answer impact:**

In DiffViewerViewModel.cs, add an optional `string? BundleRoot` property. Add a method `void LoadAnswerImpact(string bundleRoot)` that creates ManualAnswerService, loads AnswerFile, calls BaselineDiffService.AssessAnswerImpact on the current diff result. Add an observable collection or update the existing modified controls display to include AnswerImpact.Validity and AnswerImpact.Reason columns.

In DiffViewer.xaml, in the modified controls DataGrid/ListView, add two columns: "Answer Status" (bound to AnswerImpact.Validity, with color coding — Valid=green, Uncertain=orange, Invalid=red, NoAnswer=gray) and "Impact" (bound to AnswerImpact.Reason). These columns should be visible only when BundleRoot is set (use Visibility binding or conditional column generation). Per CONTEXT.md Claude's discretion: show impact in the existing DiffViewer tabs (add columns to the existing modified controls grid rather than a separate tab).</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles. Grep for ExportAnswersCommand and AnswerImpact in the App project.</verify>
  <done>ManualCheckWizard has Export/Import toolbar buttons with SaveFileDialog/OpenFileDialog. DiffViewer shows answer validity columns for modified controls when bundle context is available.</done>
</task>

<task type="auto">
  <name>Task 2: Create AnswerRebaseWizard with 3-step flow mirroring RebaseWizard</name>
  <files>src/STIGForge.App/ViewModels/AnswerRebaseWizardViewModel.cs, src/STIGForge.App/Views/AnswerRebaseWizard.xaml, src/STIGForge.App/Views/AnswerRebaseWizard.xaml.cs</files>
  <action>Create AnswerRebaseWizardViewModel.cs following RebaseWizardViewModel.cs exactly as the structural template:

**ViewModel properties (mirror RebaseWizard):**
- WizardScreen enum: Welcome, Analysis, Completion (reuse pattern, define in this file or share)
- CurrentScreen, StepText
- Welcome screen: AvailablePacks (List<ContentPack>), SelectedBaselinePack, SelectedTargetPack, BundleRoot (string — the bundle containing answers to rebase)
- Analysis screen: TotalAnswers, AutoCarriedCount, NeedsReviewCount, BlockingConflictCount, SafeActionCount, HighRiskCount, OverallConfidenceDisplay, BlockingConflictSummary, AnalysisStatus, RecoveryGuidance, AutoCarriedActions (List<AnswerRebaseActionDisplay>), NeedsReviewActions (List<AnswerRebaseActionDisplay>)
- Completion screen: RebasedFilePath

**Commands:**
1. `AnalyzeRebase` — validate selections (baseline != target, bundle exists), create AnswerRebaseService, call RebaseAnswersAsync. Map report to display models (same ToDisplay pattern as RebaseWizardViewModel). Populate counts and lists. Navigate to Analysis screen.
2. `ApplyRebase` — guard on HasBlockingConflicts. Call ApplyAnswerRebase, write result to `{BundleRoot}/Manual/answers_rebased.json`. Set RebasedFilePath. Navigate to Completion screen.
3. `ExportMarkdownReport` / `ExportJsonReport` — same SaveFileDialog pattern as RebaseWizardViewModel.
4. `Cancel` / `Close` — CloseRequested event.

**Display model:** `AnswerRebaseActionDisplay` — ControlId, Action, Confidence, ConfidenceDisplay, Reason, RecommendedAction, IsBlockingConflict, ExistingStatus (from OriginalAnswer.Status).

Create AnswerRebaseWizard.xaml mirroring RebaseWizard.xaml structure:
- Welcome panel: pack selection dropdowns (baseline, target), bundle path display, "Analyze" button
- Analysis panel: summary stats (auto-carried, review, blocking), two lists (auto-carried actions, needs-review actions), export buttons, "Apply Rebase" button (disabled when blocking conflicts)
- Completion panel: success message, rebased file path, "Close" button

Create AnswerRebaseWizard.xaml.cs code-behind with DataContext assignment (same pattern as RebaseWizard.xaml.cs — ViewModel passed through constructor, CloseRequested wired to window close).

Per CONTEXT.md: "Rebase reports (overlay and answer) should be side-by-side in the WPF rebase wizard for operators doing both at once" — add a note/link text in the completion panel: "Use Overlay Rebase Wizard for overlay-level rebase alongside this answer rebase."</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles. Grep for AnswerRebaseWizard in the App project.</verify>
  <done>AnswerRebaseWizard follows 3-step flow (Welcome -> Analysis -> Apply). Analysis shows confidence-scored actions with auto-carry/review/blocking categorization. Apply writes answers_rebased.json. Export buttons produce Markdown and JSON reports.</done>
</task>

</tasks>

<verification>
- `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles
- ManualCheckWizard XAML includes Export/Import buttons bound to commands
- AnswerRebaseWizard XAML has 3-screen layout matching RebaseWizard pattern
- DiffViewer shows answer impact columns
</verification>

<success_criteria>
- ManualCheckWizard has Export/Import toolbar buttons with file dialogs
- AnswerRebaseWizard mirrors RebaseWizard 3-step flow with confidence display
- DiffViewer integrates answer impact columns for modified controls
- All three XAML views compile and bind correctly to ViewModels
- Export/Import operations use ManualAnswerService export/import methods from Plan 01
- AnswerRebaseWizard uses AnswerRebaseService from Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/04-human-resolution-and-evidence-continuity/04-04-SUMMARY.md`
</output>
