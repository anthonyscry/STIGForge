---
phase: 02-apply-logic
plan: 05
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - src/STIGForge.App/MainViewModel.Profile.cs
  - src/STIGForge.App/Views/ProfileEditorView.xaml
  - src/STIGForge.App/Views/ProfileEditorView.xaml.cs
  - src/STIGForge.App/MainViewModel.GuidedRun.cs
  - src/STIGForge.App/Views/GuidedRunView.xaml
  - src/STIGForge.App/Views/BreakGlassDialog.xaml
  - src/STIGForge.App/Views/BreakGlassDialog.xaml.cs
autonomous: true
requirements:
  - POL-01
  - SCOPE-02
  - SAFE-01
must_haves:
  truths:
    - "Operator can edit all profile policy knobs in a dedicated settings-area editor"
    - "Guided run shows review queue step with flagged controls and review reasons"
    - "WPF break-glass dialog captures reason and logs to audit trail"
    - "Profile changes are persisted immediately, not during a live mission run"
  artifacts:
    - path: "src/STIGForge.App/Views/ProfileEditorView.xaml"
      provides: "WPF profile editor form in settings area"
      contains: "ClassificationMode, NaPolicy, AutomationPolicy"
    - path: "src/STIGForge.App/Views/BreakGlassDialog.xaml"
      provides: "Break-glass confirmation dialog with reason capture"
      contains: "BreakGlassReason, MinLength"
    - path: "src/STIGForge.App/MainViewModel.GuidedRun.cs"
      provides: "Review queue step integration in guided run"
      contains: "ReviewQueueItems, ShowReviewQueue"
  key_links:
    - from: "src/STIGForge.App/Views/BreakGlassDialog.xaml.cs"
      to: "IAuditTrailService"
      via: "RecordAsync call on confirmation"
      pattern: "RecordAsync.*break-glass"
    - from: "src/STIGForge.App/MainViewModel.Profile.cs"
      to: "IProfileRepository"
      via: "SaveAsync on profile edit"
      pattern: "SaveAsync"
---

<objective>
Add WPF surfaces for profile editing, review queue visibility, and break-glass safety overrides.

Purpose: Operators using the WPF application need to configure policy knobs (POL-01) in a dedicated settings editor, see which controls were flagged for review during guided run (SCOPE-02), and have a break-glass dialog for safety gate overrides that logs to the audit trail (SAFE-01).
Output: Profile editor view, guided run review queue step, break-glass dialog with audit integration.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-apply-logic/02-RESEARCH.md
@.planning/phases/02-apply-logic/02-CONTEXT.md
@.planning/phases/02-apply-logic/02-01-SUMMARY.md
@.planning/phases/02-apply-logic/02-02-SUMMARY.md
@src/STIGForge.App/Views/ProfileView.xaml.cs
@src/STIGForge.App/Views/GuidedRunView.xaml
@src/STIGForge.App/MainViewModel.ApplyVerify.cs
@src/STIGForge.App/App.xaml.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile editor view and view model</name>
  <files>src/STIGForge.App/MainViewModel.Profile.cs, src/STIGForge.App/Views/ProfileEditorView.xaml, src/STIGForge.App/Views/ProfileEditorView.xaml.cs</files>
  <action>Create a partial MainViewModel.Profile.cs file (following the MainViewModel.ApplyVerify.cs pattern) with profile editing logic:

**ViewModel properties:**
- SelectedProfile (Profile), ProfileList (ObservableCollection of Profile), IsProfileDirty (bool)
- Editable fields bound two-way: ProfileName, ClassificationMode (combo), HardeningMode (combo), OsTarget (combo), RoleTemplate (combo)
- NaPolicy group: AutoNaOutOfScope (checkbox), ConfidenceThreshold (combo: High/Medium/Low), DefaultNaCommentTemplate (text)
- AutomationPolicy group: AutomationMode (combo), NewRuleGraceDays (int spinner/text), AutoApplyRequiresMapping (checkbox), ReleaseDateSource (combo)
- OverlayIds (editable list with add/remove)

**Commands:**
- LoadProfilesCommand — calls IProfileRepository.ListAsync(), populates ProfileList
- SaveProfileCommand — validates with ProfileValidator, saves via IProfileRepository.SaveAsync(), clears dirty flag
- NewProfileCommand — creates new Profile with defaults, adds to list
- DeleteProfileCommand — confirms, calls IProfileRepository.DeleteAsync()
- ExportProfileCommand — serializes to JSON, shows SaveFileDialog

**XAML layout (ProfileEditorView.xaml):**
- Replace existing stub ProfileView content with a form layout
- Left panel: profile list with select/add/delete buttons
- Right panel: grouped form fields — General (name, OS, role, mode), Scope Policy (classification, auto-NA, confidence), Automation Policy (grace days, mode, mapping required), Overlays (list with add/remove)
- Save button at bottom, disabled when not dirty or validation fails
- Use existing app theme (reference Themes/DarkTheme.xaml and LightTheme.xaml for style consistency)

Profile edits persist immediately on Save — not during live mission runs (per user decision). Wire through existing navigation or settings area.</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj`</verify>
  <done>Profile editor compiles with full policy knob editing, validation feedback, and persistence through IProfileRepository.</done>
</task>

<task type="auto">
  <name>Task 2: Add review queue step to guided run and break-glass dialog</name>
  <files>src/STIGForge.App/MainViewModel.GuidedRun.cs, src/STIGForge.App/Views/GuidedRunView.xaml, src/STIGForge.App/Views/BreakGlassDialog.xaml, src/STIGForge.App/Views/BreakGlassDialog.xaml.cs</files>
  <action>**Review queue step in guided run:**
- In MainViewModel.GuidedRun.cs (create as new partial if doesn't exist, or extend existing), add a ReviewQueueItems property (ObservableCollection) populated from CompiledControls.ReviewQueue after scope compilation.
- Each item shows: VulnId, RuleId, Title, ReviewReason (why it was flagged — confidence score, scope tag, or gate reason per user requirement).
- Add a guided run step between "Build" and "Apply" that displays the review queue when it's non-empty.
- If review queue is empty, skip the step automatically.
- In GuidedRunView.xaml, add a DataGrid or ItemsControl bound to ReviewQueueItems, showing the columns above. Include a header "Controls Requiring Review" and a count summary.

**Break-glass dialog (new window):**
- BreakGlassDialog.xaml: modal dialog with Title "Safety Override Required", description of what is being bypassed (passed as property), a TextBox for reason (minimum 8 characters), and OK/Cancel buttons.
- OK button disabled until reason meets minimum length.
- BreakGlassDialog.xaml.cs: code-behind with Reason property, BypassDescription property, and DialogResult handling.
- On OK: the calling code (in MainViewModel) records to IAuditTrailService with AuditEntry: Action="break-glass", Target=bundleRoot, Result="acknowledged", Detail="Action=wpf-{bypass-name}; Bypass={description}; Reason={dialog.Reason}", User=Environment.UserName, Machine=Environment.MachineName, Timestamp=DateTimeOffset.UtcNow.
- Wire break-glass dialog into the existing WPF force-auto-apply and skip-snapshot paths (find where these options are used in MainViewModel and add dialog invocation before proceeding).</action>
  <verify>`dotnet build src/STIGForge.App/STIGForge.App.csproj`</verify>
  <done>Guided run displays review queue between build and apply steps with per-control reasons. Break-glass dialog captures operator reason and logs to audit trail with hash-chained entry.</done>
</task>

</tasks>

<verification>
Run `dotnet build src/STIGForge.App/STIGForge.App.csproj` and confirm all WPF views compile. Verify no XAML parse errors. Check that MainViewModel partial files don't conflict with existing partials.
</verification>

<success_criteria>
WPF operators can edit all profile policy knobs in a dedicated settings editor, see flagged controls with reasons during guided run, and use break-glass overrides with audit-logged justification. All WPF surfaces honor the "edit at rest, not during execution" principle.
</success_criteria>

<output>
After completion, create `.planning/phases/02-apply-logic/02-05-SUMMARY.md`
</output>
