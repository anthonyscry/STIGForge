---
phase: 02-apply-logic
plan: 04
type: execute
wave: 2
depends_on: [02-02, 02-03]
files_modified:
  - src/STIGForge.Cli/Commands/OverlayCommands.cs
  - src/STIGForge.Cli/Commands/BundleCommands.cs
  - src/STIGForge.Cli/Program.cs
  - tests/STIGForge.UnitTests/Cli/OverlayCommandsTests.cs
autonomous: true
requirements:
  - POL-02
  - SCOPE-02
  - SAFE-01
must_haves:
  truths:
    - "Operator can diff two overlays and see field-level conflicts before building"
    - "Operator can inspect the review queue for a built bundle with reasons for each flagged control"
    - "Safety gate audit entries are queryable through existing audit CLI commands"
  artifacts:
    - path: "src/STIGForge.Cli/Commands/OverlayCommands.cs"
      provides: "overlay diff command showing field-level conflicts"
      contains: "RegisterOverlayDiff"
    - path: "src/STIGForge.Cli/Commands/BundleCommands.cs"
      provides: "bundle review-queue command showing flagged controls with reasons"
      contains: "RegisterBundleReviewQueue"
  key_links:
    - from: "src/STIGForge.Cli/Commands/OverlayCommands.cs"
      to: "OverlayConflictDetector"
      via: "DetectConflicts() for diff output"
      pattern: "DetectConflicts"
    - from: "src/STIGForge.Cli/Commands/BundleCommands.cs"
      to: "review_required.csv"
      via: "Reads existing review queue CSV from bundle"
      pattern: "review_required.csv"
---

<objective>
Add CLI commands for overlay diff and bundle review-queue inspection, completing the operator-facing CLI surface for policy and scope decisions.

Purpose: Operators need to preview overlay conflicts before building (`overlay diff`) and inspect which controls were flagged for review after building (`bundle review-queue`). These commands surface the deterministic gate decisions made by OverlayConflictDetector and ClassificationScopeService.
Output: OverlayCommands.cs with overlay diff, BundleCommands.cs extended with review-queue, unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-apply-logic/02-RESEARCH.md
@.planning/phases/02-apply-logic/02-CONTEXT.md
@.planning/phases/02-apply-logic/02-03-SUMMARY.md
@src/STIGForge.Core/Services/OverlayConflictDetector.cs
@src/STIGForge.Core/Models/Overlay.cs
@src/STIGForge.Cli/Commands/BundleCommands.cs
@src/STIGForge.Cli/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create overlay diff CLI command</name>
  <files>src/STIGForge.Cli/Commands/OverlayCommands.cs, src/STIGForge.Cli/Program.cs, tests/STIGForge.UnitTests/Cli/OverlayCommandsTests.cs</files>
  <action>Create `OverlayCommands` static class following the BuildCommands pattern. Register a parent `overlay` command with:

**`overlay diff <overlay-a> <overlay-b>` subcommand:**
- Takes two overlay IDs as required arguments.
- Resolves both from IOverlayRepository. If either not found, error with "Overlay not found: {id}".
- Creates a temporary list with both overlays (overlay-a at index 0, overlay-b at index 1 — so overlay-b has higher precedence).
- Calls `OverlayConflictDetector.DetectConflicts()`.
- Outputs results as a formatted table: ControlKey | Winner | Overridden | Winning Value | Overridden Value | Blocking.
- If no conflicts: output "No conflicts found between overlays {a} and {b}."
- If blocking conflicts exist: output count with warning "⚠ {N} blocking conflict(s) would halt build."

**`overlay list` subcommand:**
- Resolve IOverlayRepository, call ListAsync.
- Output table: OverlayId | Name | Overrides Count | Updated.

Wire `OverlayCommands.Register()` into Program.cs. Add unit test verifying diff command output format with mock overlays.</action>
  <verify>`dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj && dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter OverlayCommand`</verify>
  <done>Operators can run `overlay diff <a> <b>` to preview conflicts and `overlay list` to see available overlays. Blocking conflict warnings are clearly surfaced.</done>
</task>

<task type="auto">
  <name>Task 2: Add bundle review-queue CLI command</name>
  <files>src/STIGForge.Cli/Commands/BundleCommands.cs</files>
  <action>Extend existing `BundleCommands` (or create if it only has placeholder commands) to add a `bundle review-queue <bundle-path>` subcommand:

1. Accept `--bundle <path>` as a required option pointing to the bundle root directory.
2. Read `Reports/review_required.csv` from the bundle. If file doesn't exist, output "No review queue found. Build the bundle first."
3. Parse CSV (skip header row) and output as formatted table: VulnId | RuleId | Title | Reason.
4. Show summary at bottom: "{N} control(s) flagged for review."
5. If the review queue is empty (CSV has header only), output "Review queue is empty — all controls passed scope filtering."
6. Also check for `Reports/overlay_conflict_report.csv` and if it exists and has data rows, output an additional section: "Overlay conflicts: {N} conflict(s) detected. Run `overlay diff` for details."

Follow existing CLI command patterns for argument parsing and host resolution. No DI services needed — this reads static CSV files from disk.</action>
  <verify>`dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj`</verify>
  <done>Operators can inspect the review queue for any built bundle, seeing exactly which controls were flagged and why, with counts and actionable guidance.</done>
</task>

</tasks>

<verification>
Run `dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj` and verify CLI `--help` shows overlay and bundle subcommands. Run `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "OverlayCommand|BundleCommand"` and confirm tests pass.
</verification>

<success_criteria>
Operators have CLI access to overlay diff (pre-build conflict preview), overlay list, and bundle review-queue (post-build scope review). All commands output deterministic, formatted information that supports informed policy decisions.
</success_criteria>

<output>
After completion, create `.planning/phases/02-apply-logic/02-04-SUMMARY.md`
</output>
