---
phase: 02-apply-logic
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Core/Services/ClassificationScopeService.cs
  - tests/STIGForge.UnitTests/Services/ClassificationScopeServiceTests.cs
autonomous: true
requirements:
  - SCOPE-01
  - SCOPE-02
must_haves:
  truths:
    - "Unclassified mode marks ClassifiedOnly controls as NotApplicable when confidence meets threshold"
    - "Mixed mode includes all controls with no auto-NA filtering"
    - "Ambiguous scope decisions route to review queue in all three modes"
    - "Identical Profile + identical Controls always produce identical CompiledControls output"
  artifacts:
    - path: "src/STIGForge.Core/Services/ClassificationScopeService.cs"
      provides: "Complete scope evaluation for Classified, Unclassified, and Mixed modes"
      contains: "ClassificationMode.Unclassified, ClassificationMode.Mixed"
    - path: "tests/STIGForge.UnitTests/Services/ClassificationScopeServiceTests.cs"
      provides: "Determinism and mode coverage tests"
      contains: "Unclassified_ClassifiedOnlyControl_MarkedNA, Mixed_NoAutoNa"
  key_links:
    - from: "src/STIGForge.Core/Services/ClassificationScopeService.cs"
      to: "CompiledControls"
      via: "Compile() return value"
      pattern: "new CompiledControls"
    - from: "src/STIGForge.Build/BundleBuilder.cs"
      to: "ClassificationScopeService"
      via: "_scope.Compile()"
      pattern: "_scope.Compile"
---

<objective>
Extend ClassificationScopeService.Evaluate() to handle Unclassified and Mixed modes symmetrically with Classified mode.

Purpose: SCOPE-01 requires all three classification modes work with confidence-threshold auto-NA. Currently only Classified mode has detailed evaluation logic. Unclassified mode needs symmetric handling (ClassifiedOnly controls become NA), and Mixed mode should pass all controls through with no auto-NA.
Output: Complete scope evaluation in ClassificationScopeService, comprehensive unit tests proving determinism across all modes.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-apply-logic/02-RESEARCH.md
@.planning/phases/02-apply-logic/02-CONTEXT.md
@src/STIGForge.Core/Services/ClassificationScopeService.cs
@src/STIGForge.Core/Abstractions/Services.cs
@src/STIGForge.Core/Models/Profile.cs
@src/STIGForge.Core/Models/Enums.cs
@src/STIGForge.Core/Models/ControlRecord.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ClassificationScopeService with Unclassified and Mixed mode evaluation</name>
  <files>src/STIGForge.Core/Services/ClassificationScopeService.cs</files>
  <action>Extend the private `Evaluate()` method to handle all three ClassificationMode values:

**Unclassified mode (symmetric to Classified):**
- If `AutoNaOutOfScope` is false, return Open with no review.
- If control's ClassificationScope is `ClassifiedOnly`, check confidence against threshold. If meets threshold, mark NotApplicable with default NA comment. If below threshold, route to review queue with reason "Low confidence scope match: ClassifiedOnly".
- If control's ClassificationScope is `Unknown`, route to review queue with reason "Unknown classification scope".
- Controls with `UnclassifiedOnly` or `Both` scope pass through as Open.

**Mixed mode:**
- No auto-NA filtering. All controls pass through as Open regardless of scope tags.
- If `AutoNaOutOfScope` is true AND control has `ScopeTag.Unknown`, still route to review queue (ambiguous scope warrants review even in mixed mode).

Ensure the existing `FilterControls()` static method remains unchanged (it handles pre-build filtering separate from Compile).

Sort compiled controls by ControlId using StringComparer.OrdinalIgnoreCase before returning to guarantee deterministic output ordering.</action>
  <verify>`dotnet build src/STIGForge.Core/STIGForge.Core.csproj`</verify>
  <done>Evaluate() handles Classified, Unclassified, and Mixed modes with symmetric logic. Deterministic ordering is guaranteed.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive scope service tests for all modes and determinism</name>
  <files>tests/STIGForge.UnitTests/Services/ClassificationScopeServiceTests.cs</files>
  <action>Create test class `ClassificationScopeServiceTests` following the pattern in OverlayRebaseServiceTests. Add tests:

**Classified mode (existing behavior validation):**
- Classified_UnclassifiedOnlyControl_HighConfidence_MarkedNA
- Classified_UnclassifiedOnlyControl_LowConfidence_RoutedToReview
- Classified_UnknownScope_RoutedToReview
- Classified_BothScope_PassesThrough

**Unclassified mode:**
- Unclassified_ClassifiedOnlyControl_HighConfidence_MarkedNA
- Unclassified_ClassifiedOnlyControl_LowConfidence_RoutedToReview
- Unclassified_UnknownScope_RoutedToReview
- Unclassified_UnclassifiedOnlyControl_PassesThrough

**Mixed mode:**
- Mixed_AllControlsPassThrough_NoAutoNa
- Mixed_UnknownScope_RoutedToReviewWhenAutoNaEnabled

**Determinism:**
- IdenticalInputs_ProduceIdenticalOutputs — run Compile twice with same inputs, assert byte-equal results
- DifferentControlOrder_ProducesSameOutput — shuffle control input order, verify identical compiled output

**Edge cases:**
- AutoNaDisabled_NoScopeFiltering — when AutoNaOutOfScope=false, no controls marked NA regardless of mode
- EmptyControlList_ReturnsEmptyResult

Use FluentAssertions. Create helper method `MakeControl(string id, ScopeTag scope, Confidence confidence)` and `MakeProfile(ClassificationMode mode, Confidence threshold, bool autoNa)` for test setup.</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter ClassificationScopeService`</verify>
  <done>All classification mode tests pass, determinism is proven, and review queue routing is validated for all three modes.</done>
</task>

</tasks>

<verification>
Run `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter ClassificationScopeService` and confirm all tests pass. Verify that running the test suite twice produces identical results (determinism).
</verification>

<success_criteria>
ClassificationScopeService handles all three classification modes (Classified, Unclassified, Mixed) with symmetric evaluation logic. Ambiguous scope decisions route to review queue in all modes. Identical inputs always produce identical outputs. Existing BundleBuilder integration continues to work unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/02-apply-logic/02-02-SUMMARY.md`
</output>
