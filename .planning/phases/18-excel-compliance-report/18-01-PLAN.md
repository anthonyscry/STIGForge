---
phase: 18
plan: 1
title: "Implement ExcelExportAdapter and ReportGenerator using ClosedXML"
requirements: [EXP-03]
depends_on: []
artifacts:
  - src/STIGForge.Reporting/ReportGenerator.cs
  - src/STIGForge.Export/ExcelExportAdapter.cs
  - src/STIGForge.Cli/Commands/ExportCommands.cs
  - tests/STIGForge.UnitTests/Export/ExcelExportAdapterTests.cs
key_links:
  - src/STIGForge.Export/CsvExportAdapter.cs
  - src/STIGForge.Export/ExportModels.cs
  - src/STIGForge.Verify/VerifyModels.cs
  - src/STIGForge.Reporting/STIGForge.Reporting.csproj
  - src/STIGForge.Cli/Commands/ExportCommands.cs
must_be_true:
  - "Operator exports via CLI `export-excel` command; output is an .xlsx file with four tabs: Summary, All Controls, Open Findings, Coverage"
  - "Exported workbook opens correctly in Excel and contains the same control data as the CSV export (same 13 columns on All Controls tab)"
  - "STIGForge.Reporting.ReportGenerator is fully implemented (not a stub); ClosedXML 0.105.0 (MIT) is the only new dependency added"
  - "Export fails closed: partial .tmp file is deleted if the adapter throws"
  - "All existing export tests (93+) continue to pass with zero regressions"
---

# Plan 18-01: Implement ExcelExportAdapter and ReportGenerator using ClosedXML

## Task 1: Add ClosedXML, implement ReportGenerator, create ExcelExportAdapter, and write tests

**Wave:** 1
**Estimated:** 5 min

### Steps

1. **Add ClosedXML 0.105.0 to STIGForge.Reporting.csproj**
   - Add `<PackageReference Include="ClosedXML" Version="0.105.0" />` to the project file
   - Add `<ProjectReference>` to `STIGForge.Verify` for `ControlResult` access

2. **Add STIGForge.Reporting project reference to STIGForge.Export.csproj**
   - `<ProjectReference Include="..\STIGForge.Reporting\STIGForge.Reporting.csproj" />`

3. **Implement ReportGenerator in STIGForge.Reporting**
   - Replace the stub with: `public async Task<XLWorkbook> GenerateAsync(IReadOnlyList<ControlResult> results, IReadOnlyDictionary<string, string> options, CancellationToken ct)`
   - Build four worksheets:

   **Summary tab:**
   - Row 1: "STIGForge Compliance Report" (bold, merged across 2 cols)
   - Row 2: "System: {systemName}" and "Generated: {timestamp}"
   - Row 4-10: Metrics block — Total Controls, Pass, Fail, Not Applicable, Not Reviewed, Pass Rate (%)
   - Row 12-14: Severity breakdown — CAT I count, CAT II count, CAT III count
   - Row 16-18: Open findings by severity — CAT I open, CAT II open, CAT III open

   **All Controls tab:**
   - Same 13 columns as CsvExportAdapter: System Name, Vulnerability ID, Rule ID, STIG Title, Severity, CAT Level, Status, Finding Details, Comments, Remediation Priority, Tool, Source File, Verified At
   - All ControlResult entries sorted by severity (high first) then VulnId
   - Bold header row, auto-filter enabled
   - Column width auto-fit

   **Open Findings tab:**
   - Same columns as All Controls
   - Filtered to Status containing "Fail" or "Open" (case-insensitive)
   - Sorted by severity (high first) then VulnId
   - Bold header row, auto-filter enabled

   **Coverage tab:**
   - Columns: Severity, Total, Pass, Fail, Not Applicable, Not Reviewed, Pass Rate (%)
   - One row per severity level: CAT I, CAT II, CAT III, Unknown
   - Totals row at bottom (bold)
   - Bold header row

   **Helpers (reuse from CsvExportAdapter):**
   - `MapSeverityToCatLevel` — same logic as CsvExportAdapter (high→CAT I, medium→CAT II, low→CAT III, else→Unknown)
   - `GetSystemName` — from options["system-name"] or Path.GetFileName(bundleRoot)
   - `SeverityOrder` — for sorting: high=0, medium=1, low=2, other=3

4. **Create ExcelExportAdapter in STIGForge.Export**
   - `FormatName = "Excel"`, `SupportedExtensions = [".xlsx"]`
   - `ExportAsync`: create ReportGenerator, call GenerateAsync, save workbook using fail-closed temp-file pattern
   - Default file name stem: `stigforge_compliance_report`

5. **Create ExcelExportAdapterTests (12+ tests)**
   - `FormatName_Is_Excel`
   - `SupportedExtensions_Contains_Xlsx`
   - `ExportAsync_ProducesFileWithFourSheets` — verify sheet names: Summary, All Controls, Open Findings, Coverage
   - `ExportAsync_AllControlsTab_HasCorrectRowCount` — header + N data rows
   - `ExportAsync_AllControlsTab_HasCorrectHeaders` — all 13 column headers
   - `ExportAsync_AllControlsTab_SortsBySeverityThenVulnId` — verify ordering
   - `ExportAsync_OpenFindingsTab_ContainsOnlyFailOpen` — no Pass/NotApplicable rows
   - `ExportAsync_SummaryTab_HasCorrectMetrics` — total, pass, fail counts and pass rate
   - `ExportAsync_CoverageTab_HasSeverityBreakdown` — CAT I/II/III rows with correct counts
   - `ExportAsync_CoverageTab_HasTotalsRow` — bottom row sums match totals
   - `ExportAsync_EmptyResults_ProducesValidWorkbook` — all 4 tabs exist with zero metrics
   - `ExportAsync_PartialFileDeletedOnError` — fail-closed behavior

6. **Add ClosedXML to test project**
   - Add `<PackageReference Include="ClosedXML" Version="0.105.0" />` to `STIGForge.UnitTests.csproj` for read-back verification

7. **Build and run tests**
   - `dotnet build` whole solution
   - `dotnet test --filter "FullyQualifiedName~ExcelExportAdapter"` — all new tests pass
   - `dotnet test --filter "FullyQualifiedName~Export"` — all export tests pass (no regressions)

### Commit
`feat(18-01): add ExcelExportAdapter and ReportGenerator with ClosedXML`

## Task 2: Wire export-excel CLI command

**Wave:** 1 (can be done in same commit if small)
**Estimated:** 2 min

### Steps

1. **Add RegisterExportExcel to ExportCommands.cs**
   - Add `RegisterExportExcel(rootCmd, buildHost)` call in `Register()` method
   - Create `RegisterExportExcel` method following exact same pattern as `RegisterExportCsv`:
     - `--bundle` (required), `--output` (optional), `--file-name` (optional), `--system-name` (optional)
     - Load results from `Verify/consolidated-results.json`
     - Build options dict with system-name
     - Create `ExcelExportAdapter`, call `ExportAsync`
     - Print summary: file path and result count

2. **Build and verify**
   - `dotnet build` the CLI project
   - Run full export test suite to confirm zero regressions

### Commit
`feat(18-01): wire export-excel CLI command`

## Verification

After both tasks:
1. All new Excel export tests pass GREEN
2. All existing export tests (93+) pass with zero regressions
3. Solution builds clean on both target frameworks
4. export-excel CLI command is registered and discoverable
5. Generated .xlsx files are readable by ClosedXML (round-trip verified in tests)
