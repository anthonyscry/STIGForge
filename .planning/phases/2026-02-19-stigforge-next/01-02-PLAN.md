---
phase: 01-foundations-and-canonical-contracts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Content/Import/ContentPackImporter.cs
  - src/STIGForge.Content/Import/ImportDedupService.cs
  - src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs
  - tests/STIGForge.UnitTests/Content/ContentPackImporterDirectoryHashTests.cs
  - tests/STIGForge.UnitTests/Content/ImportDedupServiceTests.cs
autonomous: true
requirements:
  - ING-01
  - ING-02
gap_closure: true
must_haves:
  truths:
    - "Importing the same directory-based pack twice produces the same 64-char lowercase SHA-256 manifest hash."
    - "Repeated import of unchanged content is deduplicated instead of creating a duplicate persisted pack."
  artifacts:
    - path: src/STIGForge.Content/Import/ContentPackImporter.cs
      provides: Deterministic directory manifest hashing and pre-save dedupe check.
      contains: ComputeDirectoryManifestSha256Async
    - path: src/STIGForge.Content/Import/ImportDedupService.cs
      provides: Persisted-pack dedupe identity comparison.
      contains: Resolve
    - path: src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs
      provides: Content-pack upsert behavior keyed for deterministic dedupe.
      contains: SaveAsync
  key_links:
    - from: src/STIGForge.Content/Import/ContentPackImporter.cs
      to: src/STIGForge.Content/Import/ImportDedupService.cs
      via: Deterministic content identity evaluation before persistence
      pattern: ManifestSha256
    - from: src/STIGForge.Content/Import/ContentPackImporter.cs
      to: src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs
      via: SaveAsync for deduped pack persistence
      pattern: _packs\.SaveAsync
---

<objective>
Close UAT Gap #1 by restoring deterministic directory manifest hashing and persisted import dedupe so unchanged re-imports remain stable and non-duplicative.

Purpose: Preserve deterministic ingestion identity and stop duplicate content pack records.
Output: Import pipeline writes stable directory hashes and dedupes unchanged packs before persistence.
</objective>

<execution_context>
@/home/anthonyscry/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/2026-02-19-stigforge-next/01-UAT.md
@.planning/phases/2026-02-19-stigforge-next/01-01-SUMMARY.md
@.planning/debug/debug-dir-import-hash-dedupe.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restore deterministic directory hash and persisted dedupe gate</name>
  <files>src/STIGForge.Content/Import/ContentPackImporter.cs, src/STIGForge.Content/Import/ImportDedupService.cs, src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs</files>
  <action>Replace directory import ManifestSha256 assignment from packId with deterministic SHA-256 computed from normalized relative paths plus file hashes, then add a pre-save persisted dedupe check keyed by deterministic content identity so unchanged imports resolve to the existing pack record instead of inserting a new one. Ensure repository conflict/upsert behavior supports this dedupe path and does not create duplicate rows for unchanged content.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~ContentPackImporterDirectoryHashTests|FullyQualifiedName~ImportDedupServiceTests"</verify>
  <done>Re-importing unchanged directory content yields the same manifest hash and does not create a second persisted content pack.</done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests for deterministic re-import behavior</name>
  <files>tests/STIGForge.UnitTests/Content/ContentPackImporterDirectoryHashTests.cs, tests/STIGForge.UnitTests/Content/ImportDedupServiceTests.cs</files>
  <action>Add tests that import the same directory payload twice and assert: (1) manifest hash format is lowercase 64-char SHA-256, (2) hash value remains identical across both imports, and (3) persisted pack count remains one for unchanged inputs. Include a negative case where content changes and dedupe is bypassed.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~ContentPackImporterDirectoryHashTests|FullyQualifiedName~ImportDedupServiceTests"</verify>
  <done>Focused tests fail on pre-fix behavior and pass only when deterministic hash stability plus persisted dedupe are both implemented.</done>
</task>

</tasks>

<verification>
Run: `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~ContentPackImporterDirectoryHashTests|FullyQualifiedName~ImportDedupServiceTests"`
</verification>

<success_criteria>
UAT test 1 can be re-run and shows stable deterministic hash plus deduplicated unchanged imports.
</success_criteria>

<output>
After completion, create `.planning/phases/2026-02-19-stigforge-next/01-02-SUMMARY.md`
</output>
