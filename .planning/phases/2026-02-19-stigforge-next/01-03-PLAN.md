---
phase: 01-foundations-and-canonical-contracts
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.App/OverlayEditorWindow.xaml
  - src/STIGForge.App/OverlayEditorViewModel.cs
  - src/STIGForge.Core/Models/Overlay.cs
  - tests/STIGForge.UnitTests/Views/OverlayEditorViewModelTests.cs
autonomous: true
requirements:
  - POL-02
gap_closure: true
must_haves:
  truths:
    - "Operator can select rule IDs from controls in selected content packs instead of typing IDs manually."
    - "Overlay edits saved in the app persist into Overlay.Overrides as ControlOverride decisions used by merge/build flows."
  artifacts:
    - path: src/STIGForge.App/OverlayEditorWindow.xaml
      provides: Rule selection UX bound to pack-derived control list.
      contains: SelectedRuleId
    - path: src/STIGForge.App/OverlayEditorViewModel.cs
      provides: Load and save flow for ControlOverride decisions.
      contains: SaveOverlayAsync
    - path: src/STIGForge.Core/Models/Overlay.cs
      provides: Canonical overlay decision model.
      contains: Overrides
  key_links:
    - from: src/STIGForge.App/OverlayEditorWindow.xaml
      to: src/STIGForge.App/OverlayEditorViewModel.cs
      via: Data binding for selectable rule list and add command
      pattern: Add.*OverrideCommand
    - from: src/STIGForge.App/OverlayEditorViewModel.cs
      to: src/STIGForge.Core/Models/Overlay.cs
      via: SaveOverlayAsync writes Overlay.Overrides
      pattern: Overrides
---

<objective>
Close UAT Gap #3 UX/persistence blockers by replacing manual overlay entry with selected-content-pack rule selection and by saving app edits into `Overlay.Overrides`.

Purpose: Ensure overlay authoring in WPF app produces the same decision model consumed by bundle merge/orchestration.
Output: Overlay editor supports pack-derived rule selection and persists `ControlOverride` entries.
</objective>

<execution_context>
@/home/anthonyscry/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/2026-02-19-stigforge-next/01-UAT.md
@.planning/phases/2026-02-19-stigforge-next/01-01-SUMMARY.md
@.planning/debug/debug-overlay-ux-selection-missing.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement pack-derived rule selection in overlay editor UX</name>
  <files>src/STIGForge.App/OverlayEditorWindow.xaml, src/STIGForge.App/OverlayEditorViewModel.cs</files>
  <action>Replace manual free-text RuleId entry with a selectable list sourced from controls in the currently selected content packs for the bundle context. Add view-model state for available rules (RuleId/VulnId/title), selected rule, and deterministic sorting. Keep optional reason/notes fields for selected rule decisions.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~OverlayEditorViewModelTests"</verify>
  <done>Operator can choose a rule from pack-derived options and add an override without manual typing of IDs.</done>
</task>

<task type="auto">
  <name>Task 2: Align app save behavior to Overlay.Overrides decision model</name>
  <files>src/STIGForge.App/OverlayEditorViewModel.cs, src/STIGForge.Core/Models/Overlay.cs</files>
  <action>Update `SaveOverlayAsync` to persist selected decisions as `Overlay.Overrides` (`ControlOverride`) with RuleId/VulnId/status/reason notes, while preserving existing PowerStig override support as a separate concern. Ensure model parity with CLI overlay-edit behavior so both surfaces write merge-consumed decisions.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~OverlayEditorViewModelTests|FullyQualifiedName~BuildCommandsTests"</verify>
  <done>Saved overlays from WPF contain populated `Overrides` entries that are compatible with CLI/build merge consumption.</done>
</task>

<task type="auto">
  <name>Task 3: Add view-model regression tests for selection and persistence</name>
  <files>tests/STIGForge.UnitTests/Views/OverlayEditorViewModelTests.cs</files>
  <action>Create tests covering: available-rule population ordering, add/remove behavior for selected rule overrides, and save persistence writing `Overlay.Overrides` (not only `PowerStigOverrides`). Include a regression for duplicate selection to ensure deterministic update semantics.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~OverlayEditorViewModelTests"</verify>
  <done>New tests fail against old manual-text/save behavior and pass with selectable-rule + `Overlay.Overrides` persistence implementation.</done>
</task>

</tasks>

<verification>
Run: `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~OverlayEditorViewModelTests|FullyQualifiedName~BuildCommandsTests"`
</verification>

<success_criteria>
UAT test 3 precondition is satisfied: overlays can be authored by selecting rules from selected content packs, and app saves produce merge-consumed `Overlay.Overrides` decisions.
</success_criteria>

<output>
After completion, create `.planning/phases/2026-02-19-stigforge-next/01-03-SUMMARY.md`
</output>
