---
phase: 01-foundations-and-canonical-contracts
plan: 04
type: execute
wave: 2
depends_on:
  - 01-03
files_modified:
  - src/STIGForge.Build/BundleBuilder.cs
  - src/STIGForge.Build/BundleOrchestrator.cs
  - src/STIGForge.Build/OverlayMergeService.cs
  - tests/STIGForge.UnitTests/Build/BundleBuilderOverlayMergeTests.cs
  - tests/STIGForge.UnitTests/Build/BundleOrchestratorControlOverrideTests.cs
autonomous: true
requirements:
  - POL-02
  - SCOPE-02
  - BLD-01
  - APL-02
gap_closure: true
must_haves:
  truths:
    - "Bundle build emits `Reports/overlay_conflicts.csv` and `Reports/overlay_decisions.json` when overlays are provided."
    - "Rules overridden to NotApplicable do not appear in `Reports/review_required.csv`."
    - "Orchestration excludes NotApplicable rules from apply-time control set using merged overlay decisions."
  artifacts:
    - path: src/STIGForge.Build/OverlayMergeService.cs
      provides: Deterministic overlay precedence/conflict and decision output.
      contains: OverlayMergeService
    - path: src/STIGForge.Build/BundleBuilder.cs
      provides: Build-time merge application and report emission.
      contains: overlay_decisions.json
    - path: src/STIGForge.Build/BundleOrchestrator.cs
      provides: Apply-time control filtering from merged decision artifacts.
      contains: LoadBundleControls
  key_links:
    - from: src/STIGForge.Build/BundleBuilder.cs
      to: src/STIGForge.Build/OverlayMergeService.cs
      via: Merge invocation before review queue and report generation
      pattern: OverlayMergeService
    - from: src/STIGForge.Build/BundleBuilder.cs
      to: src/STIGForge.Build/BundleOrchestrator.cs
      via: overlay_decisions.json artifact consumed for apply control filtering
      pattern: overlay_decisions\.json
---

<objective>
Close UAT Gaps #2-#4 by wiring deterministic overlay merge into build reports, review queue generation, and orchestration control filtering.

Purpose: Make overlay decisions executable and traceable from authoring through build artifacts to apply-time behavior.
Output: Bundle reports include conflict/decision artifacts; review queue and orchestration honor merged NotApplicable overrides.
</objective>

<execution_context>
@/home/anthonyscry/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/2026-02-19-stigforge-next/01-UAT.md
@.planning/phases/2026-02-19-stigforge-next/01-03-SUMMARY.md
@.planning/debug/debug-overlay-artifacts-missing.md
@.planning/debug/debug-orchestrator-overlay-filter-blocked.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire deterministic overlay merge and report emission in bundle build</name>
  <files>src/STIGForge.Build/BundleBuilder.cs, src/STIGForge.Build/OverlayMergeService.cs</files>
  <action>Apply overlay merge before report generation, then emit deterministic `Reports/overlay_conflicts.csv` and `Reports/overlay_decisions.json` files. Ensure merge output (including `ControlOverride` status decisions) is the source of truth for downstream queue/filter behavior and not a disconnected side artifact.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~BundleBuilderOverlayMergeTests"</verify>
  <done>Building with overlays creates both report artifacts with deterministic ordering and complete conflict/decision rows.</done>
</task>

<task type="auto">
  <name>Task 2: Apply merged decisions to review queue and orchestration control set</name>
  <files>src/STIGForge.Build/BundleBuilder.cs, src/STIGForge.Build/BundleOrchestrator.cs</files>
  <action>Use merged overlay decisions when composing `review_required.csv`, excluding controls with effective `NotApplicable` overrides. In orchestration, load `overlay_decisions.json` and filter NotApplicable rules before PowerStig data generation and apply-time control materialization.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~BundleBuilderOverlayMergeTests|FullyQualifiedName~BundleOrchestratorControlOverrideTests"</verify>
  <done>Rules overridden to NotApplicable are absent from review queue and excluded from apply-time control set.</done>
</task>

<task type="auto">
  <name>Task 3: Add executable regressions for artifact + filtering flow</name>
  <files>tests/STIGForge.UnitTests/Build/BundleBuilderOverlayMergeTests.cs, tests/STIGForge.UnitTests/Build/BundleOrchestratorControlOverrideTests.cs</files>
  <action>Create/enable tests proving: (1) overlay report artifacts are emitted, (2) review queue excludes merged NotApplicable rules, and (3) orchestrator consumes `overlay_decisions.json` to filter apply controls. Keep fixtures deterministic and validate file names/contents expected by UAT.</action>
  <verify>dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~BundleBuilderOverlayMergeTests|FullyQualifiedName~BundleOrchestratorControlOverrideTests"</verify>
  <done>Focused regression suite catches missing artifacts and missing apply-time filtering; all new tests pass with implementation.</done>
</task>

</tasks>

<verification>
Run: `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter "FullyQualifiedName~BundleBuilderOverlayMergeTests|FullyQualifiedName~BundleOrchestratorControlOverrideTests"`
</verification>

<success_criteria>
UAT tests 2, 3, and 4 can be re-run and demonstrate emitted overlay artifacts, merged NotApplicable review suppression, and orchestration filtering.
</success_criteria>

<output>
After completion, create `.planning/phases/2026-02-19-stigforge-next/01-04-SUMMARY.md`
</output>
