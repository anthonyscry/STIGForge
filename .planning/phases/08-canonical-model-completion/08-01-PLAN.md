---
phase: 08-canonical-model-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Core/Models/ContentPack.cs
  - src/STIGForge.Infrastructure/Storage/DbBootstrap.cs
  - src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs
  - tests/STIGForge.UnitTests/Core/ContentPackModelTests.cs
  - tests/STIGForge.UnitTests/Content/ContentPackImporterTests.cs
autonomous: true
requirements:
  - ING-02
must_haves:
  truths:
    - "ContentPack has BenchmarkIds as IReadOnlyList<string> defaulting to Array.Empty<string>()"
    - "ContentPack has ApplicabilityTags as IReadOnlyList<string> defaulting to Array.Empty<string>()"
    - "ContentPack has Version and Release string fields defaulting to string.Empty"
    - "DbBootstrap includes ALTER TABLE content_packs ADD COLUMN for benchmark_ids_json, applicability_tags_json, version, release"
    - "SqliteContentPackRepository SaveAsync persists all new fields including JSON-serialized lists"
    - "SqliteContentPackRepository GetAsync and ListAsync read and deserialize all new fields"
  artifacts:
    - path: "src/STIGForge.Core/Models/ContentPack.cs"
      provides: "ContentPack with BenchmarkIds, ApplicabilityTags, Version, Release fields"
      contains: "BenchmarkIds, ApplicabilityTags, Version, Release"
    - path: "src/STIGForge.Infrastructure/Storage/DbBootstrap.cs"
      provides: "SQLite schema migration for content_packs new columns"
      contains: "benchmark_ids_json, applicability_tags_json, version, release"
    - path: "src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs"
      provides: "Repository CRUD with new ContentPack fields and JSON list serialization"
      contains: "benchmark_ids_json, applicability_tags_json, JsonSerializer"
    - path: "tests/STIGForge.UnitTests/Core/ContentPackModelTests.cs"
      provides: "Unit tests for ContentPack new field defaults and round-trip"
      contains: "BenchmarkIds_DefaultsToEmpty, ApplicabilityTags_DefaultsToEmpty, Version_DefaultsToEmpty"
  key_links:
    - from: "src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs"
      to: "ContentPack"
      via: "SaveAsync serializes BenchmarkIds/ApplicabilityTags to JSON, GetAsync deserializes"
      pattern: "JsonSerializer.Serialize"
    - from: "src/STIGForge.Infrastructure/Storage/DbBootstrap.cs"
      to: "content_packs"
      via: "ALTER TABLE migration adds new columns"
      pattern: "ALTER TABLE content_packs"
---

<objective>
Add BenchmarkIds, ApplicabilityTags, Version, and Release fields to ContentPack, update SQLite schema and repository persistence.

Purpose: ING-02 requires packs to expose benchmark IDs, release/version/date, source labels, applicability tags, and hash manifest. ContentPack currently lacks BenchmarkIds (list of SCAP benchmark IDs a pack maps to), ApplicabilityTags (flat string tags for filtering), and pack-level Version/Release fields. Per CONTEXT.md: BenchmarkIds is IReadOnlyList<string>, ApplicabilityTags is IReadOnlyList<string> (flat tags, not typed enums), both default to Array.Empty<string>(). Version and Release are simple strings.
Output: Enhanced ContentPack model, migrated SQLite schema, updated repository with JSON serialization for list fields, unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/08-canonical-model-completion/08-CONTEXT.md
@.planning/phases/08-canonical-model-completion/08-RESEARCH.md
@src/STIGForge.Core/Models/ContentPack.cs
@src/STIGForge.Infrastructure/Storage/DbBootstrap.cs
@src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs
@tests/STIGForge.UnitTests/Content/ContentPackImporterTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new fields to ContentPack model</name>
  <files>src/STIGForge.Core/Models/ContentPack.cs</files>
  <action>Add four new properties to ContentPack:

1. `public IReadOnlyList<string> BenchmarkIds { get; set; } = Array.Empty<string>();` — list of SCAP benchmark IDs this pack maps to (e.g., ["Windows_10_STIG", "Windows_Server_2022_STIG"])
2. `public IReadOnlyList<string> ApplicabilityTags { get; set; } = Array.Empty<string>();` — flat string tags for downstream filtering (e.g., ["Win10", "Server2022", "MemberServer"])
3. `public string Version { get; set; } = string.Empty;` — pack-level benchmark version
4. `public string Release { get; set; } = string.Empty;` — pack-level benchmark release

Place after ManifestSha256 and before SchemaVersion. Add XML doc comments consistent with existing field documentation style.</action>
  <verify>`dotnet build src/STIGForge.Core/STIGForge.Core.csproj` compiles. Existing tests still pass: `dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter ContentPack`.</verify>
  <done>ContentPack model has BenchmarkIds, ApplicabilityTags, Version, and Release fields with safe defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate SQLite schema and update repository</name>
  <files>src/STIGForge.Infrastructure/Storage/DbBootstrap.cs, src/STIGForge.Infrastructure/Storage/SqliteRepositories.cs</files>
  <action>In DbBootstrap.cs, after the existing CREATE TABLE content_packs statement, add migration statements:

```
ALTER TABLE content_packs ADD COLUMN benchmark_ids_json TEXT NOT NULL DEFAULT '[]';
ALTER TABLE content_packs ADD COLUMN applicability_tags_json TEXT NOT NULL DEFAULT '[]';
ALTER TABLE content_packs ADD COLUMN version TEXT NOT NULL DEFAULT '';
ALTER TABLE content_packs ADD COLUMN release TEXT NOT NULL DEFAULT '';
```

Wrap each ALTER TABLE in a try-catch (or use a "column exists" check) since ALTER TABLE ADD COLUMN will fail if the column already exists on subsequent runs. The simplest pattern is to catch SqliteException and ignore "duplicate column name" errors, consistent with how SQLite migrations are handled elsewhere.

In SqliteRepositories.cs SqliteContentPackRepository:

1. **SaveAsync**: Update the INSERT SQL to include the four new columns. For BenchmarkIds and ApplicabilityTags, serialize to JSON using `System.Text.Json.JsonSerializer.Serialize()`. Use anonymous object parameters: `benchmark_ids_json = JsonSerializer.Serialize(pack.BenchmarkIds)`, `applicability_tags_json = JsonSerializer.Serialize(pack.ApplicabilityTags)`, `version = pack.Version`, `release = pack.Release`. Update ON CONFLICT SET clause to include new columns.

2. **GetAsync**: Update the SELECT SQL to include new columns. Since Dapper doesn't natively deserialize JSON strings to IReadOnlyList<string>, do one of:
   - (Preferred) Read the raw row with benchmark_ids_json and applicability_tags_json as strings, then manually map: `pack.BenchmarkIds = JsonSerializer.Deserialize<List<string>>(raw.benchmark_ids_json) ?? new List<string>()` etc.
   - Or use a private DTO class for the row mapping and convert to ContentPack after.
   Apply the same approach to the Version and Release columns (direct string mapping).

3. **ListAsync**: Same SELECT update as GetAsync.

Add `using System.Text.Json;` at the top of SqliteRepositories.cs.</action>
  <verify>`dotnet build src/STIGForge.Infrastructure/STIGForge.Infrastructure.csproj` compiles. `dotnet test tests/STIGForge.IntegrationTests/STIGForge.IntegrationTests.csproj --filter ContentPack` — existing round-trip tests pass.</verify>
  <done>SQLite schema migrated with new columns. Repository CRUD persists and retrieves BenchmarkIds, ApplicabilityTags, Version, Release correctly.</done>
</task>

<task type="auto">
  <name>Task 3: Add ContentPack model and repository round-trip tests</name>
  <files>tests/STIGForge.UnitTests/Core/ContentPackModelTests.cs</files>
  <action>Create ContentPackModelTests.cs in tests/STIGForge.UnitTests/Core/ with xUnit tests:

1. `BenchmarkIds_DefaultsToEmpty` — new ContentPack().BenchmarkIds is empty and not null.
2. `ApplicabilityTags_DefaultsToEmpty` — new ContentPack().ApplicabilityTags is empty and not null.
3. `Version_DefaultsToEmpty` — new ContentPack().Version == string.Empty.
4. `Release_DefaultsToEmpty` — new ContentPack().Release == string.Empty.
5. `BenchmarkIds_CanBeAssigned` — set BenchmarkIds to a list, verify round-trip.
6. `ApplicabilityTags_CanBeAssigned` — set ApplicabilityTags to a list, verify round-trip.
7. `SchemaVersion_IsCanonicalVersion` — new ContentPack().SchemaVersion == CanonicalContract.Version.

Follow existing test patterns (xUnit, direct assertions or FluentAssertions where available).</action>
  <verify>`dotnet test tests/STIGForge.UnitTests/STIGForge.UnitTests.csproj --filter ContentPackModel` — all tests pass.</verify>
  <done>ContentPack model tests verify default values, assignment, and schema version for all new fields.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes for Core, Infrastructure, and UnitTests projects
- `dotnet test --filter "ContentPackModel|ContentPack"` — all tests pass (new and existing)
- New ContentPack instance has empty defaults for BenchmarkIds, ApplicabilityTags, Version, Release
- SQLite content_packs table has benchmark_ids_json, applicability_tags_json, version, release columns
- Repository round-trips list fields through JSON serialization
</verification>

<success_criteria>
ING-02 pack metadata gap is closed: ContentPack exposes BenchmarkIds list and ApplicabilityTags for downstream filtering, plus pack-level Version and Release. SQLite persistence supports the new fields.
</success_criteria>

<output>
After completion, create `.planning/phases/08-canonical-model-completion/08-01-SUMMARY.md`
</output>
