---
phase: 19-wpf-workflow-ux-polish-and-export-format-picker
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.App/Models/VerifyToolStatus.cs
  - src/STIGForge.App/MainViewModel.ApplyVerify.cs
  - src/STIGForge.App/Views/VerifyView.xaml
  - tests/STIGForge.UnitTests/Views/VerifyProgressContractTests.cs
autonomous: true
requirements: [UX-01, UX-02]

must_haves:
  truths:
    - "VerifyView shows one row per scanner tool with name, state, elapsed time, and finding count during verify execution"
    - "Scanner tool rows use theme-appropriate colors: Pending=TextMutedBrush, Running=AccentBrush, Complete=SuccessBrush, Failed=DangerBrush"
    - "When verify or export fails, a structured error panel appears with error message, numbered recovery steps, and retry button"
    - "Error recovery steps are specific to the exception type (IOException, TimeoutException, FileNotFoundException)"
  artifacts:
    - path: "src/STIGForge.App/Models/VerifyToolStatus.cs"
      provides: "Observable progress model for per-tool verify status"
      contains: "VerifyToolStatus"
    - path: "src/STIGForge.App/Views/VerifyView.xaml"
      provides: "Verify progress panel and error recovery panel"
      contains: "ItemsControl"
    - path: "tests/STIGForge.UnitTests/Views/VerifyProgressContractTests.cs"
      provides: "Layout contract tests for verify progress and error panels"
  key_links:
    - from: "src/STIGForge.App/Views/VerifyView.xaml"
      to: "src/STIGForge.App/Models/VerifyToolStatus.cs"
      via: "ItemsControl ItemsSource binding to VerifyToolStatuses collection"
    - from: "src/STIGForge.App/MainViewModel.ApplyVerify.cs"
      to: "src/STIGForge.App/Models/VerifyToolStatus.cs"
      via: "VerifyRunAsync populates and updates VerifyToolStatuses per-tool"
---

<objective>
Add verify progress feedback (UX-01) and error recovery guidance (UX-02) to the WPF VerifyView.

Purpose: Replace the blank/minimal verify status with live per-tool progress rows showing tool name, state, elapsed time, and finding count. Replace bare error messages with structured error panels containing recovery steps.
Output: VerifyToolStatus model, updated VerifyView.xaml with progress panel and error panel, updated VerifyRunAsync with per-tool status tracking.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/STIGForge.App/MainViewModel.ApplyVerify.cs
@src/STIGForge.App/Views/VerifyView.xaml
@.planning/phases/19-wpf-workflow-ux-polish-and-export-format-picker/19-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VerifyToolStatus model and wire into VerifyRunAsync with error recovery</name>
  <files>
    src/STIGForge.App/Models/VerifyToolStatus.cs
    src/STIGForge.App/MainViewModel.ApplyVerify.cs
  </files>
  <action>
Create `src/STIGForge.App/Models/VerifyToolStatus.cs`:
- Class `VerifyToolStatus` extending `ObservableObject` (CommunityToolkit.Mvvm)
- Properties (all [ObservableProperty]):
  - `toolName` (string) — "Evaluate-STIG" or "SCAP"
  - `state` (VerifyToolState enum) — Pending, Running, Complete, Failed
  - `elapsedTime` (TimeSpan) — updated by timer
  - `findingCount` (int) — populated on Complete
  - `stateDisplay` (string, computed) — "Pending", "Running...", "Complete - N findings", "Failed"
- Enum `VerifyToolState { Pending, Running, Complete, Failed }` in same file
- Override OnPropertyChanged to update StateDisplay when State or FindingCount changes

Create `ErrorPanelInfo` class (can be in same file or separate):
- Properties: `errorMessage` (string), `recoverySteps` (List&lt;string&gt;), `canRetry` (bool)
- Static factory method `FromException(Exception ex)` that maps:
  - IOException -> ["Check disk space and file permissions", "Verify the output directory exists and is writable"]
  - TimeoutException -> ["Increase scan timeout in Settings tab", "Check that the scanner tool is not hung"]
  - FileNotFoundException -> ["Verify scanner tool path in Settings tab", "Ensure the tool is installed at the configured location"]
  - General -> ["Review the error details below", "Check tool configuration in Settings tab", "Retry the operation"]

Update `MainViewModel.ApplyVerify.cs`:
- Add `[ObservableProperty] private ObservableCollection&lt;VerifyToolStatus&gt; verifyToolStatuses = new();`
- Add `[ObservableProperty] private ErrorPanelInfo? verifyError = null;`
- Add `[ObservableProperty] private bool hasVerifyError = false;`
- Add DispatcherTimer field `_verifyTimer` (System.Windows.Threading.DispatcherTimer)
- In `VerifyRunAsync()`:
  1. At start: clear VerifyToolStatuses collection, set HasVerifyError = false, VerifyError = null
  2. Before Evaluate-STIG scan: add VerifyToolStatus("Evaluate-STIG", Pending), then set to Running and start timer
  3. After Evaluate-STIG returns: set to Complete with finding count from evalWorkflow.ConsolidatedResultCount, stop timer for that tool
  4. Before SCAP scan: add VerifyToolStatus("SCAP", Pending), then set to Running and start timer
  5. After SCAP returns: set to Complete with finding count from scapWorkflow.ConsolidatedResultCount
  6. In catch block: set all Running tools to Failed, set VerifyError = ErrorPanelInfo.FromException(ex), HasVerifyError = true
  7. Timer tick handler: update ElapsedTime on all Running tools (DateTime.Now - startTime)
- Keep existing VerifyStatus string property for backward compatibility

The DispatcherTimer should tick every 1 second. Start it when first tool goes Running, stop when all tools are Complete or Failed.
  </action>
  <verify>
Build the solution: `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles with zero errors.
Verify VerifyToolStatus class has ToolName, State, ElapsedTime, FindingCount properties.
Verify ErrorPanelInfo.FromException returns correct recovery steps for IOException vs TimeoutException vs general.
  </verify>
  <done>
VerifyToolStatus model exists with all required properties. ErrorPanelInfo.FromException maps exception types to specific recovery steps. VerifyRunAsync creates per-tool status objects, updates state as each scanner runs, and populates error panel on failure. Timer updates elapsed time while running.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update VerifyView.xaml with progress panel and error recovery panel</name>
  <files>
    src/STIGForge.App/Views/VerifyView.xaml
    tests/STIGForge.UnitTests/Views/VerifyProgressContractTests.cs
  </files>
  <action>
Update `src/STIGForge.App/Views/VerifyView.xaml`:

**Verify Progress Panel** — Add below the "Run Verify" button WrapPanel (after line 42 in current file), before the VerifySummary TextBlock:

```xml
<!-- Verify Progress -->
<ItemsControl ItemsSource="{Binding VerifyToolStatuses}" Margin="0,0,0,8">
  <ItemsControl.ItemTemplate>
    <DataTemplate>
      <Border Padding="8,4" Margin="0,2" Background="{DynamicResource SurfaceMutedBrush}">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="140"/>
            <ColumnDefinition Width="100"/>
            <ColumnDefinition Width="80"/>
            <ColumnDefinition Width="*"/>
          </Grid.ColumnDefinitions>
          <TextBlock Grid.Column="0" Text="{Binding ToolName}" FontWeight="SemiBold"/>
          <TextBlock Grid.Column="1" Text="{Binding StateDisplay}"/>
          <TextBlock Grid.Column="2" Text="{Binding ElapsedTime, StringFormat='{}{0:mm\\:ss}'}" Foreground="{DynamicResource TextMutedBrush}"/>
          <TextBlock Grid.Column="3" Text="{Binding FindingCount, StringFormat='{}{0} findings'}" Foreground="{DynamicResource TextMutedBrush}"/>
        </Grid>
      </Border>
    </DataTemplate>
  </ItemsControl.ItemTemplate>
</ItemsControl>
```

Note: Use DataTriggers in the DataTemplate Style to set StateDisplay TextBlock foreground:
- Pending -> TextMutedBrush
- Running -> AccentBrush
- Complete -> SuccessBrush
- Failed -> DangerBrush

Bind the state color using a Style with DataTriggers on the State property. The FindingCount column should only be visible (non-empty text) when State is Complete.

**Error Recovery Panel** — Add after the progress panel, visibility bound to HasVerifyError:

```xml
<!-- Error Recovery -->
<Border BorderThickness="0,0,0,0" Padding="12" Margin="0,0,0,8"
        Visibility="{Binding HasVerifyError, Converter={StaticResource BoolToVisibility}}"
        Background="{DynamicResource SurfaceMutedBrush}">
  <Border.BorderBrush>
    <SolidColorBrush Color="Transparent"/>
  </Border.BorderBrush>
  <!-- Use a left-border accent with DangerBrush -->
  <Border BorderBrush="{DynamicResource DangerBrush}" BorderThickness="4,0,0,0" Padding="12,0,0,0">
    <StackPanel>
      <TextBlock Text="Verification Failed" FontWeight="SemiBold" Foreground="{DynamicResource DangerBrush}" Margin="0,0,0,4"/>
      <TextBlock Text="{Binding VerifyError.ErrorMessage}" TextWrapping="Wrap" Margin="0,0,0,8"/>
      <TextBlock Text="Recovery Steps:" FontWeight="SemiBold" Margin="0,0,0,4"/>
      <ItemsControl ItemsSource="{Binding VerifyError.RecoverySteps}">
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <TextBlock Margin="8,2,0,2" TextWrapping="Wrap">
              <Run Text="- "/><Run Text="{Binding Mode=OneWay}"/>
            </TextBlock>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
      <Button Content="Retry Verify" MinWidth="120" Height="28" Padding="14,0" Margin="0,8,0,0"
              Command="{Binding VerifyRunCommand}" IsEnabled="{Binding ActionsEnabled}"
              HorizontalAlignment="Left"
              AutomationProperties.Name="Retry verify"/>
    </StackPanel>
  </Border>
</Border>
```

**Contract Tests** — Create `tests/STIGForge.UnitTests/Views/VerifyProgressContractTests.cs`:
- Test that VerifyView.xaml contains an ItemsControl with ItemsSource binding to VerifyToolStatuses
- Test that VerifyView.xaml contains a Border with DangerBrush border for error panel
- Test that VerifyView.xaml contains a Retry button bound to VerifyRunCommand
- Test that VerifyToolStatus model has required properties (ToolName, State, ElapsedTime, FindingCount)
- Test ErrorPanelInfo.FromException returns non-empty recovery steps for IOException, TimeoutException, FileNotFoundException

Use the same XAML-content-inspection pattern as existing layout contract tests (read file as string, assert Contains for key binding expressions).
  </action>
  <verify>
Build the solution: `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles clean.
Run tests: `dotnet test tests/STIGForge.UnitTests/ --filter VerifyProgress` — all pass.
Inspect VerifyView.xaml contains ItemsControl bound to VerifyToolStatuses and error panel with DangerBrush.
  </verify>
  <done>
VerifyView.xaml shows per-tool progress rows with tool name, state (color-coded), elapsed time, and finding count. Error recovery panel with DangerBrush left border appears on failure with error message, numbered recovery steps, and Retry button. Contract tests verify layout bindings and error model behavior.
  </done>
</task>

</tasks>

<verification>
1. Build: `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles with zero errors
2. Tests: `dotnet test tests/STIGForge.UnitTests/ --filter VerifyProgress` — all contract tests pass
3. Full regression: `dotnet test tests/STIGForge.UnitTests/` — no regressions in existing tests
4. VerifyView.xaml contains ItemsControl bound to VerifyToolStatuses
5. VerifyView.xaml contains error panel with DangerBrush border and retry button
6. VerifyToolStatus has ToolName, State, ElapsedTime, FindingCount properties
7. ErrorPanelInfo.FromException maps IOException, TimeoutException, FileNotFoundException to specific recovery steps
</verification>

<success_criteria>
- VerifyToolStatus model exists with observable properties for tool name, state, elapsed time, finding count
- VerifyRunAsync updates per-tool status as each scanner starts, completes, or fails
- VerifyView.xaml displays progress rows with state-specific colors
- Error panel with recovery guidance appears when verify fails
- All new contract tests pass, zero regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/19-wpf-workflow-ux-polish-and-export-format-picker/19-01-SUMMARY.md`
</output>
