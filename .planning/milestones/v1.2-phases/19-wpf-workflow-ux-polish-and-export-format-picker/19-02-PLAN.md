---
phase: 19-wpf-workflow-ux-polish-and-export-format-picker
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.App/Views/ExportView.xaml
  - src/STIGForge.App/MainViewModel.Export.cs
  - tests/STIGForge.UnitTests/Views/QuickExportContractTests.cs
autonomous: true
requirements: [UX-03]

must_haves:
  truths:
    - "Operator selects an export format from a ComboBox populated by registered IExportAdapter entries"
    - "Operator triggers export with a single Export button; button is disabled while export is running"
    - "Quick Export tab appears after Dashboard and before eMASS in the ExportView TabControl"
    - "All 5 adapters (eMASS, CKL, XCCDF, CSV, Excel) are registered in ExportAdapterRegistry at startup"
  artifacts:
    - path: "src/STIGForge.App/Views/ExportView.xaml"
      provides: "Quick Export tab with format ComboBox and Export button"
      contains: "Quick Export"
    - path: "src/STIGForge.App/MainViewModel.Export.cs"
      provides: "QuickExportCommand, SelectedExportFormat, ExportAdapterRegistry wiring"
      contains: "QuickExportAsync"
    - path: "tests/STIGForge.UnitTests/Views/QuickExportContractTests.cs"
      provides: "Layout and behavior contract tests for Quick Export tab"
  key_links:
    - from: "src/STIGForge.App/Views/ExportView.xaml"
      to: "src/STIGForge.App/MainViewModel.Export.cs"
      via: "ComboBox ItemsSource bound to ExportFormatNames, Export button bound to QuickExportCommand"
    - from: "src/STIGForge.App/MainViewModel.Export.cs"
      to: "src/STIGForge.Export/ExportAdapterRegistry.cs"
      via: "Registry.TryResolve(SelectedExportFormat) dispatches to correct adapter"
---

<objective>
Add a Quick Export tab to the WPF ExportView driven by ExportAdapterRegistry (UX-03).

Purpose: Replace the need for operators to navigate per-format export tabs by providing a unified format picker ComboBox that resolves to any registered IExportAdapter. Keeps existing eMASS and POA&M/CKL tabs for format-specific options.
Output: Quick Export TabItem in ExportView.xaml, QuickExportCommand in MainViewModel.Export.cs, adapter registry initialization, contract tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/STIGForge.App/Views/ExportView.xaml
@src/STIGForge.App/MainViewModel.Export.cs
@src/STIGForge.Export/ExportAdapterRegistry.cs
@src/STIGForge.Export/ExportModels.cs
@.planning/phases/19-wpf-workflow-ux-polish-and-export-format-picker/19-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ExportAdapterRegistry and QuickExportCommand to MainViewModel</name>
  <files>
    src/STIGForge.App/MainViewModel.Export.cs
  </files>
  <action>
Update `src/STIGForge.App/MainViewModel.Export.cs` to add Quick Export support:

**New properties:**
- `[ObservableProperty] private string selectedExportFormat = "";`
- `[ObservableProperty] private string quickExportSystemName = "";`
- `[ObservableProperty] private string quickExportFileName = "";`
- `[ObservableProperty] private string quickExportStatus = "";`
- `public IReadOnlyList&lt;string&gt; ExportFormatNames { get; }` — populated from registry in constructor or init

**Registry field:**
- `private readonly ExportAdapterRegistry _exportRegistry = new();`

**Registry initialization method** (called from constructor or initialization):
```csharp
private void InitializeExportRegistry()
{
    // Register adapters that work with consolidated results
    // eMASS requires DI dependencies — skip for Quick Export (has dedicated tab)
    _exportRegistry.Register(new CklExportAdapter());
    _exportRegistry.Register(new XccdfExportAdapter());
    _exportRegistry.Register(new CsvExportAdapter());
    _exportRegistry.Register(new ExcelExportAdapter());
}
```

Note: Check if MainViewModel has a constructor or initialization point where this can be called. If the constructor already exists in another partial class file, add the registry init call there. The ExportFormatNames list should be populated after registration: `ExportFormatNames = _exportRegistry.GetAll().Select(a => a.FormatName).ToList();`

**QuickExportCommand:**
```csharp
[RelayCommand]
private async Task QuickExportAsync()
{
    if (IsBusy) return;
    try
    {
        IsBusy = true;
        if (string.IsNullOrWhiteSpace(BundleRoot))
        {
            QuickExportStatus = "Select a bundle first.";
            return;
        }

        if (string.IsNullOrWhiteSpace(SelectedExportFormat))
        {
            QuickExportStatus = "Select an export format.";
            return;
        }

        var adapter = _exportRegistry.TryResolve(SelectedExportFormat);
        if (adapter == null)
        {
            QuickExportStatus = "Unknown format: " + SelectedExportFormat;
            return;
        }

        QuickExportStatus = "Exporting " + SelectedExportFormat + "...";

        // Load verify results from consolidated-results.json
        var resultsPath = Path.Combine(BundleRoot, "Verify", "consolidated-results.json");
        IReadOnlyList<STIGForge.Verify.ControlResult> results;
        if (File.Exists(resultsPath))
        {
            results = STIGForge.Verify.VerifyReportReader.LoadFromJson(resultsPath);
        }
        else
        {
            QuickExportStatus = "No verify results found. Run Verify first.";
            return;
        }

        var outputDir = Path.Combine(BundleRoot, "Export");
        var options = new Dictionary<string, string>();
        if (!string.IsNullOrWhiteSpace(QuickExportSystemName))
            options["system-name"] = QuickExportSystemName;

        var request = new ExportAdapterRequest
        {
            BundleRoot = BundleRoot,
            Results = results,
            OutputDirectory = outputDir,
            FileNameStem = string.IsNullOrWhiteSpace(QuickExportFileName) ? null : QuickExportFileName,
            Options = options
        };

        var result = await adapter.ExportAsync(request, _cts.Token);

        if (result.Success)
        {
            var paths = string.Join(", ", result.OutputPaths);
            QuickExportStatus = "Export complete: " + paths;
            if (result.OutputPaths.Count > 0)
                LastOutputPath = result.OutputPaths[0];
        }
        else
        {
            QuickExportStatus = "Export failed: " + (result.ErrorMessage ?? "Unknown error");
        }
    }
    catch (Exception ex)
    {
        QuickExportStatus = "Export failed: " + ex.Message;
    }
    finally
    {
        IsBusy = false;
    }
}
```

**Important:** Check if `VerifyReportReader.LoadFromJson` exists and returns `IReadOnlyList&lt;ControlResult&gt;`. If it returns a different type (like `VerifyReport`), extract the results list from that. Grep for `LoadFromJson` in the Verify project to confirm the signature.

Also add the required using statements at the top: `using System.Collections.ObjectModel;` and `using STIGForge.Export;` (if not already present).
  </action>
  <verify>
Build: `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles clean.
Verify QuickExportAsync method exists with IsBusy guard, format resolution, results loading, and adapter dispatch.
Verify ExportFormatNames is populated with adapter format names.
  </verify>
  <done>
MainViewModel has ExportAdapterRegistry with 4 adapters registered (CKL, XCCDF, CSV, Excel). QuickExportCommand loads verify results, resolves adapter by format name, and dispatches export with system name and file name options. Export button is disabled while IsBusy via existing ActionsEnabled binding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Quick Export tab to ExportView.xaml and write contract tests</name>
  <files>
    src/STIGForge.App/Views/ExportView.xaml
    tests/STIGForge.UnitTests/Views/QuickExportContractTests.cs
  </files>
  <action>
Update `src/STIGForge.App/Views/ExportView.xaml`:

Insert a new TabItem after Dashboard and before eMASS (between the closing `&lt;/TabItem&gt;` of Dashboard at approximately line 132 and the `&lt;TabItem Header="eMASS"&gt;` at line 135):

```xml
<!-- Quick Export Tab -->
<TabItem Header="Quick Export">
  <ScrollViewer VerticalScrollBarVisibility="Auto">
    <StackPanel Margin="12">
      <TextBlock Text="Quick Export" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,4"/>
      <TextBlock Text="Export verify results in any registered format. For format-specific options (eMASS validation, CKL host name), use the dedicated tabs."
                 Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap" Margin="0,0,0,12"/>

      <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" Padding="12" Margin="0,0,0,10" Background="{DynamicResource SurfaceMutedBrush}">
        <StackPanel>
          <WrapPanel Margin="0,0,0,8">
            <TextBlock Text="Format:" Width="100" VerticalAlignment="Center"/>
            <ComboBox Width="200" ItemsSource="{Binding ExportFormatNames}" SelectedItem="{Binding SelectedExportFormat}"
                      AutomationProperties.Name="Export format selection"
                      ToolTipService.ToolTip="Select the export format. All registered adapters are available."/>
          </WrapPanel>
          <WrapPanel Margin="0,0,0,8">
            <TextBlock Text="System Name:" Width="100" VerticalAlignment="Center"/>
            <TextBox Width="260" Text="{Binding QuickExportSystemName}"
                     AutomationProperties.Name="Quick export system name"
                     ToolTipService.ToolTip="System name included in the export. Leave blank for auto-detection from bundle."/>
          </WrapPanel>
          <WrapPanel Margin="0,0,0,8">
            <TextBlock Text="File Name:" Width="100" VerticalAlignment="Center"/>
            <TextBox Width="260" Text="{Binding QuickExportFileName}"
                     AutomationProperties.Name="Quick export file name"
                     ToolTipService.ToolTip="Optional file name stem. Leave blank for default naming."/>
          </WrapPanel>
          <WrapPanel Margin="0,0,0,8">
            <Button Content="Export" MinWidth="140" Height="32" Padding="14,0" FontWeight="SemiBold"
                    Command="{Binding QuickExportCommand}" IsEnabled="{Binding ActionsEnabled}"
                    AutomationProperties.Name="Run quick export"
                    ToolTipService.ToolTip="Export verify results using the selected format adapter."/>
            <Button Content="Open Last Output" MinWidth="140" Height="32" Padding="14,0" Margin="10,0,0,0"
                    Command="{Binding OpenLastOutputCommand}" AutomationProperties.Name="Open last output"/>
          </WrapPanel>
        </StackPanel>
      </Border>

      <TextBlock Text="{Binding QuickExportStatus}" Foreground="{DynamicResource TextMutedBrush}" TextWrapping="Wrap" Margin="0,0,0,4"/>
    </StackPanel>
  </ScrollViewer>
</TabItem>
```

**Contract Tests** — Create `tests/STIGForge.UnitTests/Views/QuickExportContractTests.cs`:
- Test that ExportView.xaml contains TabItem with Header "Quick Export"
- Test that ExportView.xaml contains ComboBox bound to ExportFormatNames
- Test that ExportView.xaml contains ComboBox SelectedItem bound to SelectedExportFormat
- Test that ExportView.xaml contains Button bound to QuickExportCommand
- Test that the Quick Export TabItem appears before the eMASS TabItem in the file (by checking string positions)
- Test that ExportAdapterRegistry registers at least 4 adapters (instantiate registry, register adapters, check GetAll().Count >= 4)
- Test that QuickExportSystemName TextBox exists with binding

Use the same XAML-content-inspection pattern as existing layout contract tests (read the .xaml file as string, assert Contains for key binding expressions).

Follow the pattern from existing tests like `ImportViewLayoutContractTests.cs` for the XAML inspection approach.
  </action>
  <verify>
Build: `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles clean.
Run tests: `dotnet test tests/STIGForge.UnitTests/ --filter QuickExport` — all pass.
Inspect ExportView.xaml: Quick Export tab exists between Dashboard and eMASS with ComboBox, TextBoxes, and Export button.
  </verify>
  <done>
ExportView.xaml has Quick Export tab after Dashboard and before eMASS. ComboBox is populated by ExportFormatNames from the adapter registry. Export button calls QuickExportCommand and is disabled when busy. Contract tests verify XAML layout bindings and registry population.
  </done>
</task>

</tasks>

<verification>
1. Build: `dotnet build src/STIGForge.App/STIGForge.App.csproj` compiles with zero errors
2. Tests: `dotnet test tests/STIGForge.UnitTests/ --filter QuickExport` — all contract tests pass
3. Full regression: `dotnet test tests/STIGForge.UnitTests/` — no regressions in existing tests
4. ExportView.xaml contains Quick Export TabItem with format ComboBox, system name TextBox, file name TextBox, and Export button
5. Quick Export tab appears after Dashboard and before eMASS
6. ExportAdapterRegistry has 4 adapters registered (CKL, XCCDF, CSV, Excel)
7. QuickExportCommand resolves adapter from registry and calls ExportAsync
</verification>

<success_criteria>
- Quick Export tab appears in ExportView between Dashboard and eMASS
- ComboBox populated with format names from ExportAdapterRegistry.GetAll()
- Export button dispatches to correct adapter via registry.TryResolve
- Export button disabled while IsBusy (ActionsEnabled binding)
- System name and file name options passed to adapter request
- All contract tests pass, zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/19-wpf-workflow-ux-polish-and-export-format-picker/19-02-SUMMARY.md`
</output>
