---
phase: 17-csv-compliance-report
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Export/CsvExportAdapter.cs
  - tests/STIGForge.UnitTests/Export/CsvExportAdapterTests.cs
  - src/STIGForge.Cli/Commands/ExportCommands.cs
autonomous: true
requirements: [EXP-02]

must_haves:
  truths:
    - "Operator runs export-csv CLI command and receives a CSV file with management-facing columns"
    - "CSV header row uses human-readable column names (Vulnerability ID, CAT Level, etc.)"
    - "Fields containing commas, quotes, or newlines are correctly RFC 4180 escaped"
    - "Empty results produce a header-only CSV (not an empty file)"
    - "If adapter throws, no partial output file remains on disk"
  artifacts:
    - path: "src/STIGForge.Export/CsvExportAdapter.cs"
      provides: "IExportAdapter implementation generating management-facing CSV"
    - path: "tests/STIGForge.UnitTests/Export/CsvExportAdapterTests.cs"
      provides: "CSV export contract tests including escaping edge cases"
    - path: "src/STIGForge.Cli/Commands/ExportCommands.cs"
      provides: "RegisterExportCsv CLI command wiring"
  key_links:
    - from: "src/STIGForge.Export/CsvExportAdapter.cs"
      to: "IExportAdapter"
      via: "implements interface"
      pattern: "class CsvExportAdapter.*IExportAdapter"
    - from: "src/STIGForge.Cli/Commands/ExportCommands.cs"
      to: "CsvExportAdapter"
      via: "CLI handler creates adapter and calls ExportAsync"
      pattern: "new CsvExportAdapter"
---

<objective>
Implement CsvExportAdapter that generates management-facing CSV compliance reports from ControlResult data, with RFC 4180 escaping and export-csv CLI command.

Purpose: Operators need a CSV export for management/auditor review that is filterable in Excel and human-readable.
Output: CsvExportAdapter.cs, CsvExportAdapterTests.cs, export-csv CLI command
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/STIGForge.Export/ExportModels.cs
@src/STIGForge.Export/XccdfExportAdapter.cs
@src/STIGForge.Verify/VerifyModels.cs
@src/STIGForge.Cli/Commands/ExportCommands.cs
@tests/STIGForge.UnitTests/Export/XccdfExportAdapterTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CsvExportAdapter with RFC 4180 escaping and management-facing columns</name>
  <files>src/STIGForge.Export/CsvExportAdapter.cs, tests/STIGForge.UnitTests/Export/CsvExportAdapterTests.cs</files>
  <action>
Create `CsvExportAdapter.cs` implementing `IExportAdapter`:

**Adapter properties:**
- `FormatName` => `"CSV"`
- `SupportedExtensions` => `new[] { ".csv" }`

**ExportAsync method:**
- Follow the same fail-closed write pattern as XccdfExportAdapter: write to `.tmp`, rename on success, delete tmp in catch
- Use `StreamWriter` with UTF-8 encoding (no BOM) and explicit `\r\n` line endings
- Default file name stem: `"stigforge_compliance_report"`

**Column design (in order):**

| CSV Header | Source |
|------------|--------|
| System Name | `request.Options["system-name"]` if present, else `Path.GetFileName(request.BundleRoot)`, else empty |
| Vulnerability ID | `result.VulnId` |
| Rule ID | `result.RuleId` |
| STIG Title | `result.Title` |
| Severity | `result.Severity` |
| CAT Level | Derived: high→"CAT I", medium→"CAT II", low→"CAT III", other/null→"Unknown" |
| Status | `result.Status` |
| Finding Details | `result.FindingDetails` |
| Comments | `result.Comments` |
| Remediation Priority | Same as CAT Level (CAT I = highest priority) |
| Tool | `result.Tool` |
| Source File | `result.SourceFile` |
| Verified At | `result.VerifiedAt?.ToString("o")` or empty |

**CSV escaping helper method `EscapeCsvField(string?)`:**
- Null/empty → return empty string
- If field contains comma, double quote, or newline (CR or LF) → wrap in double quotes and escape internal double quotes as `""`
- Otherwise → return field unmodified

**Tests (CsvExportAdapterTests.cs) — follow XccdfExportAdapterTests pattern:**
1. `FormatName_Is_CSV` — assert "CSV"
2. `SupportedExtensions_Contains_Csv` — assert ".csv"
3. `ExportAsync_ProducesCsvWithHeaderRow` — 2 results, verify first line is header with all 13 column names
4. `ExportAsync_ProducesCsvWithCorrectRowCount` — 3 results → 4 lines (header + 3 data)
5. `ExportAsync_EscapesCommasInFields` — result with comma in FindingDetails → field is double-quoted in output
6. `ExportAsync_EscapesDoubleQuotesInFields` — result with double quote in Comments → doubled quotes
7. `ExportAsync_EscapesNewlinesInFields` — result with newline in FindingDetails → field is double-quoted
8. `ExportAsync_EmptyResults_ProducesHeaderOnly` — 0 results → single header line
9. `ExportAsync_NullFields_WrittenAsEmpty` — all-null ControlResult → row of empty fields
10. `ExportAsync_CatLevelMapping` — high→CAT I, medium→CAT II, low→CAT III, null→Unknown
11. `ExportAsync_SystemNameFromOptions` — set Options["system-name"] → appears in System Name column
12. `ExportAsync_SystemNameFromBundleRoot` — no option → uses Path.GetFileName(BundleRoot)
13. `ExportAsync_PartialFileDeletedOnError` — same pattern as XccdfExportAdapter error test
  </action>
  <verify>
Run: `dotnet build src/STIGForge.Export/STIGForge.Export.csproj` — builds clean on both targets
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~CsvExportAdapterTests" --no-restore` — all 13 tests pass
  </verify>
  <done>
CsvExportAdapter implements IExportAdapter with RFC 4180 compliant CSV generation. All 13 tests pass. Fail-closed write pattern prevents partial output on error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire export-csv CLI command with --system-name option</name>
  <files>src/STIGForge.Cli/Commands/ExportCommands.cs</files>
  <action>
Add `RegisterExportCsv(rootCmd, buildHost)` call to the `Register()` method in ExportCommands.cs.

**Create RegisterExportCsv method following the RegisterExportXccdf pattern:**
- Command name: `"export-csv"`
- Description: `"Export compliance report as CSV for management/auditor review"`
- Options:
  - `--bundle` (required) — Bundle root path
  - `--output` (optional) — Output directory override
  - `--file-name` (optional) — Output file name stem (default: stigforge_compliance_report)
  - `--system-name` (optional) — System name for CSV column (defaults to bundle directory name)

**Handler implementation:**
1. Load results from `Verify/consolidated-results.json` using same pattern as export-xccdf (search AllDirectories, load each via VerifyReportReader.LoadFromJson)
2. Build Options dictionary: if system-name is provided, add `["system-name"] = systemName`
3. Create `CsvExportAdapter` and call `ExportAsync`
4. Print: "CSV export:", "  File: {path}", "  Results: {count}"
  </action>
  <verify>
Run: `dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj` — builds clean
Run: `dotnet test tests/STIGForge.UnitTests --no-restore` — full suite passes, no regressions
  </verify>
  <done>
export-csv CLI command is registered with --bundle, --output, --file-name, and --system-name options. Loads results from consolidated-results.json and produces CSV via CsvExportAdapter.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for both STIGForge.Export and STIGForge.Cli projects
2. All CsvExportAdapter tests pass (13 new tests)
3. No regressions in existing export tests
4. CSV output is RFC 4180 compliant: CRLF line endings, proper escaping
5. Fail-closed: partial output deleted on adapter failure
</verification>

<success_criteria>
- CsvExportAdapter implements IExportAdapter with FormatName "CSV"
- CSV includes all 13 management-facing columns with human-readable headers
- RFC 4180 escaping handles commas, quotes, and newlines correctly
- Empty results produce header-only CSV (not empty file)
- export-csv CLI command accepts --bundle, --output, --file-name, --system-name
- 13+ new tests, 0 regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-csv-compliance-report/17-01-SUMMARY.md`
</output>
