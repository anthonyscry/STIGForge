---
phase: 14-scc-verify-correctness-and-model-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/STIGForge.Verify/ScapRunner.cs
  - src/STIGForge.Verify/EvaluateStigRunner.cs
  - src/STIGForge.Core/Abstractions/Services.cs
  - src/STIGForge.Cli/Commands/VerifyCommands.cs
  - tests/STIGForge.UnitTests/TestInfrastructure/RequiresShellFactAttribute.cs
  - tests/STIGForge.UnitTests/TestInfrastructure/RequiresPowerShellFactAttribute.cs
autonomous: true
requirements:
  - VER-01
must_haves:
  truths:
    - "ScapRunner.RunAsync completes with configurable timeout instead of hardcoded 30s"
    - "EvaluateStigRunner.RunAsync completes with configurable timeout instead of hardcoded 30s"
    - "Cancellation token cancels running processes and throws OperationCanceledException"
    - "Timeout expiry kills running processes and throws TimeoutException"
    - "ScapWorkflowOptions and EvaluateStigWorkflowOptions expose TimeoutSeconds property defaulting to 600"
  artifacts:
    - path: "src/STIGForge.Verify/ScapRunner.cs"
      provides: "RunAsync method with configurable timeout and cancellation"
      contains: "RunAsync"
    - path: "src/STIGForge.Verify/EvaluateStigRunner.cs"
      provides: "RunAsync method with configurable timeout and cancellation"
      contains: "RunAsync"
    - path: "src/STIGForge.Core/Abstractions/Services.cs"
      provides: "TimeoutSeconds property on workflow options"
      contains: "TimeoutSeconds"
  key_links:
    - from: "src/STIGForge.Verify/ScapRunner.cs"
      to: "tests/STIGForge.UnitTests/Verify/ScapRunnerTests.cs"
      via: "RunAsync method signature"
      pattern: "RunAsync.*commandPath.*arguments.*workingDirectory.*CancellationToken.*TimeSpan"
    - from: "src/STIGForge.Verify/EvaluateStigRunner.cs"
      to: "tests/STIGForge.UnitTests/Verify/EvaluateStigRunnerTests.cs"
      via: "RunAsync method signature"
      pattern: "RunAsync.*toolRoot.*arguments.*workingDirectory.*CancellationToken.*TimeSpan"
---

<objective>
Add async process execution with configurable timeout and cancellation to ScapRunner and EvaluateStigRunner. Add TimeoutSeconds to workflow options and wire CLI timeout option.

Purpose: The hardcoded 30-second timeout in both runners causes premature termination of real SCC/SCAP scans (which can take minutes). This is the root cause of 0-result verify runs.

Output: Both runners expose RunAsync with configurable TimeSpan timeout and CancellationToken. Existing sync Run() methods remain for backward compatibility. ScapWorkflowOptions and EvaluateStigWorkflowOptions have TimeoutSeconds properties.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-scc-verify-correctness-and-model-unification/14-RESEARCH.md
@src/STIGForge.Verify/ScapRunner.cs
@src/STIGForge.Verify/EvaluateStigRunner.cs
@src/STIGForge.Verify/VerifyModels.cs
@src/STIGForge.Core/Abstractions/Services.cs
@src/STIGForge.Cli/Commands/VerifyCommands.cs
@tests/STIGForge.UnitTests/Verify/ScapRunnerTests.cs
@tests/STIGForge.UnitTests/Verify/EvaluateStigRunnerTests.cs
@tests/STIGForge.UnitTests/Cli/VerifyCommandsTests.cs
@tests/STIGForge.UnitTests/TestInfrastructure/RequiresShellFactAttribute.cs
@tests/STIGForge.UnitTests/TestInfrastructure/RequiresPowerShellFactAttribute.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RunAsync to ScapRunner and EvaluateStigRunner with configurable timeout</name>
  <files>
    src/STIGForge.Verify/ScapRunner.cs
    src/STIGForge.Verify/EvaluateStigRunner.cs
  </files>
  <action>
Add `RunAsync` methods to both runners. The tests are the specification — match the signatures exactly.

**ScapRunner.RunAsync signature** (from ScapRunnerTests.cs):
```csharp
public async Task<VerifyRunResult> RunAsync(
    string commandPath, string arguments, string? workingDirectory,
    CancellationToken ct, TimeSpan? timeout = null)
```

**EvaluateStigRunner.RunAsync signature** (from EvaluateStigRunnerTests.cs):
```csharp
public async Task<VerifyRunResult> RunAsync(
    string toolRoot, string arguments, string? workingDirectory,
    CancellationToken ct, TimeSpan? timeout = null)
```

Implementation pattern for both (adapt ScapRunner's existing validation/PSI setup):
1. Validate inputs (same as existing `Run()` method).
2. Set up `ProcessStartInfo` (same as existing `Run()` method).
3. Start process, read stdout/stderr with `ReadToEndAsync()` (no CancellationToken overload — use the parameterless one for net48 compat).
4. Use `Task.Run(() => process.WaitForExit((int)effectiveTimeout.TotalMilliseconds))` for async wait with timeout — this avoids `WaitForExitAsync` which is .NET 6+ only.
5. If `WaitForExit` returns false (timeout): kill process, throw `TimeoutException`.
6. After wait completes: check `ct.ThrowIfCancellationRequested()`.
7. For cancellation during wait: use `ct.Register(() => { try { KillProcess(process); } catch { } })` before the wait. When the process is killed by cancellation, `WaitForExit` returns (process exited), then `ct.ThrowIfCancellationRequested()` throws.

**CRITICAL net48 compatibility:**
- Do NOT use `Process.Kill(true)` — it's .NET 5+ only.
- Use `#if NET5_0_OR_GREATER` guard: `process.Kill(true)` on .NET 5+, `process.Kill()` on net48.
- Do NOT use `ReadToEndAsync(CancellationToken)` overload — it's .NET 7+ only. Use `ReadToEndAsync()` (parameterless).
- Do NOT use `WaitForExitAsync()` — it's .NET 6+ only. Use `Task.Run(() => process.WaitForExit(ms))`.

Keep existing sync `Run()` methods unchanged for backward compatibility.

Default timeout: `TimeSpan.FromSeconds(600)` (10 minutes) when `timeout` is null.
  </action>
  <verify>
Run: `dotnet build src/STIGForge.Verify/STIGForge.Verify.csproj` — must compile for both net48 and net8.0 targets.
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~ScapRunnerTests" --no-build` — all ScapRunnerTests pass (on Linux, RequiresShellFact tests use /bin/sh).
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~EvaluateStigRunnerTests" --no-build` — all EvaluateStigRunnerTests pass (RequiresPowerShellFact may skip on Linux, but the compile check is critical).
  </verify>
  <done>
ScapRunner.RunAsync and EvaluateStigRunner.RunAsync exist with correct signatures. Both throw TimeoutException on timeout, OperationCanceledException on cancellation. Both compile on net48 and net8.0. ScapRunnerTests pass. EvaluateStigRunnerTests compile (may skip on Linux if PowerShell unavailable).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TimeoutSeconds to workflow options and wire CLI timeout option</name>
  <files>
    src/STIGForge.Core/Abstractions/Services.cs
    src/STIGForge.Cli/Commands/VerifyCommands.cs
  </files>
  <action>
**In `src/STIGForge.Core/Abstractions/Services.cs`:**

Add `TimeoutSeconds` property to both options classes:

1. In `ScapWorkflowOptions` (after `ToolLabel` property):
   ```csharp
   public int TimeoutSeconds { get; set; } = 600;
   ```

2. In `EvaluateStigWorkflowOptions` (after `WorkingDirectory` property):
   ```csharp
   public int TimeoutSeconds { get; set; } = 600;
   ```

**In `src/STIGForge.Cli/Commands/VerifyCommands.cs`:**

Add `--timeout` option to both `verify-evaluate-stig` and `verify-scap` commands:
```csharp
var timeoutOpt = new Option<int>("--timeout", () => 600, "Scan timeout in seconds (default: 600)");
cmd.AddOption(timeoutOpt);
```

Wire timeout into the request builder lambda — set `request.Scap.TimeoutSeconds = timeout` (or `request.EvaluateStig.TimeoutSeconds = timeout`).

Ensure the VerifyCommandsTests still pass — they use reflection and the method signatures must remain compatible.
  </action>
  <verify>
Run: `dotnet build src/STIGForge.Cli/STIGForge.Cli.csproj` — compiles.
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~VerifyCommandsTests"` — all pass.
Verify: `ScapWorkflowOptions` and `EvaluateStigWorkflowOptions` both have `TimeoutSeconds` property with default 600.
  </verify>
  <done>
ScapWorkflowOptions.TimeoutSeconds and EvaluateStigWorkflowOptions.TimeoutSeconds exist with default 600. CLI `verify-evaluate-stig` and `verify-scap` commands accept `--timeout` option. VerifyCommandsTests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for all targets (net48 + net8.0).
2. ScapRunnerTests pass (RunAsync with exit code, timeout, cancellation).
3. EvaluateStigRunnerTests compile and pass where PowerShell is available.
4. VerifyCommandsTests pass (reflection-based tests for CLI methods).
5. No regressions — existing sync `Run()` methods unchanged.
</verification>

<success_criteria>
- ScapRunner.RunAsync and EvaluateStigRunner.RunAsync exist and match test-specified signatures.
- Timeout is configurable (not hardcoded 30s); default is 600s.
- CancellationToken propagation kills the process.
- TimeoutSeconds property exists on both workflow options.
- CLI commands accept --timeout option.
- All targeted tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/14-scc-verify-correctness-and-model-unification/14-01-SUMMARY.md`
</output>
