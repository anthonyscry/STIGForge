---
phase: 14-scc-verify-correctness-and-model-unification
plan: 02
type: execute
wave: 2
depends_on:
  - "14-01"
files_modified:
  - src/STIGForge.Verify/VerificationWorkflowService.cs
  - src/STIGForge.Verify/VerifyReportWriter.cs
  - src/STIGForge.Verify/CklParser.cs
  - src/STIGForge.App/MainViewModel.cs
  - src/STIGForge.App/MainViewModel.Dashboard.cs
  - src/STIGForge.App/Views/VerifyView.xaml
autonomous: true
requirements:
  - VER-02
  - VER-03
  - VER-04
  - VER-05
must_haves:
  truths:
    - "Verify workflow discovers both .ckl and .xml files from Sessions/ subdirectories"
    - "XCCDF results flow through VerifyOrchestrator adapter chain, not just CKL-only path"
    - "NormalizedVerifyResult is bridged to ControlResult with correct status string mapping for downstream export"
    - "CklParser rejects XXE-bearing XML with DtdProcessing.Prohibit"
    - "MainViewModel.scapArgs defaults to '-u' (not '-u -s -r -f')"
    - "MainViewModel.scapIncludeF defaults to false (not true)"
    - "VerifyView.xaml has Verify and Settings tabs with correct control placement"
    - "VerificationWorkflowService contains -f safety guard diagnostic message"
  artifacts:
    - path: "src/STIGForge.Verify/VerificationWorkflowService.cs"
      provides: "Orchestrator wiring, model bridge, -f guard, timeout propagation"
      contains: "VerifyOrchestrator"
    - path: "src/STIGForge.Verify/CklParser.cs"
      provides: "Hardened XML loading"
      contains: "LoadSecureXml"
    - path: "src/STIGForge.App/Views/VerifyView.xaml"
      provides: "Tabbed layout with Verify and Settings tabs"
      contains: "TabItem"
    - path: "src/STIGForge.App/MainViewModel.cs"
      provides: "Safe scapArgs and scapIncludeF defaults, VerifyScannerMode property"
      contains: "scapArgs = \"-u\""
  key_links:
    - from: "src/STIGForge.Verify/VerificationWorkflowService.cs"
      to: "src/STIGForge.Verify/VerifyOrchestrator.cs"
      via: "ParseAndMergeResults call"
      pattern: "ParseAndMergeResults"
    - from: "src/STIGForge.Verify/VerificationWorkflowService.cs"
      to: "src/STIGForge.Verify/VerifyModels.cs"
      via: "ToControlResult bridge method"
      pattern: "ToControlResult"
    - from: "src/STIGForge.Verify/CklParser.cs"
      to: "src/STIGForge.Verify/Adapters/CklAdapter.cs"
      via: "Identical LoadSecureXml pattern"
      pattern: "DtdProcessing\\.Prohibit"
    - from: "src/STIGForge.App/MainViewModel.cs"
      to: "tests/STIGForge.UnitTests/Views/ScapArgsOptionsContractTests.cs"
      via: "String literal contract"
      pattern: "scapArgs = \"-u\""
---

<objective>
Wire VerifyOrchestrator into VerificationWorkflowService so XCCDF results flow through the adapter chain. Bridge NormalizedVerifyResult to ControlResult for downstream export. Harden CklParser XML loading. Fix MainViewModel defaults and restructure VerifyView tabs.

Purpose: Without orchestrator wiring, XCCDF output from SCC is silently ignored — only CKL files are processed. The model bridge ensures the existing VerifyReport/CSV/JSON pipeline continues to work with orchestrator-sourced results. CklParser hardening closes a security gap. The UI changes ensure safe `-f` flag handling and proper scanner mode selection.

Output: VerificationWorkflowService uses VerifyOrchestrator for result aggregation. CklParser uses LoadSecureXml. MainViewModel has safe defaults. VerifyView has tabbed layout.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-scc-verify-correctness-and-model-unification/14-RESEARCH.md
@.planning/phases/14-scc-verify-correctness-and-model-unification/14-01-SUMMARY.md
@src/STIGForge.Verify/VerificationWorkflowService.cs
@src/STIGForge.Verify/VerifyOrchestrator.cs
@src/STIGForge.Verify/VerifyReportWriter.cs
@src/STIGForge.Verify/CklParser.cs
@src/STIGForge.Verify/NormalizedVerifyResult.cs
@src/STIGForge.Verify/VerifyModels.cs
@src/STIGForge.App/MainViewModel.cs
@src/STIGForge.App/MainViewModel.Dashboard.cs
@src/STIGForge.App/Views/VerifyView.xaml
@tests/STIGForge.UnitTests/Verify/VerificationWorkflowServiceTests.cs
@tests/STIGForge.UnitTests/Verify/VerifyReportWriterTests.cs
@tests/STIGForge.UnitTests/Views/VerifyViewLayoutContractTests.cs
@tests/STIGForge.UnitTests/Views/ScapArgsOptionsContractTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire VerifyOrchestrator into VerificationWorkflowService with model bridge and -f guard</name>
  <files>
    src/STIGForge.Verify/VerificationWorkflowService.cs
    src/STIGForge.Verify/CklParser.cs
  </files>
  <action>
**VerificationWorkflowService changes:**

1. **Switch runners to RunAsync with timeout propagation.** In `RunEvaluateStigIfConfigured`, replace:
   ```csharp
   var runResult = _evaluateStigRunner.Run(...)
   ```
   with:
   ```csharp
   var runResult = await _evaluateStigRunner.RunAsync(
       request.EvaluateStig.ToolRoot,
       request.EvaluateStig.Arguments,
       ...,
       ct,
       TimeSpan.FromSeconds(request.EvaluateStig.TimeoutSeconds));
   ```
   Make the method `async Task<VerificationToolRunResult>` (change from sync). Same pattern for `RunScapIfConfigured` using `_scapRunner.RunAsync(...)` with `request.Scap.TimeoutSeconds`.

   Update `RunAsync` to `await` these calls instead of calling them synchronously. The return type is already `Task<...>` so remove `Task.FromResult` and make the method genuinely async.

2. **Wire VerifyOrchestrator for file discovery and parsing (VER-02, VER-03).** Replace the `VerifyReportWriter.BuildFromCkls(outputRoot, toolLabel)` call with orchestrator-based discovery:
   ```csharp
   // Discover all result files (CKL + XCCDF XML)
   var cklFiles = Directory.GetFiles(request.OutputRoot, "*.ckl", SearchOption.AllDirectories);
   var xmlFiles = Directory.GetFiles(request.OutputRoot, "*.xml", SearchOption.AllDirectories);
   var allFiles = cklFiles.Concat(xmlFiles)
       .OrderBy(p => p, StringComparer.OrdinalIgnoreCase)
       .ToList();

   // Parse through orchestrator adapter chain
   var orchestrator = new VerifyOrchestrator();
   var consolidated = orchestrator.ParseAndMergeResults(allFiles);

   // Bridge NormalizedVerifyResult -> ControlResult for downstream VerifyReport pipeline
   var results = consolidated.Results.Select(ToControlResult).ToList();

   var report = new VerifyReport
   {
       Tool = toolLabel,
       ToolVersion = "unknown",
       StartedAt = DateTimeOffset.Now,
       FinishedAt = DateTimeOffset.Now,
       OutputRoot = request.OutputRoot,
       Results = results
   };
   ```

3. **Add NormalizedVerifyResult -> ControlResult bridge (VER-04).** Add private static methods:
   ```csharp
   private static ControlResult ToControlResult(NormalizedVerifyResult r)
   {
       return new ControlResult
       {
           VulnId = r.VulnId,
           RuleId = r.RuleId,
           Title = r.Title,
           Severity = r.Severity,
           Status = MapStatusToString(r.Status),
           FindingDetails = r.FindingDetails,
           Comments = r.Comments,
           Tool = r.Tool,
           SourceFile = r.SourceFile,
           VerifiedAt = r.VerifiedAt
       };
   }

   private static string MapStatusToString(VerifyStatus status) => status switch
   {
       VerifyStatus.Pass => "NotAFinding",
       VerifyStatus.Fail => "Open",
       VerifyStatus.NotApplicable => "Not_Applicable",
       VerifyStatus.NotReviewed => "Not_Reviewed",
       VerifyStatus.Informational => "Informational",
       VerifyStatus.Error => "Error",
       _ => "Not_Reviewed"
   };
   ```
   CRITICAL: These exact status strings must match what `VerifyReportWriter.IsClosed()` expects: `"notafinding"`, `"open"`, `"not_applicable"`, `"not_reviewed"`. The lowercase comparison in `IsClosed` handles the casing.

4. **Add -f flag safety guard.** In `RunScapIfConfigured`, before launching the process, validate the arguments string. Add a check:
   ```csharp
   var sanitizedArgs = SanitizeScapArgs(request.Scap.Arguments, diagnostics);
   ```
   Where `SanitizeScapArgs` strips `-f` if it's the last token (no following filename value):
   ```csharp
   private static string SanitizeScapArgs(string args, List<string> diagnostics)
   {
       if (string.IsNullOrWhiteSpace(args)) return args;
       var tokens = args.Split(new[] { ' ', '\t' }, StringSplitOptions.RemoveEmptyEntries).ToList();
       for (int i = 0; i < tokens.Count; i++)
       {
           if (string.Equals(tokens[i], "-f", StringComparison.OrdinalIgnoreCase))
           {
               // -f requires a following filename argument
               if (i + 1 >= tokens.Count || tokens[i + 1].StartsWith("-"))
               {
                   tokens.RemoveAt(i);
                   diagnostics.Add("SCAP argument '-f' was missing a filename; removed invalid switch.");
                   i--;
               }
           }
       }
       return string.Join(" ", tokens);
   }
   ```
   The diagnostic message text MUST be exactly: `"SCAP argument '-f' was missing a filename; removed invalid switch."` — the `ScapArgsOptionsContractTests` checks for this exact string in the source file.

5. **Add orchestrator diagnostics to workflow diagnostics.** Append `consolidated.DiagnosticMessages` to the workflow's diagnostics list.

**CklParser changes (VER-05):**

Replace `XDocument.Load(path)` with `LoadSecureXml(path)`. Add private static method:
```csharp
private static XDocument LoadSecureXml(string filePath)
{
    var settings = new System.Xml.XmlReaderSettings
    {
        DtdProcessing = System.Xml.DtdProcessing.Prohibit,
        XmlResolver = null,
        IgnoreWhitespace = true,
        MaxCharactersFromEntities = 1024,
        MaxCharactersInDocument = 20_000_000,
        Async = false
    };
    try
    {
        using var reader = System.Xml.XmlReader.Create(filePath, settings);
        return XDocument.Load(reader, LoadOptions.None);
    }
    catch (System.Xml.XmlException ex)
    {
        throw new InvalidDataException(
            $"[VERIFY-CKL-XML-001] Failed to parse CKL XML '{filePath}': {ex.Message}", ex);
    }
}
```
Add `using System.IO;` if not already present for `InvalidDataException`.

This exactly matches the pattern in `CklAdapter.LoadSecureXml()` and `ScapResultAdapter.LoadSecureXml()`.
  </action>
  <verify>
Run: `dotnet build src/STIGForge.Verify/STIGForge.Verify.csproj` — compiles for both targets.
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~VerificationWorkflowServiceTests"` — passes.
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~VerifyReportWriterTests"` — passes.
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~ScapArgsOptionsContractTests.MainViewModelDashboard_OnlyAddsFWhenValuePresent"` — the source-contract check for `-f` diagnostic message passes.
Verify: CklParser.cs contains `DtdProcessing.Prohibit`.
  </verify>
  <done>
VerificationWorkflowService uses VerifyOrchestrator.ParseAndMergeResults for file discovery and parsing. NormalizedVerifyResult is bridged to ControlResult with correct status strings. -f flag safety guard strips invalid -f with exact diagnostic message. CklParser uses LoadSecureXml with DTD prohibition. All targeted tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix MainViewModel defaults and restructure VerifyView tabs</name>
  <files>
    src/STIGForge.App/MainViewModel.cs
    src/STIGForge.App/MainViewModel.Dashboard.cs
    src/STIGForge.App/Views/VerifyView.xaml
  </files>
  <action>
**MainViewModel.cs changes:**

1. Change scapArgs default from `"-u -s -r -f"` to `"-u"`:
   ```csharp
   [ObservableProperty] private string scapArgs = "-u";
   ```

2. Change scapIncludeF default from `true` to uninitialized (no `= true`):
   ```csharp
   [ObservableProperty] private bool scapIncludeF;
   ```
   IMPORTANT: Do NOT write `= false` — the test checks for the exact string `[ObservableProperty] private bool scapIncludeF;` without any initializer.

3. Add VerifyScannerMode property. Define enum and property:
   ```csharp
   [ObservableProperty] private VerifyScannerMode verifyScannerMode;
   ```
   Add the enum (can be in MainViewModel.cs or a separate file in STIGForge.App — use a nested section at the bottom of MainViewModel.cs or at the namespace level):
   ```csharp
   public enum VerifyScannerMode { Scap, EvaluateStig, Both }
   ```

**MainViewModel.Dashboard.cs changes:**

In the `UpdateScapArgsFromOptions()` method, add the `-f` conditional logic. The test `MainViewModelDashboard_OnlyAddsFWhenValuePresent` checks that the source contains these exact strings:
- `var includeF = ScapIncludeF && hasValueInExtraArgs;`
- `if (includeF)`
- `ScapIncludeF = includeF;`

Modify `UpdateScapArgsFromOptions()`:
```csharp
private void UpdateScapArgsFromOptions()
{
    var hasValueInExtraArgs = !string.IsNullOrWhiteSpace(ScapAdditionalArgs);
    var includeF = ScapIncludeF && hasValueInExtraArgs;

    var parts = new List<string>();
    if (ScapIncludeU)
      parts.Add("-u");
    if (ScapIncludeS)
      parts.Add("-s");
    if (ScapIncludeR)
      parts.Add("-r");
    if (includeF)
      parts.Add("-f");

    if (hasValueInExtraArgs)
      parts.Add(ScapAdditionalArgs!.Trim());

    var combined = string.Join(" ", parts);
    if (string.Equals(ScapArgs, combined, StringComparison.Ordinal))
    {
      OnPropertyChanged(nameof(ScapArgsPreview));
      return;
    }

    ScapIncludeF = includeF;

    _suppressScapArgsSync = true;
    ScapArgs = combined;
    _suppressScapArgsSync = false;
    OnPropertyChanged(nameof(ScapArgsPreview));
}
```

The key change: `-f` is only added when `ScapIncludeF && hasValueInExtraArgs`. When the checkbox is checked but extra args is empty, `-f` is suppressed and `ScapIncludeF` is reset to `false`.

**VerifyView.xaml changes:**

Restructure from flat `ScrollViewer > StackPanel` to `TabControl` with two tabs: "Verify" and "Settings".

The "Verify" tab must contain:
- Bundle path input (BundleRoot binding + Browse/Open buttons)
- Scanner mode ComboBox bound to `{Binding VerifyScannerMode}` with `SelectedItem="{Binding VerifyScannerMode}"`
- Run Verify button and status display
- Overlap analysis section

The "Settings" tab must contain:
- TextBox with `Text="{Binding EvaluateStigRoot}"`
- TextBox with `Text="{Binding ScapCommandPath}"`
- TextBox with `Text="{Binding PowerStigModulePath}"`
- Evaluate-STIG args, SCAP options checkboxes, extra args, SCAP args preview, SCAP label
- Browse buttons for each tool path

CRITICAL contract tests to satisfy:
- `VerifyViewLayoutContractTests.VerifyView_SeparatesScanParametersAndToolMappingsIntoVerifyAndSettingsTabs`: expects `TabItem` with Header="Verify" and Header="Settings"
- `VerifyViewLayoutContractTests.VerifyView_ProvidesScannerModeSelectionOnVerifyTab`: expects ComboBox with `SelectedItem="{Binding VerifyScannerMode}"` in Verify tab; expects NO TextBox with `Text="{Binding EvaluateStigRoot}"` or `Text="{Binding ScapCommandPath}"` in Verify tab
- `VerifyViewLayoutContractTests.VerifyView_SettingsTabContainsToolMappingsAndPowerStigPaths`: expects TextBox with `Text="{Binding EvaluateStigRoot}"`, `Text="{Binding ScapCommandPath}"`, `Text="{Binding PowerStigModulePath}"` in Settings tab

Structure:
```xml
<UserControl ...>
  <TabControl>
    <TabItem Header="Verify">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="10">
          <!-- Bundle row -->
          <!-- Scanner mode ComboBox -->
          <ComboBox SelectedItem="{Binding VerifyScannerMode}" ... />
          <!-- Run + Status -->
          <!-- Overlap Analysis -->
        </StackPanel>
      </ScrollViewer>
    </TabItem>
    <TabItem Header="Settings">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="10">
          <!-- EvaluateStigRoot, EvaluateStigArgs -->
          <!-- ScapCommandPath, SCAP options, extra args, preview, label -->
          <!-- PowerStigModulePath -->
          <!-- Browse buttons -->
        </StackPanel>
      </ScrollViewer>
    </TabItem>
  </TabControl>
</UserControl>
```

Preserve ALL existing bindings — just move them to the correct tab. DataContext inheritance means binding paths don't change.
  </action>
  <verify>
Run: `dotnet build src/STIGForge.App/STIGForge.App.csproj` — compiles.
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~VerifyViewLayoutContractTests"` — all 3 tests pass.
Run: `dotnet test tests/STIGForge.UnitTests --filter "FullyQualifiedName~ScapArgsOptionsContractTests"` — both tests pass.
Verify: MainViewModel.cs contains `scapArgs = "-u"` and `private bool scapIncludeF;` (no initializer).
  </verify>
  <done>
MainViewModel.scapArgs defaults to "-u". MainViewModel.scapIncludeF defaults to false (no initializer). VerifyScannerMode enum and property exist. MainViewModel.Dashboard.cs contains -f conditional guard with exact expected string literals. VerifyView.xaml has Verify and Settings tabs with correct control placement. All VerifyViewLayoutContractTests and ScapArgsOptionsContractTests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for entire solution.
2. VerificationWorkflowServiceTests pass — orchestrator wiring works.
3. VerifyReportWriterTests pass — no regressions in CSV/JSON output.
4. VerifyViewLayoutContractTests pass — all 3 tab layout assertions satisfied.
5. ScapArgsOptionsContractTests pass — both safe default and -f guard assertions satisfied.
6. CklParser contains DtdProcessing.Prohibit — grep confirms.
7. VerificationWorkflowService contains "SCAP argument '-f' was missing a filename; removed invalid switch." — grep confirms.
</verification>

<success_criteria>
- VerifyOrchestrator.ParseAndMergeResults is called from VerificationWorkflowService (not BuildFromCkls alone).
- Both .ckl and .xml files are discovered from OutputRoot with SearchOption.AllDirectories.
- NormalizedVerifyResult -> ControlResult bridge maps VerifyStatus.Pass to "NotAFinding", VerifyStatus.Fail to "Open", etc.
- CklParser uses LoadSecureXml with DtdProcessing.Prohibit, XmlResolver = null.
- MainViewModel defaults: scapArgs = "-u", scapIncludeF has no initializer.
- VerifyView has TabItem Verify and TabItem Settings with correct control distribution.
- All targeted tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/14-scc-verify-correctness-and-model-unification/14-02-SUMMARY.md`
</output>
